<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Statistical Analysis and Research Consulting (SARC)</title>
<!-- Chart.js CDN for dynamic charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    color: #555;
<style>
  /* Reset CSS */
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  /* Base Body Layout - Mobile First */
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    min-height: 100vh; /* Use min-height for content flexibility */
    display: grid;
    /* Default for mobile, will be overridden by media queries and JS for desktop */
    grid-template-columns: 1fr;
    grid-template-rows: auto auto 1fr auto; /* Dynamic rows */
    grid-template-areas:
      "profile"
      "header"
      "page"
      "footer";
    font-size: 16px; /* Base font size for rem units */
    --sidebar-width: 250px; /* Default sidebar width for larger screens, adjusted for better initial fit */
  }

  /* Profile Section */
  .profile {
    grid-area: profile;
    background: linear-gradient(135deg, #4a90e2, #7bb3f0);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 1rem; /* Use rem for padding */
    position: relative;
  }

  .author-photo {
    width: 5rem; /* 80px / 16px = 5rem */
    height: 5rem;
    background-color: #1a1a1a;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
    font-size: 0.75rem; /* 12px */
    font-weight: bold;
    text-align: center;
    line-height: 1.2;
    border: 0.1875rem solid white; /* 3px */
    box-shadow: 0 0.25rem 0.75rem rgba(0,0,0,0.2); /* 0 4px 12px */
    overflow: hidden;
  }

  .author-photo img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .profile-upload-btn {
    margin-top: 0.625rem; /* 10px */
    padding: 0.3125rem 0.625rem; /* 5px 10px */
    background-color: #28a745;
    color: white;
    border: none;
    border-radius: 0.3125rem; /* 5px */
    cursor: pointer;
    font-size: 0.75rem; /* 12px */
    display: none;
  }

  body.admin-active .profile-upload-btn {
    display: block;
  }

  /* Header */
  .header {
    grid-area: header;
    background: linear-gradient(135deg, #00bcd4, #26c6da);
    color: #004d5c;
    padding: 1.25rem; /* 20px */
    display: flex;
    flex-direction: column;
    justify-content: center;
    position: relative;
  }

  .header h1 {
    font-size: 1.5rem; /* 24px */
    font-weight: 800;
    margin-bottom: 0.5rem; /* 8px */
    text-shadow: none;
    outline: none;
  }

  .header p {
    font-size: 0.875rem; /* 14px */
    font-weight: 500;
    opacity: 0.9;
    text-shadow: none;
    outline: none;
  }

  /* Materials Sidebar */
  .materials {
    grid-area: materials;
    background: linear-gradient(180deg, #e3f2fd, #bbdefb);
    border-right: 0.1875rem solid #2196f3; /* 3px */
    padding: 1.25rem; /* 20px */
    overflow-y: auto; /* Enable vertical scrolling */
    max-height: 100vh; /* Full height on mobile */
    font-size: 0.875rem; /* 14px */
    line-height: 1.5;
    display: none; /* Hidden by default on mobile */
    position: fixed; /* Make it fixed for mobile toggle */
    top: 0;
    left: -100%; /* Hide off-screen */
    width: 80%; /* Take up 80% of screen width */
    max-width: 500px; /* Max width for larger phones, adjusted */
    height: 100%;
    z-index: 1000;
    transition: left 0.3s ease-in-out;
    box-shadow: 0.25rem 0 1rem rgba(0,0,0,0.2);
  }

  .materials.open {
    left: 0; /* Show on screen */
    display: block; /* Ensure it's displayed when open */
  }

  .materials-title {
    background: linear-gradient(135deg, #2196f3, #42a5f5);;
    padding: 0.75rem; /* 12px */
    font-weight: bold;
    font-size: 1rem; /* 16px */
    color: white;
    text-align: center;
    border-radius: 0.5rem; /* 8px */
    margin-bottom: 1rem; /* 16px */
    box-shadow: 0 0.125rem 0.5rem rgba(0,0,0,0.1); /* 0 2px 8px */
  }

  .material-item {
    margin-bottom: 0.75rem; /* 12px */
    padding: 0.75rem; /* 12px */
    background: rgba(255,255,255,0.7);
    border-radius: 0.375rem; /* 6px */
    cursor: pointer;
    transition: all 0.3s ease;
    border-left: 0.25rem solid transparent; /* 4px */
    position: relative;
  }

  .material-item:hover {
    background: rgba(255,255,255,0.9);
    border-left-color: #2196f3;
    transform: translateX(0.25rem); /* 4px */
    box-shadow: 0 0.25rem 0.75rem rgba(0,0,0,0.1); /* 0 4px 12px */
  }

  .material-item.active {
    background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
    border-left-color: #4caf50;
    font-weight: bold;
  }

  .material-subtitle {
    margin-left: 1rem; /* 16px */
    margin-top: 0.5rem; /* 8px */
    font-size: 0.8125rem; /* 13px */
    font-style: italic;
  }

  /* Page Content */
  .page {
    grid-area: page;
    background: linear-gradient(135deg, #fafafa, #f5f5f5);
    padding: 1.25rem; /* 20px */
    overflow-y: auto;
    position: relative;
    min-height: 30rem; /* 480px */
  }

 .page-content {
    background: white;
    border-radius: 0.75rem; /* 12px */
    padding: 1.25rem; /* 20px */
    box-shadow: 0 0.5rem 1.5rem rgba(0,0,0,0.1); /* 0 8px 24px */
    min-height: 25rem; /* 400px */
    width: 95% !important;
	max-width: 100%; /* Ensure it doesn't overflow on small screens */
	max-width: none !important;  /* Izinkan ekspansi penuh, override max-width: 100% jika parent membatasi */
    margin: 0 auto; /* Center content */
  }

  .page-content h2 {
    color: #1976d2;
    font-size: 1.25rem; /* 20px */
    margin-bottom: 1rem; /* 16px */
    border-bottom: 0.1875rem solid #e3f2fd; /* 3px */
    padding-bottom: 0.625rem; /* 10px */
  }

  .page-content h3 {
    color: #388e3c;
    font-size: 1.125rem; /* 18px */
    margin: 1.25rem 0 0.75rem 0; /* 20px 0 12px 0 */
  }

  .page-content p {
    color: #424242;
    line-height: 1.6;
    text-align: justify;
    margin-bottom: 1rem; /* 16px */
  }

  .page-content ul {
    margin-left: 1.25rem; /* 20px */
    margin-bottom: 1rem; /* 16px */
  }

  .page-content li {
    margin-bottom: 0.5rem; /* 8px */
    color: #555;
  }

  .references {
    background: #f8f9fa;
    border-left: 0.25rem solid #2196f3; /* 4px */
    padding: 1rem; /* 16px */
    margin-top: 1.875rem; /* 30px */
    border-radius: 0 0.5rem 0.5rem 0; /* 0 8px 8px 0 */
  }

  .references h4 {
    color: #1976d2;
    margin-bottom: 0.75rem; /* 12px */
  }

  .references ol {
    margin-left: 1.25rem; /* 20px */
    font-size: 0.8125rem; /* 13px */
    color: #666;
  }

  /* Footer */
  .footer {
    grid-area: footer;
    background: linear-gradient(135deg, #1976d2, #2196f3);
    color: white;
    padding: 1.25rem; /* 20px */
    display: flex;
    flex-direction: column; /* Stack vertically on mobile */
    justify-content: center;
    align-items: center;
    font-size: 0.875rem; /* 14px */
    gap: 0.5rem; /* Gap between items */
  }

  .footer-left {
    display: flex;
    flex-direction: column; /* Stack vertically on mobile */
    gap: 0.5rem; /* 8px */
    margin-bottom: 0.5rem;
  }

  .footer-item {
    display: flex;
    align-items: center;
    gap: 0.5rem; /* 8px */
  }

  .footer-item strong {
    font-weight: 600;
  }

  .footer-item span {
    text-shadow: none;
    outline: none;
  }

  /* Help & FAQ Button */
  .help-faq-btn {
    position: fixed;
    bottom: 1.25rem; /* 20px */
    right: 1.25rem; /* 20px */
    background: linear-gradient(135deg, #3f51b5, #5c6bc0);
    color: white;
    width: 3rem; /* 48px */
    height: 3rem; /* 48px */
    border-radius: 50%;
    border: none;
    cursor: pointer;
    font-size: 1.25rem; /* 20px */
    font-weight: bold;
    text-align: center;
    box-shadow: 0 0.375rem 1.25rem rgba(63,81,181,0.4); /* 0 6px 20px */
    transition: all 0.3s ease;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .help-faq-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 0.5rem 1.5625rem rgba(63,81,181,0.6); /* 0 8px 25px */
  }

  .help-faq-btn svg {
    fill: white;
    width: 1.5rem; /* 24px */
    height: 1.5rem; /* 24px */
  }

  /* Analysis Tools Section */
  .analysis-tools {
    background: #e8f5e8;
    border: 0.125rem solid #4caf50; /* 2px */
    border-radius: 0.5rem; /* 8px */
    padding: 1.25rem; /* 20px */
    margin-top: 1.25rem; /* 20px */
  }

  .analysis-tools h3 {
    color: #2e7d32;
    margin-bottom: 1rem; /* 16px */
    text-align: center;
  }

  .tools-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(7.5rem, 1fr)); /* 120px */
    gap: 0.75rem; /* 12px */
  }

  .tool-btn {
    background: linear-gradient(135deg, #66bb6a, #81c784);
    color: white;
    border: none;
    padding: 0.75rem 0.5rem; /* 12px 8px */
    border-radius: 0.375rem; /* 6px */
    cursor: pointer;
    font-size: 0.75rem; /* 12px */
    font-weight: bold;
    transition: all 0.3s ease;
    text-align: center;
  }

  .tool-btn:hover {
    background: linear-gradient(135deg, #4caf50, #66bb6a);
    transform: translateY(-0.125rem); /* -2px */
    box-shadow: 0 0.25rem 0.75rem rgba(76,175,80,0.3); /* 0 4px 12px */
  }

  /* Form styling for analysis tools */
  .analysis-form {
    background: #fff;
    border-radius: 0.5rem; /* 8px */
    padding: 1.25rem; /* 20px */
    box-shadow: 0 0.25rem 0.75rem rgba(0,0,0,0.1); /* 0 4px 12px */
    margin-top: 1.25rem; /* 20px */
  }

  .form-group {
    margin-bottom: 1rem; /* 16px */
  }

  .form-group label {
    display: block;
    margin-bottom: 0.5rem; /* 8px */
    font-weight: bold;
    color: #333;
  }

  .form-group input[type="text"],
  .form-group input[type="number"],
  .form-group input[type="file"],
  .form-group select,
  .form-group textarea {
    width: 100%;
    padding: 0.625rem; /* 10px */
    border: 0.125rem solid #e0e0e0; /* 2px */
    border-radius: 0.25rem; /* 4px */
    font-size: 0.875rem; /* 14px */
    transition: border-color 0.3s ease;
  }

  .form-group input[type="file"] {
    padding: 0.3125rem; /* 5px */
  }

  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: #2196f3;
  }

  .btn-primary {
    background: linear-gradient(135deg, #2196f3, #42a5f5);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem; /* 12px 24px */
    border-radius: 0.375rem; /* 6px */
    cursor: pointer;
    font-size: 0.875rem; /* 14px */
    font-weight: bold;
    transition: all 0.3s ease;
  }

  .btn-primary:hover {
    background: linear-gradient(135deg, #1976d2, #2196f3);
    transform: translateY(-0.125rem); /* -2px */
    box-shadow: 0 0.25rem 0.75rem rgba(33,150,243,0.3); /* 0 4px 12px */
  }

  /* Admin Mode Toggle Button */
  .admin-mode-toggle {
    position: absolute; /* Changed to absolute */
    bottom: 0.5rem; /* 8px */
    right: 0.5rem; /* 8px */
    background: linear-gradient(135deg, #a7d9f7, #c2e0f2); /* Softer blue */
    color: #333; /* Darker text for contrast */
    padding: 0.2rem 0.5rem; /* Smaller padding */
    border-radius: 0.2rem; /* Smaller border-radius */
    cursor: pointer;
    font-weight: bold;
    z-index: 1001;
    display: flex;
    align-items: center;
    gap: 0.2rem; /* Smaller gap */
    transition: all 0.3s ease;
    font-size: 0.65rem; /* Smaller font size */
    border: 1px solid rgba(0,0,0,0.1); /* Subtle border */
    box-shadow: 0 0.1rem 0.2rem rgba(0,0,0,0.1); /* Softer shadow */
  }

  .admin-mode-toggle:hover {
    transform: translateY(-0.0625rem); /* -1px */
    box-shadow: 0 0.1875rem 0.375rem rgba(0,0,0,0.15); /* Slightly more pronounced shadow */
    background: linear-gradient(135deg, #c2e0f2, #a7d9f7); /* Invert gradient on hover */
  }

  .admin-mode-toggle.active {
    background: linear-gradient(135deg, #f44336, #ef5350);
    color: white;
  }
  .admin-mode-toggle.active:hover {
    background: linear-gradient(135deg, #d32f2f, #f44336);
  }

  /* Admin Login Section */
  .admin-login-section {
    position: absolute; /* Changed to absolute */
    bottom: 2.5rem; /* Adjusted position */
    right: 0.5rem; /* 8px */
    background-color: #f0f0f0;
    padding: 0.5rem; /* Smaller padding */
    border-radius: 0.25rem; /* Smaller border-radius */
    box-shadow: 0 0.1rem 0.25rem rgba(0,0,0,0.2); /* Smaller shadow */
    z-index: 1002; /* Increased z-index */
    display: none;
    flex-direction: column;
    gap: 0.5rem; /* Smaller gap */
    width: calc(100% - 2rem); /* Full width minus padding */
    max-width: 15rem; /* Smaller max-width */
  }

  body.admin-active .admin-login-section {
    display: flex;
  }

  .admin-login-section .form-group {
    margin-bottom: 0;
  }

  .admin-login-section label {
    margin-right: 0.25rem; /* Smaller margin */
    font-weight: bold;
    display: block;
    margin-bottom: 0.25rem; /* Smaller margin */
    font-size: 0.75rem; /* Smaller font size */
  }

  .admin-login-section input[type="password"] {
    padding: 0.4rem; /* Smaller padding */
    border: 0.0625rem solid #ccc; /* 1px */
    border-radius: 0.15rem; /* Smaller border-radius */
    width: calc(100% - 0.4rem); /* Adjust for padding */
    margin-bottom: 0.25rem; /* Smaller margin */
    font-size: 0.75rem; /* Smaller font size */
  }

  .admin-login-section button {
    padding: 0.4rem 0.6rem; /* Smaller padding */
    border: none;
    border-radius: 0.15rem; /* Smaller border-radius */
    background-color: #2196f3;
    color: white;
    cursor: pointer;
    width: 100%;
    font-size: 0.75rem; /* Smaller font size */
  }

  .admin-login-section button:hover {
    background-color: #1976d2;
  }

  .editable-content {
    border: none;
    padding: 0;
    min-height: auto;
  }

  /* Styles for editable content when admin mode is active */
  body.admin-active .editable-content {
    border: 0.0625rem dashed #ff9800; /* 1px */
    padding: 0.3125rem; /* 5px */
    min-height: 1.5em;
  }

  .editable-content:hover {
    background-color: #f0f0f0;
  }

  .admin-controls {
    margin-top: 1.25rem; /* 20px */
    padding: 0.9375rem; /* 15px */
    background-color: #fff3e0;
    border-left: 0.3125rem solid #ff9800; /* 5px */
    display: none;
  }

  body.admin-active .admin-controls {
    display: block;
  }

  .admin-controls button {
    margin-right: 0.625rem; /* 10px */
    padding: 0.5rem 0.9375rem; /* 8px 15px */
    border: none;
    border-radius: 0.25rem; /* 4px */
    cursor: pointer;
    font-weight: bold;
  }

  .admin-controls .save-btn {
    background-color: #4CAF50;
    color: white;
  }

  .admin-controls .cancel-btn {
    background-color: #f44336;
    color: white;
  }

  .admin-controls .add-material-btn {
    background-color: #2196f3;
    color: white;
  }

  .material-item .edit-btn, .material-item .delete-btn {
    position: absolute;
    top: 0.3125rem; /* 5px */
    right: 0.3125rem; /* 5px */
    background-color: #2196f3;
    color: white;
    border: none;
    border-radius: 0.1875rem; /* 3px */
    padding: 0.1875rem 0.375rem; /* 3px 6px */
    font-size: 0.625rem; /* 10px */
    cursor: pointer;
    display: none;
    margin-left: 0.3125rem; /* 5px */
  }

  .material-item .delete-btn {
    right: 2.8125rem; /* 45px */
    background-color: #f44336;
  }

  body.admin-active .material-item .edit-btn,
  body.admin-active .material-item .delete-btn {
    display: block;
  }

  /* Help/FAQ Modal */
  .help-faq-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1002;
    visibility: hidden;
    opacity: 0;
    transition: visibility 0s, opacity 0.3s ease;
  }

  .help-faq-modal.open {
    visibility: visible;
    opacity: 1;
  }

  .help-faq-content {
    background: #fff;
    border-radius: 0.625rem; /* 10px */
    box-shadow: 0 0.5rem 1.5rem rgba(0,0,0,0.3); /* 0 8px 24px */
    width: 90%;
    max-width: 37.5rem; /* 600px */
    max-height: 90%;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .help-faq-header {
    background: linear-gradient(135deg, #3f51b5, #5c6bc0);
    color: white;
    padding: 0.9375rem 1.25rem; /* 15px 20px */
    border-top-left-radius: 0.625rem; /* 10px */
    border-top-right-radius: 0.625rem; /* 10px */
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
    font-size: 1.2em;
  }

  .help-faq-header .close-btn {
    background: none;
    border: none;
    color: white;
    font-size: 1.5em;
    cursor: pointer;
    line-height: 1;
  }

  .help-faq-body {
    flex-grow: 1;
    padding: 1.25rem; /* 20px */
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }

  /* Chatbot Styles within Modal */
  .chatbot-container-modal {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    border: 0.0625rem solid #eee; /* 1px */
    border-radius: 0.5rem; /* 8px */
    overflow: hidden;
    margin-top: 0.9375rem; /* 15px */
  }

  .chatbot-header {
    background-color: #f0f0f0;
    padding: 0.625rem; /* 10px */
    font-weight: bold;
    border-bottom: 0.0625rem solid #eee; /* 1px */
  }

  .chatbot-messages {
    flex-grow: 1;
    padding: 0.625rem; /* 10px */
    overflow-y: auto;
    background-color: #e3f2fd;
    display: flex;
    flex-direction: column;
  }

  .chatbot-message {
    margin-bottom: 0.625rem; /* 10px */
    padding: 0.5rem 0.75rem; /* 8px 12px */
    border-radius: 0.9375rem; /* 15px */
    max-width: 80%;
    word-wrap: break-word;
  }

  .chatbot-message.user {
    background-color: #dcf8c6;
    align-self: flex-end;
    margin-left: auto;
  }

  .chatbot-message.bot {
    background-color: #f1f0f0;
    align-self: flex-start;
    margin-right: auto;
  }

  .chatbot-input {
    display: flex;
    padding: 0.625rem; /* 10px */
    border-top: 0.0625rem solid #eee; /* 1px */
    background-color: #f9f9f9;
  }

  .chatbot-input input {
    flex-grow: 1;
    border: 0.0625rem solid #ccc; /* 1px */
    border-radius: 1.25rem; /* 20px */
    padding: 0.5rem 0.75rem; /* 8px 12px */
    margin-right: 0.625rem; /* 10px */
  }

  .chatbot-input button {
    background: #5c6bc0;
    color: white;
    border: none;
    border-radius: 1.25rem; /* 20px */
    padding: 0.5rem 0.9375rem; /* 8px 15px */
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  .chatbot-input button:hover {
    background-color: #3f51b5;
  }

  /* Resizer for sidebar */
  .resizer {
    width: 0.5rem; /* 8px */
    background: #ccc;
    cursor: ew-resize;
    grid-area: resizer;
    z-index: 100;
    display: none; /* Hidden by default, shown on larger screens */
  }

  .resizer:hover {
    background: #2196f3;
  }

  /* Mobile Sidebar Toggle Button */
  .sidebar-toggle-btn {
    position: fixed;
    top: 1rem;
    left: 1rem;
    background: linear-gradient(135deg, #00bcd4, #26c6da);
    color: white;
    padding: 0.5rem 0.75rem;
    border-radius: 0.375rem;
    border: none;
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: bold;
    z-index: 1001;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    box-shadow: 0 0.25rem 0.75rem rgba(0,0,0,0.2);
  }

  /* Perbaikan Chart Container untuk Responsif Mobile */
  .chart-container {
    position: relative;
    margin: 1.5rem auto;
    width: 80%; /* Adjust as needed */
    max-width: 600px; /* Max width for charts */
    height: auto;  /* PERBAIKAN: Ubah dari fixed 400px ke auto untuk fleksibilitas */
    min-height: 300px;  /* PERBAIKAN: Min-height agar tidak terlalu kecil */
    aspect-ratio: 16 / 9;  /* PERBAIKAN: Proporsi otomatis, hindari distorsi di mobile */
    background-color: #f9f9f9;
    border-radius: 0.5rem;
    padding: 1rem;
    box-shadow: 0 0.125rem 0.5rem rgba(0,0,0,0.1);
	
	/* Pastikan canvas di dalam chart-container responsive */
    .chart-container canvas {
      max-height: 100% !important;  /* PERBAIKAN: Paksa canvas isi container */
      width: 100% !important;
    }
  }

  /* --- Media Queries for Responsiveness --- */

  /* Small Phones (up to 480px) */
  @media (max-width: 480px) {
    body {
      font-size: 14px; /* Smaller base font for very small screens */
    }

    .header h1 {
      font-size: 1.25rem; /* 20px */
	  text-align: center
	  
    }

    .header p {
      font-size: 0.8rem; /* 12.8px */
	  text-align: center
    }

    .profile {
      padding: 0.75rem;
    }

    .author-photo {
      width: 4rem;
      height: 4rem;
      font-size: 0.65rem;
    }

    .profile-upload-btn {
      font-size: 0.65rem;
      padding: 0.25rem 0.5rem;
    }

    .materials {
      width: 90%; /* Wider sidebar on very small screens */
      max-width: 280px;
      padding: 1rem;
    }

    .materials-title {
      font-size: 0.9rem;
      padding: 0.6rem;
    }

    .material-item {
      padding: 0.6rem;
      font-size: 0.8rem;
    }

    .material-subtitle {
      font-size: 0.7rem;
      margin-left: 0.75rem;
    }

    .page {
      padding: 1rem;
    }

    .page-content {
      padding: 1rem;
      border-radius: 0.5rem;
    }

    .page-content h2 {
      font-size: 1.1rem;
    }

    .page-content h3 {
      font-size: 1rem;
    }

    .footer {
      padding: 1rem;
      font-size: 0.75rem;
      text-align: center; /* Center text horizontally */
    }

    .footer-left {
      margin-bottom: 0.25rem;
      align-items: center; /* Center items in column layout */
    }

    .footer-item {
      gap: 0.25rem;
    }

    .help-faq-btn {
      bottom: 1rem;
      right: 1rem;
      width: 2.5rem;
      height: 2.5rem;
      font-size: 0.8rem;
    }

    .help-faq-btn svg {
      width: 1.2rem;
      height: 1.2rem;
    }

    .help-faq-content {
      width: 95%
	  font-size: 10px
	  line-height: 1.2
      max-width: 300px;
    }

    .chatbot-input input {
      padding: 0.4rem 0.6rem;
      font-size: 0.75rem;
    }

    .chatbot-input button {
      padding: 0.4rem 0.7rem;
      font-size: 0.75rem;
    }

    .admin-mode-toggle {
      bottom: 0.3rem;
      right: 0.3rem;
      font-size: 0.6rem;
      padding: 0.15rem 0.4rem;
    }

    .admin-login-section {
      bottom: 2rem;
      right: 0.3rem;
      max-width: 12rem;
      padding: 0.4rem;
    }

    .admin-login-section label,
    .admin-login-section input[type="password"],
    .admin-login-section button {
      font-size: 0.7rem;
      padding: 0.3rem;
    }

    .chart-container {
      width: 95%;
      height: 300px;
    }
  }

  /* Medium Phones to Small Tablets (481px - 768px) */
  @media (min-width: 481px) and (max-width: 768px) {
    body {
      grid-template-columns: 1fr;
      grid-template-rows: auto auto 1fr auto;
      grid-template-areas:
        "profile"
        "header"
        "page"
        "footer";
      font-size: 15px; /* Slightly larger base font */
    }

    .sidebar-toggle-btn {
      display: flex; /* Show toggle button on mobile */
    }

    .materials {
      display: block; /* Show sidebar as fixed overlay */
      max-height: 100vh;
      width: 70%; /* Adjusted width */
      max-width: 350px; /* Adjusted max-width */
    }
    .resizer {
      display: none; /* Hide resizer on mobile */
    }

    .header h1 {
      font-size: 1.75rem; /* 28px */
	  text-align: center
    }

    .header p {
      font-size: 1rem; /* 16px */
	  text-align: center
    }

    .page-content {
      padding: 1.5rem; /* 24px */
    }

    .footer {
      flex-direction: row; /* Back to row for slightly larger screens */
      justify-content: space-between;
      padding: 1rem 1.5rem;
      font-size: 0.875rem;
      text-align: center; /* Center text horizontally */
    }

    .footer-left {
      flex-direction: row;
      gap: 1rem;
      margin-bottom: 0;
      align-items: center; /* Center items in row layout */
    }

    .help-faq-btn {
      bottom: 1.875rem; /* 30px */
      right: 1.875rem; /* 30px */
      width: 3.5rem; /* 56px */
      height: 3.5rem; /* 56px */
      font-size: 1.25rem; /* 24px */
    }

    .help-faq-btn svg {
      width: 1.5rem;
      height: 1.5rem;
    }

    .help-faq-content {
	  font-size: 12px
	  line-height: 1.3
      max-width: 30rem; /* 480px */
    }

    /* Admin toggle and login section adjustments */
    .admin-mode-toggle {
      bottom: 0.5rem;
      right: 0.5rem;
    }
    .admin-login-section {
      bottom: 2.5rem;
      right: 0.5rem;
      max-width: 15rem;
    }

    .chart-container {
      width: 90%;
      height: 350px;
    }
  }

  /* Tablets to Laptops (769px - 1024px) */
  @media (min-width: 769px) and (max-width: 1024px) {
    body {
      grid-template-columns: var(--sidebar-width) 0.5rem 1fr; /* Sidebar, resizer, page */
      grid-template-rows: 7.5rem 1fr 3.75rem; /* 120px 1fr 60px */
      grid-template-areas:
        "profile header header"
        "materials resizer page"
        "footer footer footer";
      font-size: 16px; /* Base font size */
    }

    .sidebar-toggle-btn {
      display: none; /* Hide toggle button on larger screens */
    }

    .materials {
      display: block; /* Show sidebar */
      position: relative; /* Not fixed anymore */
      left: 0; /* Reset left position */
      width: auto; /* Reset width */
      height: auto; /* Reset height */
      max-height: calc(100vh - 7.5rem - 3.75rem); /* Adjust max-height based on header/footer */
      box-shadow: none; /* Remove shadow */
      border-right: none; /* Resizer acts as border */
      padding: 1rem;
      overflow-x: hidden; /* Prevent horizontal scrolling for sidebar content */
      white-space: normal; /* Allow wrapping of content */
    }

    .resizer {
      display: block; /* Show resizer */
    }

    .profile {
      padding: 1rem;
    }

    .author-photo {
      width: 4rem; /* 64px */
      height: 4rem;
    }

    .header {
      padding: 1.5rem; /* 24px */
    }

    .header h1 {
      font-size: 1.75rem; /* 28px */
    }

    .header p {
      font-size: 1rem; /* 16px */
    }

    .page {
      padding: 1.5rem; /* 24px */
    }

    .page-content {
      padding: 1.5rem; /* 24px */
    }

    .footer {
      flex-direction: row;
      justify-content: space-between;
      padding: 1rem 1.5rem;
      font-size: 0.875rem;
    }

    .footer-left {
      flex-direction: row;
      gap: 1.5rem; /* 24px */
      margin-bottom: 0;
    }

    .admin-mode-toggle {
      bottom: 0.5rem;
      right: 0.5rem;
    }

    .admin-login-section {
      bottom: 2.5rem;
      right: 0.5rem;
      max-width: 15rem;
    }

    .help-faq-btn {
      bottom: 1.875rem; /* 30px */
      right: 1.875rem; /* 30px */
      width: 3.5rem; /* 56px */
      height: 3.5rem; /* 56px */
      font-size: 1.5rem; /* 24px */
    }

    .help-faq-btn svg {
      width: 1.5rem;
      height: 1.5rem;
    }

    .help-faq-content {
      max-width: 37.5rem; /* 600px */
    }

    .chart-container {
      width: 85%;
      height: 380px;
    }
  }

  /* Large Laptops and Desktops (1025px and up) */
  @media (min-width: 1025px) {
    body {
      grid-template-columns: var(--sidebar-width) 0.5rem 1fr; /* Sidebar, resizer, page */
      grid-template-rows: 7.5rem 1fr 3.75rem; /* 120px 1fr 60px */
      grid-template-areas:
        "profile header header"
        "materials resizer page"
        "footer footer footer";
      font-size: 16px;
    }

    .sidebar-toggle-btn {
      display: none; /* Hide toggle button on larger screens */
    }

    .materials {
      display: block; /* Always show sidebar on large screens */
      position: relative; /* Not fixed anymore */
      left: 0; /* Reset left position */
      width: auto; /* Reset width */
      height: auto; /* Reset height */
      max-height: calc(100vh - 7.5rem - 3.75rem); /* Adjust max-height based on header/footer */
      box-shadow: none; /* Remove shadow */
      overflow-x: hidden; /* Prevent horizontal scrolling for sidebar content */
      white-space: normal; /* Allow wrapping of content */
      border-right: none; /* Resizer acts as border */
    }

    .resizer {
      display: block; /* Show resizer */
    }

    .header h1 {
      font-size: 1.75rem; /* 28px */
    }

    .header p {
      font-size: 1rem; /* 16px */
    }

    .page {
      padding: 1.875rem; /* 30px */
    }

    .page-content {
      padding: 1.875rem; /* 30px */
      max-width: 60rem; /* Limit content width on very large screens */
    }

    .footer {
      flex-direction: row;
      justify-content: space-between;
      padding: 1.25rem 1.875rem; /* 20px 30px */
      font-size: 0.875rem;
    }

    .footer-left {
      flex-direction: row;
      gap: 1.875rem; /* 30px */
      margin-bottom: 0;
    }

    .admin-mode-toggle {
      bottom: 0.5rem;
      right: 0.5rem;
    }

    .admin-login-section {
      bottom: 2.5rem;
      right: 0.5rem;
      max-width: 15rem;
    }

    .help-faq-btn {
      bottom: 5rem; /* 80px */
      right: 1.875rem; /* 30px */
      width: 3.125rem; /* 50px */
      height: 3.125rem; /* 50px */
      font-size: 1.5rem; /* 24px */
    }

    .help-faq-btn svg {
      width: 1.5rem;
      height: 1.5rem;
    }

    .chart-container {
      width: 80%;
      height: 400px;
    }
  }
  
  /* KODE HOVER HEADER */
       .header h1:hover,
       .header p:hover {
         background-color: rgba(255, 255, 255, 0.2);
         color: #004d5c;
         padding: 4px 8px;
         border-radius: 4px;
         transition: all 0.3s ease;
         cursor: pointer;
       }
       .header .editable-content:hover {
         background-color: rgba(255, 255, 255, 0.2);
         color: #004d5c;
         padding: 4px 8px;
         border-radius: 4px;
         transition: all 0.3s ease;
         cursor: pointer;
       }
       .header:hover {
         background: linear-gradient(135deg, #00bcd4, #26c6da);
         transition: background 0.3s ease;
       }
  
  /* KODE HOVER FOOTER */
       .footer-item span:hover {
         background-color: rgba(255, 255, 255, 0.2);
         color: #FFFFFF;
         padding: 4px 8px;
         border-radius: 4px;
         transition: all 0.3s ease;
         cursor: pointer;
       }
       .footer .editable-content:hover {
         background-color: rgba(255, 255, 255, 0.2);
         color: #FFFFFF;
         padding: 4px 8px;
         border-radius: 4px;
         transition: all 0.3s ease;
         cursor: pointer;
       }
       .footer-item:hover {
         background-color: rgba(0, 0, 0, 0.1);
         border-radius: 6px;
         padding: 2px;
         transition: background-color 0.3s ease;
       }


/* Styling untuk Tabel Analisis Deskriptif */
.table-container {
  overflow-x: auto; /* Scroll horizontal pada mobile jika tabel lebar */
  margin: 15px 0;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* Shadow ringan untuk depth */
}

.descriptive-table {
  width: 100%;
  border-collapse: collapse;
  background: white;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  font-size: 14px;
}

.descriptive-table th,
.descriptive-table td {
  padding: 12px 15px; /* Padding rapi */
  text-align: left;
  border-bottom: 1px solid #ddd; /* Garis pemisah halus */
}

.descriptive-table th {
  background-color: #2196f3; /* Warna header biru (sesuaikan tema) */
  color: white;
  font-weight: bold;
  text-align: center;
}

.descriptive-table tbody tr:nth-child(even) {
  background-color: #f9f9f9; /* Striped rows untuk readability */
}

.descriptive-table tbody tr:hover {
  background-color: #e3f2fd; /* Hover effect untuk interaktivitas */
}

.descriptive-table tfoot {
  font-weight: bold;
  background-color: #f5f5f5;
}

/* Responsif: Pada mobile, kurangi padding dan font */
@media (max-width: 480px) {
  .descriptive-table th,
  .descriptive-table td {
    padding: 8px 10px;
    font-size: 12px;
  }
  
  .table-container {
    margin: 10px 0;
  }
  .chart-container {
    width: 95%;
    min-height: 250px;  /* PERBAIKAN: Kurangi min-height di HP kecil */
    aspect-ratio: 4 / 3;  /* PERBAIKAN: Proporsi lebih vertikal untuk mobile */
    padding: 0.5rem;  /* PERBAIKAN: Kurangi padding internal */
  }
}

/* Interpretasi Box (jika digunakan) */
.interpretation {
  font-size: 14px;
  line-height: 1.5;
}

.interpretation ul {
  margin: 5px 0;
  padding-left: 20px;
}

.interpretation li {
  margin-bottom: 5px;
}

/* Revisi: Style untuk pemisahan section di sidebar */
.materials-section,
.tools-section {
  margin-bottom: 1.5rem; /* Spacing antar section */
  padding-bottom: 1rem;
  border-bottom: 0.125rem solid #ddd; /* Garis pemisah halus */
}

.materials-section .materials-title {
  background: linear-gradient(135deg, #8bc34a, #9ccc65); /* Hijau untuk Materials */
  color: #2e7d32;
}

.tools-section .tools-title {
  background: linear-gradient(135deg, #2196f3, #42a5f5); /* Biru untuk Tools */
  color: white;
  padding: 0.75rem;
  font-weight: bold;
  font-size: 1rem;
  text-align: center;
  border-radius: 0.5rem;
  margin-bottom: 1rem;
  box-shadow: 0 0.125rem 0.5rem rgba(0,0,0,0.1);
}

/* Whiteboard Specific Styles */
#whiteboard-toolbar .tool-btn {
  transition: background 0.3s ease;
}
#whiteboard-toolbar .tool-btn:hover,
#whiteboard-toolbar .tool-btn.active {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}
#whiteboard-toolbar .tool-btn.active {
  background: #333 !important;
}
#whiteboard-canvas {
  touch-action: none; /* Prevent default touch behaviors */
}
#text-cursor {
  pointer-events: none;
  min-width: 100px;
  min-height: 20px;
  z-index: 10;
}
@media (max-width: 768px) {
  #whiteboard-canvas {
    width: 100% !important;
    height: auto !important;
  }
  #whiteboard-toolbar {
    flex-direction: column;
    align-items: stretch;
  }
  #whiteboard-toolbar label {
    justify-content: space-between;
  }
}

/* Perbaikan Fullscreen: Toolbar tetap visible dan fixed di atas saat fullscreen */
#whiteboard-container:-webkit-full-screen #whiteboard-toolbar,
#whiteboard-container:-moz-full-screen #whiteboard-toolbar,
#whiteboard-container:fullscreen #whiteboard-toolbar {
  position: fixed !important;
  top: 10px !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  z-index: 1000 !important;
  width: 90% !important;
  max-width: 800px !important;
  background: rgba(245, 245, 245, 0.95) !important; /* Semi-transparent untuk tidak ganggu */
  backdrop-filter: blur(5px) !important; /* Blur background untuk modern look */
  border-radius: 8px !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
  padding: 8px !important; /* Kurangi padding di fullscreen */
}

#whiteboard-container:-webkit-full-screen #canvas-wrapper,
#whiteboard-container:-moz-full-screen #canvas-wrapper,
#whiteboard-container:fullscreen #canvas-wrapper {
  margin-top: 80px !important; /* Offset untuk toolbar fixed */
  border: none !important; /* Hilangkan border di fullscreen */
  border-radius: 0 !important;
  height: calc(100vh - 100px) !important; /* Full height minus toolbar dan margin */
  width: 100% !important;
}

#whiteboard-container:-webkit-full-screen canvas,
#whiteboard-container:-moz-full-screen canvas,
#whiteboard-container:fullscreen canvas {
  width: 100% !important;
  height: 100% !important;
  cursor: crosshair !important;
}

/* Mobile adjustments di fullscreen */
@media (max-width: 768px) {
  #whiteboard-container:-webkit-full-screen #whiteboard-toolbar,
  #whiteboard-container:-moz-full-screen #whiteboard-toolbar,
  #whiteboard-container:fullscreen #whiteboard-toolbar {
    flex-direction: column !important;
    width: 95% !important;
    gap: 5px !important;
  }
  
  #whiteboard-container:-webkit-full-screen #canvas-wrapper,
  #whiteboard-container:-moz-full-screen #canvas-wrapper,
  #whiteboard-container:fullscreen #canvas-wrapper {
    margin-top: 120px !important; /* Lebih besar di mobile */
  }
}

/* Tools section: Non-editable, no dashed border di admin mode */
body.admin-active .tools-section .material-item {
  border: none !important; /* Override dashed border */
}

body.admin-active .tools-section .material-item:hover {
  background: rgba(255,255,255,0.9); /* Tetap hover effect, tapi no edit visual */
}

/* Responsif: Section tetap stack di mobile */
@media (max-width: 768px) {
  .materials-section,
  .tools-section {
    border-bottom: 0.0625rem solid #ddd; /* Garis lebih tipis di mobile */
    margin-bottom: 1rem;
  }
}

/* PERBAIKAN Lanjutan: Style untuk Random Number Generator */
#random-numbers-list span {
  display: inline-block;
  margin: 2px;
}
#random-numbers-list p {
  margin: 5px 0;
}
#rng-stats {
  color: #28a745;
  font-size: 14px;
}
.btn-secondary {
  background: #6c757d;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
}
.btn-secondary:hover {
  background: #5a6268;
}
#rng-output {
  min-height: 200px;
}
 
    /* Tambahkan CSS accordion di akhir blok ini */
    details > summary {
      cursor: pointer;
      background: #f0f0f0;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 5px;
      font-weight: bold; /* Opsional: Untuk tampilan lebih menonjol */
      transition: background 0.3s ease; /* Animasi halus */
    }
    details[open] > summary {
      background: #e0e0e0;
    }
    /* Opsional: Styling tambahan untuk konten accordion */
    details > div {
      margin-left: 20px; /* Indent konten di dalam accordion */
      padding: 10px;
      border-left: 2px solid #2196f3; /* Garis pemisah */
    }

</style>
</head>
<body>

  <!-- Mobile Sidebar Toggle Button -->
  <button class="sidebar-toggle-btn" onclick="toggleSidebar()">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="white">
      <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
    </svg>
    Materi
  </button>

  <!-- Profile Section -->
  <div class="profile">
    <div class="author-photo" id="author-photo-container">
      <!-- Image will be loaded here -->
      <span id="author-photo-placeholder">Author<br/>Foto<br/>Profile</span>
    </div>
    <input type="file" id="profile-image-upload" accept="image/*" style="display: none;" onchange="handleProfileImageUpload(event)"/>
    <button class="profile-upload-btn" onclick="document.getElementById('profile-image-upload').click()">Upload Foto</button>

    <!-- Admin Mode Toggle Button - Moved inside profile section -->
    <button class="admin-mode-toggle" id="admin-mode-toggle-btn" onclick="toggleAdminMode()">
      Login
    </button>

    <!-- Admin Login/Logout Section - Moved inside profile section -->
    <div class="admin-login-section" id="admin-login-section">
      <div id="admin-login-form">
        <div class="form-group">
          <label for="admin-password">Password:</label>
          <input type="password" id="admin-password" placeholder="Masukkan password"/>
        </div>
        <button onclick="loginAdmin()">Login</button>
      </div>
      <div id="admin-logout-form" style="display: none;">
        <p>Mode Admin Aktif</p>
        <button onclick="logoutAdmin()">Logout</button>
      </div>
    </div>
  </div>

  <!-- Header -->
  <header class="header">
    <h1 class="editable-content" data-editable-id="header-title">Statistical Analysis and Research Consulting (SARC)</h1>
    <p class="editable-content" data-editable-id="header-subtitle">Platform komprehensif untuk belajar dan konsultasi analisis data statistik, research, instrumen penelitian, survei, dan data sains.</p>
  </header>

  <!-- Materials Sidebar -->
<nav class="materials" id="materials-sidebar">
  <!-- Section 1: Materials (Editable) -->
  <div class="materials-section">
    <div class="materials-title editable-content" data-editable-id="materials-sidebar-title">Materials</div>
    
    <!-- Items 1-7: Editable (dibangun dinamis via JS, tapi contoh statis di sini untuk demo) -->
    <div class="material-item" data-material-id="1" onclick="showMaterial(1)">
      <strong class="editable-content" data-editable-id="material-title-1">1. Pengantar Statistika</strong>
      <div class="material-subtitle editable-content" data-editable-id="material-subtitle-1">Sejarah, arti, peran, populasi, sampel, teknik sampling, parameter dan statistik</div>
      <button class="edit-btn" onclick="editMaterial(1, event)">Edit</button>
      <button class="delete-btn" onclick="deleteMaterial(1, event)">Hapus</button>
    </div>

    <div class="material-item" data-material-id="2" onclick="showMaterial(2)">
      <strong class="editable-content" data-editable-id="material-title-2">2. Statistika Deskriptif</strong>
      <div class="material-subtitle editable-content" data-editable-id="material-subtitle-2">Penyajian data, ukuran pemusatan, ukuran penyebaran</div>
      <button class="edit-btn" onclick="editMaterial(2, event)">Edit</button>
      <button class="delete-btn" onclick="deleteMaterial(2, event)">Hapus</button>
    </div>

    <div class="material-item" data-material-id="3" onclick="showMaterial(3)">
      <strong class="editable-content" data-editable-id="material-title-3">3. Statistika Inferensial</strong>
      <div class="material-subtitle editable-content" data-editable-id="material-subtitle-3">Distribusi peluang, uji hipotesis, parametrik, non-parametrik</div>
      <button class="edit-btn" onclick="editMaterial(3, event)">Edit</button>
      <button class="delete-btn" onclick="deleteMaterial(3, event)">Hapus</button>
    </div>

    <div class="material-item" data-material-id="4" onclick="showMaterial(4)">
      <strong class="editable-content" data-editable-id="material-title-4">4. Probabilitas dan Distribusi</strong>
      <div class="material-subtitle editable-content" data-editable-id="material-subtitle-4">Konsep dasar probabilitas, distribusi diskrit dan kontinu</div>
      <button class="edit-btn" onclick="editMaterial(4, event)">Edit</button>
      <button class="delete-btn" onclick="deleteMaterial(4, event)">Hapus</button>
    </div>

    <div class="material-item" data-material-id="5" onclick="showMaterial(5)">
      <strong class="editable-content" data-editable-id="material-title-5">5. Teori Statistika Lanjut</strong>
      <div class="material-subtitle editable-content" data-editable-id="material-subtitle-5">GLM, Non-Linear Model, Bayesian</div>
      <button class="edit-btn" onclick="editMaterial(5, event)">Edit</button>
      <button class="delete-btn" onclick="deleteMaterial(5, event)">Hapus</button>
    </div>

    <div class="material-item" data-material-id="6" onclick="showMaterial(6)">
      <strong class="editable-content" data-editable-id="material-title-6">6. Penerapan Statistika</strong>
      <div class="material-subtitle editable-content" data-editable-id="material-subtitle-6">Komputer, AI, sains data, big data</div>
      <button class="edit-btn" onclick="editMaterial(6, event)">Edit</button>
      <button class="delete-btn" onclick="deleteMaterial(6, event)">Hapus</button>
    </div>

    <div class="material-item" data-material-id="7" onclick="showMaterial(7)">
      <strong class="editable-content" data-editable-id="material-title-7">7. Materi Lainnya</strong>
      <div class="material-subtitle editable-content" data-editable-id="material-subtitle-7">Topik tambahan dan pengembangan</div>
      <button class="edit-btn" onclick="editMaterial(7, event)">Edit</button>
      <button class="delete-btn" onclick="deleteMaterial(7, event)">Hapus</button>
    </div>

    <!-- Admin Controls (Tetap di Materials section, editable) -->
    <div class="admin-controls">
      <button class="add-material-btn" onclick="addMaterial()">+ Tambah Materi</button>
    </div>
  </div>

<!-- Section 2: Tools (Statis, Non-Editable) -->
  <div class="tools-section">
    <div class="tools-title">Tools</div> <!-- Statis, no editable -->
    
    <!-- Item 8: Analysis (Statis, no editable-content atau tombol edit/hapus) -->
    <div class="material-item" data-material-id='analysis' onclick="showMaterial('analysis')">
      <strong>Analysis</strong> <!-- Hapus editable-content -->
      <div class="material-subtitle">Tools analisis data statistik interaktif</div> <!-- Hapus editable-content -->
      <!-- No edit/delete buttons -->
    </div>
	
	<!-- Item Baru: Whiteboard (di dalam tools-section, setelah Analysis) -->
    <div class="material-item" data-material-id='whiteboard' onclick="showMaterial('whiteboard')">
      <strong>Whiteboard</strong>
      <div class="material-subtitle">Tools untuk menggambar, menulis catatan, dan brainstorming</div>
      <!-- No edit/delete buttons karena tools statis -->
    </div>
  </div>
</nav>

  <!-- Resizer for sidebar -->
  <div class="resizer" id="resizer"></div>

  <!-- Main Content Page -->
  <main class="page">
    <div class="page-content" id="pageContent">
      <h2 class="editable-content" data-editable-id="welcome-title">Selamat Datang di Statistical Analysis and Research Consulting (SARC)</h2>
      <p class="editable-content" data-editable-id="welcome-text">Pilih materi dari menu di sebelah kiri untuk memulai pembelajaran atau akses tools analisis statistik.</p>
      
      <h3 class="editable-content" data-editable-id="about-platform-title">Tentang Platform Ini</h3>
      <p class="editable-content" data-editable-id="about-platform-text">Platform ini dirancang untuk membantu mahasiswa, peneliti, dan praktisi dalam memahami konsep statistika serta melakukan analisis data dengan mudah dan akurat.</p>
      
      <h3 class="editable-content" data-editable-id="main-features-title">Fitur Utama</h3>
      <ul class="editable-content" data-editable-id="main-features-list">
        <li>Materi pembelajaran statistika yang komprehensif</li>
        <li>Tools analisis data interaktif</li>
        <li>Contoh kasus dan studi aplikasi</li>
        <li>Referensi akademik yang valid</li>
      </ul>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-left">
      <div class="footer-item">
        <strong>📍</strong>
        <span class="editable-content" data-editable-id="footer-address">Jl. H.A.M. Rifaddin No. 279, Samarinda 75131</span>
      </div>
      <div class="footer-item">
        <strong>📞</strong>
        <span class="editable-content" data-editable-id="footer-phone">((0541) 7270222</span>
      </div>
      <div class="footer-item">
        <strong>✉️</strong>
        <span class="editable-content" data-editable-id="footer-email">konsultasi@statistika.ac.id</span>
      </div>
    </div>
    <div class="editable-content" data-editable-id="footer-copyright">© 2025 Statistical Analysis and Research Consulting (SARC)</div>
  </footer>

  <!-- Help & FAQ Button (Draggable) -->
  <button class="help-faq-btn" id="help-faq-btn" onclick="toggleHelpFAQModal()">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
      <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM7 9h2v2H7V9zm4 0h2v2h-2V9zm4 0h2v2h-2V9z"/>
    </svg>
  </button>

  <!-- Help & FAQ Modal (contains Chatbot) -->
  <div class="help-faq-modal" id="help-faq-modal">
    <div class="help-faq-content">
      <div class="help-faq-header">
        <span>Bantuan & ChatAI</span>
        <button class="close-btn" onclick="toggleHelpFAQModal()">×</button>
      </div>
      <div class="help-faq-body">
        <h3>Pertanyaan Umum (FAQ)</h3>
        <p>Di sini Anda dapat menemukan jawaban atas pertanyaan yang sering diajukan. Jika Anda tidak menemukan jawaban, silakan gunakan ChatAI di bawah ini.</p>
        <ul>
          <li><strong>Apa itu Statistika?</strong> Statistika adalah ilmu yang berkaitan dengan pengumpulan, pengorganisasian, analisis, interpretasi, dan presentasi data.</li>
          <li><strong>Bagaimana cara menggunakan Analysis Tools?</strong> Pilih tool yang Anda inginkan dari menu, masukkan data, dan klik 'Analisis'.</li>
          <li><strong>Apakah saya bisa mengunduh materi?</strong> Saat ini fitur unduh belum tersedia, namun Anda bisa menyalin teks materi.</li>
        </ul>

        <div class="chatbot-container-modal">
          <div class="chatbot-header">
            <span>ChatAI untuk Analisis Data</span>
          </div>
          <div class="chatbot-messages" id="chatbot-messages">
            <div class="chatbot-message bot">Halo! Saya ChatAI SARC, asisten Anda untuk analisis data statistik. Ada yang bisa saya bantu?</div>
          </div>
          <div class="chatbot-input">
            <input type="text" id="chatbot-input-field" placeholder="Ketik pertanyaan Anda tentang analisis data..." onkeypress="handleChatInput(event)"/>
            <button onclick="sendChatMessage()">Kirim</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- Modal Tambah Materi Baru (Tambahkan di sini) -->
<div id="addMaterialModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001; justify-content: center; align-items: center;">
  <div style="background: white; padding: 20px; width: 90%; max-width: 500px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
    <h3>Tambah Materi Baru</h3>
    <div class="form-group">
      <label for="new-material-title">Judul (contoh: Topik Baru):</label>
      <input type="text" id="new-material-title" placeholder="Masukkan judul materi" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;">
    </div>
    <div class="form-group">
      <label for="new-material-subtitle">Subtitle/Deskripsi Singkat:</label>
      <input type="text" id="new-material-subtitle" placeholder="Masukkan deskripsi singkat" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;">
    </div>
    <div class="form-group">
      <label for="new-material-content">Konten Utama (HTML sederhana):</label>
      <textarea id="new-material-content" rows="6" placeholder="Masukkan konten (bisa HTML seperti &lt;h3&gt;Judul&lt;/h3&gt;&lt;p&gt;Teks&lt;/p&gt;)" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace;"></textarea>
    </div>
    <button class="btn-primary" onclick="confirmAddMaterial()" style="margin-right: 10px;">Tambah Materi</button>
    <button onclick="closeAddMaterialModal()" style="background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Batal</button>
  </div>
</div>

<script>
  let isAdminMode = false;
  let currentEditableContent = null; // To store the currently edited element
  let originalContent = ''; // To store original content before editing
  const ADMIN_PASSWORD = '12345'; // Password standar untuk admin
  const LOCAL_STORAGE_PREFIX = 'webstat_'; // Prefix for local storage keys

  // Helper functions for local storage
  function saveToLocalStorage(key, value) {
    localStorage.setItem(LOCAL_STORAGE_PREFIX + key, JSON.stringify(value));
  }

  function loadFromLocalStorage(key) {
    const stored = localStorage.getItem(LOCAL_STORAGE_PREFIX + key);
    return stored ? JSON.parse(stored) : null;
  }

// PERBAIKAN: Pisahkan Materials (editable, array sequential) dari Tools (statis)
// Hapus seluruh 'let materialContents = { ... };' lama dan ganti dengan ini

let materialsArray = []; // Array untuk materials editable (ID: 1,2,3,... sequential, hanya 1-7 default)

let toolsArray = [  // Array statis untuk tools (ID string, tidak ikut numbering materials)
  { 
    id: 'analysis', 
    title: 'Analysis', 
    subtitle: 'Tools analisis data statistik interaktif',
    content:`/*analysisToolContents['deskriptif']*/
        <h2>Analysis - Tools Analisis Statistik</h2>
        <p>Platform tools interaktif untuk melakukan berbagai jenis analisis statistik dengan mudah dan akurat.</p>
        
        <div class="analysis-tools">
          <h3>Tools Analisis Statistik Tersedia</h3>
          <div class="tools-grid">
            <button class="tool-btn" onclick="showAnalysisTool('deskriptif')">Statistik Deskriptif</button>
            <button class="tool-btn" onclick="showAnalysisTool('uji-mean')">Uji t (t-Test)</button>
            <button class="tool-btn" onclick="showAnalysisTool('anova')">ANOVA</button>
            <button class="tool-btn" onclick="showAnalysisTool('mann-whitney')">Mann-Whitney U</button>
            <button class="tool-btn" onclick="showAnalysisTool('chi-square')">Chi-Square Test</button>
            <button class="tool-btn" onclick="showAnalysisTool('korelasi')">Analisis Korelasi</button>
            <button class="tool-btn" onclick="showAnalysisTool('regresi')">Regresi Linear</button>
            <button class="tool-btn" onclick="showAnalysisTool('clustering')">Clustering</button>
            <button class="tool-btn" onclick="showAnalysisTool('factor-analysis')">Factor Analysis</button>
            <button class="tool-btn" onclick="showAnalysisTool('uji-asumsi')">Uji Asumsi Klasik</button>
            <button class="tool-btn" onclick="showAnalysisTool('uji-instrumen')">Uji Validitas & Reliabilitas</button>
            <button class="tool-btn" onclick="showAnalysisTool('Sample Size')">Sample Size</button>
          </div>
        </div>
        
        <h3>Cara Penggunaan Tools</h3>
        <ol>
          <li>Pilih jenis analisis yang sesuai dengan tujuan penelitian Anda</li>
          <li>Upload file data (.csv, .xlsx) atau input data secara manual</li>
          <li>Atur parameter analisis sesuai kebutuhan</li>
          <li>Klik tombol "Analisis" untuk memproses data</li>
          <li>Interpretasikan hasil output yang disediakan</li>
          <li>Download laporan hasil analisis dalam format PDF atau Excel</li>
        </ol>
        
        <h3>Format Data yang Didukung</h3>
        <ul>
          <li><strong>File CSV:</strong> Comma-separated values</li>
          <li><strong>File Excel:</strong> Format .xlsx dan .xls</li>
          <li><strong>Input Manual:</strong> Copy-paste dari spreadsheet</li>
          <li><strong>Database Connection:</strong> Koneksi langsung ke database (fitur premium)</li>
        </ul>
        
        <h3>Fitur Tambahan</h3>
        <ul>
          <li>Visualisasi otomatis hasil analisis</li>
          <li>Export hasil dalam berbagai format</li>
          <li>History analisis untuk tracking progress</li>
          <li>Template report untuk dokumentasi</li>
          <li>Kolaborasi tim untuk proyek bersama</li>
        </ul>
		
		<div id="analysis-content" style="margin-top: 30px; padding: 20px; background: #f9f9f9; border-radius: 8px; min-height: 400px;">
          <p><em>Pilih tool dari grid di atas untuk memulai analisis. Contoh: Klik "Power Analysis" untuk fitur power uji dan sample size.</em></p>
        </div>
    `
  },
  { 
    id: 'whiteboard', 
    title: 'Whiteboard', 
    subtitle: 'Tools untuk menggambar, menulis catatan, dan brainstorming',
    content: `
        <h2>Whiteboard - Tools Menggambar dan Catatan</h2>
        <p>Gunakan whiteboard ini untuk brainstorming, sketsa diagram, atau catatan cepat. Dukung mouse dan touch.</p>
    
        <!-- Toolbar -->
        <div id="whiteboard-container" style="position: relative;">
          <div id="whiteboard-toolbar" style="background: #f5f5f5; padding: 10px; border-radius: 8px; margin-bottom: 10px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 10;">
		  
		  <!-- Pen Tool -->
          <button id="pen-tool" class="tool-btn" style="background: #4CAF50; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer;">🖊️Pen </button>
      
          <!-- Color Picker -->
          <label style="display: flex; align-items: center; gap: 5px;">
            <select id="color-picker" style="padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
              <option value="#0000FF">Blue</option>
			  <option value="#000000">Black</option>
              <option value="#FF0000">Red</option>
              <option value="#00FF00">Green</option>
              <option value="#FFFF00">Yellow</option>
              <option value="#FF00FF">Magenta</option>
              <option value="#00FFFF">Cyan</option>
            </select>
            <input type="color" id="color-input" value="#0000FF" style="width: 40px; height: 30px; border: none; border-radius: 4px; cursor: pointer;">
          </label>
      
          <!-- Line Width -->
          <label style="display: flex; align-items: center; gap: 5px;">
            <input type="range" id="line-width" min="1" max="20" value="2" style="width: 80px;">
            <span id="line-width-value">2px</span>
          </label>
      
		  <!-- Select -->
          <button id="select-tool" class="tool-btn" style="background: #FF00FF; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer;">👆Select</button>

          <!-- Text Tool -->
          <button id="text-tool" class="tool-btn" style="background: #2196F3; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer;">📝Text</button>
          <input type="text" id="text-input" placeholder="Ketik teks..." style="padding: 5px; border-radius: 4px; border: 1px solid #ccc; display: none; width: 150px;" maxlength="100">
      
          <!-- Eraser -->
          <button id="eraser-tool" class="tool-btn" style="background: #FF0000; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer;">🧽Erase</button>
           
		  <button id="delete-tool" class="tool-btn" style="background: #F44336; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer;" onclick="deleteSelected()">🗑️Delete</button>

          <!-- Clear All -->
          <button id="clear-tool" class="tool-btn" style="background: #FF00FF; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer;" onclick="clearCanvas()">🧹Clear</button>
		  	  
		  <!-- Reset Canvas Tool -->
		  <button id="reset-canvas-btn" class="tool-btn" style="background: #2196F3; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer;">🔄 Reset</button>      

		  <button id="undo-tool" class="tool-btn" style="background: #4CAF50; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer;" onclick="undo()">↶</button>
		  <button id="redo-tool" class="tool-btn" style="background: #4CAF50; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer;" onclick="redo()">↷</button>	  

		  <!-- Save -->
            <button id="save-tool" class="tool-btn" style="background: #9C27B0; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer;" onclick="saveCanvas()">💾Save</button>
		    <button id="fullscreen-tool" class="tool-btn" style="background: #607D8B; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer;" onclick="toggleFullscreen()">⛶ Full</button>
		  </div>
		  		                              
		<!-- Canvas Container (pindah ke dalam wrapper) -->
		<div id="canvas-wrapper" style="position: relative; border: 2px solid #ddd; border-radius: 8px; overflow: hidden; background: white; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
		  <canvas id="whiteboard-canvas" width="800" height="500" style="display: block; cursor: crosshair;"></canvas>
		  <div id="text-cursor" style="position: absolute; display: none; border: 2px dashed #2196F3; background: rgba(33, 150, 243, 0.1);"></div>
		</div>
    	
		</div>
        
		<p style="margin-top: 10px; font-size: 14px; color: #666;">
          Instruksi: Pilih tool, lalu klik dan drag di canvas. Untuk text, klik canvas setelah pilih tool Text, lalu ketik di input.
        </p>
      `
    }
];

// Fungsi load materials dari localStorage (default jika kosong)
// Panggil fungsi ini di DOMContentLoaded untuk inisialisasi
function loadMaterialsFromStorage() {
  const stored = loadFromLocalStorage('materialsArray');
  if (stored && stored.length > 0) {
    materialsArray = stored;
  } else {
    // Default materials 1-7 (GANTI CONTENT INI DENGAN ISI ASLI DARI materialContents[1-7] lama)
    materialsArray = [
      // ID 1: Pengantar Statistika
      { 
        id: 1, 
        title: '1. Pengantar Statistika', 
        subtitle: 'Sejarah, arti, peran, populasi, sampel, teknik sampling, parameter dan statistik',
        content: `<!-- GANTI DENGAN CONTENT ASLI DARI materialContents[1].content -->
        <h2>1. Pengantar Statistika</h2>        
        <h3>Sejarah Statistika</h3>
        <p>Statistika sebagai ilmu berkembang dari kebutuhan praktis untuk mengumpulkan dan menganalisis data. Awalnya digunakan untuk keperluan administrasi negara (state arithmetic), statistika kini telah berkembang menjadi ilmu yang fundamental dalam penelitian ilmiah dan pengambilan keputusan berbasis data.</p>
        
        <p>Perkembangan statistika dimulai dari:</p>
        <ul>
          <li><strong>Abad 17:</strong> John Graunt - analisis data kematian London</li>
          <li><strong>Abad 18:</strong> Thomas Bayes - teorema Bayes</li>
          <li><strong>Abad 19:</strong> Carl Friedrich Gauss - distribusi normal</li>
          <li><strong>Abad 20:</strong> Ronald Fisher - ANOVA dan desain eksperimen</li>
        </ul>
        
        <h3>Arti dan Peran Statistika</h3>
        <p>Statistika adalah ilmu yang berkaitan dengan pengumpulan, pengorganisasian, analisis, interpretasi, dan presentasi data. Statistika memainkan peran penting dalam:</p>
        <ul>
          <li>Pengambilan keputusan berdasarkan data empiris</li>
          <li>Penelitian ilmiah dan metodologi eksperimen</li>
          <li>Analisis tren, pola, dan prediksi masa depan</li>
          <li>Kontrol kualitas dalam industri dan layanan</li>
          <li>Kebijakan publik berdasarkan evidensi</li>
        </ul>
        
        <h3>Populasi, Sampel, dan Teknik Sampling</h3>
        <p><strong>Populasi</strong> adalah keseluruhan objek atau individu yang menjadi sasaran penelitian atau yang memiliki karakteristik tertentu yang ingin dipelajari. <strong>Sampel</strong> adalah bagian dari populasi yang dipilih untuk diteliti sebagai representasi populasi.</p>
        
        <p><strong>Teknik Sampling Probabilitas:</strong></p>
        <ul>
          <li><strong>Simple Random Sampling:</strong> Setiap anggota populasi memiliki peluang sama untuk terpilih</li>
          <li><strong>Stratified Sampling:</strong> Populasi dibagi strata, kemudian diambil sampel dari setiap strata</li>
          <li><strong>Cluster Sampling:</strong> Populasi dibagi cluster, beberapa cluster dipilih secara acak</li>
          <li><strong>Systematic Sampling:</strong> Pemilihan sampel dengan interval tetap</li>
        </ul>
        
        <p><strong>Teknik Sampling Non-Probabilitas:</strong></p>
        <ul>
          <li><strong>Convenience Sampling:</strong> Sampel mudah diakses</li>
          <li><strong>Purposive Sampling:</strong> Sampel dipilih berdasarkan kriteria tertentu</li>
          <li><strong>Quota Sampling:</strong> Sampel berdasarkan kuota yang telah ditentukan</li>
          <li><strong>Snowball Sampling:</strong> Sampel diperoleh melalui referensi responden</li>
        </ul>
        
        <h3>Parameter dan Statistik</h3>
        <p><strong>Parameter</strong> adalah ukuran yang menggambarkan karakteristik populasi (biasanya tidak diketahui dan dilambangkan dengan huruf Yunani). <strong>Statistik</strong> adalah ukuran yang menggambarkan karakteristik sampel (dapat dihitung dari data sampel).</p>
        
        <p><strong>Contoh Parameter vs Statistik:</strong></p>
        <ul>
          <li>μ (mu) = rata-rata populasi vs x̄ = rata-rata sampel</li>
          <li>σ (sigma) = standar deviasi populasi vs s = standar deviasi sampel</li>
          <li>π (pi) = proporsi populasi vs p = proporsi sampel</li>
        </ul>
        
        <div class="references">
          <h4>Referensi</h4>
          <ol>
            <li>D. C. Montgomery and G. C. Runger, "Applied Statistics and Probability for Engineers," 7th ed., Wiley, 2018.</li>
            <li>R. E. Walpole et al., "Probability & Statistics for Engineers & Scientists," 9th ed., Pearson, 2016.</li>
            <li>J. L. Devore, "Probability and Statistics for Engineering and the Sciences," 9th ed., Cengage, 2015.</li>
            <li>W. Mendenhall et al., "Introduction to Probability and Statistics," 15th ed., Cengage, 2020.</li>
          </ol>
        </div>
      `
      },
       
      {
	  id: 2,
      title: "2. Statistika Deskriptif",
      subtitle: "Penyajian data, ukuran pemusatan, ukuran penyebaran",
      content: `
        <h2>2. Statistika Deskriptif</h2>
        
        <h3>Pengertian Statistika Deskriptif</h3>
        <p>Statistika deskriptif adalah cabang statistika yang berkaitan dengan pengumpulan, penyajian, dan peringkasan data untuk memberikan informasi yang berguna tentang data tersebut. Tujuan utamanya adalah menggambarkan karakteristik data tanpa membuat kesimpulan yang melampaui data yang tersedia.</p>
        
        <h3>Penyajian Data dalam Bentuk Tabel dan Grafik</h3>
        <p>Data dapat disajikan dalam berbagai bentuk untuk memudahkan pemahaman dan interpretasi:</p>
        
        <p><strong>Jenis-jenis Grafik:</strong></p>
        <ul>
          <li><strong>Bar Chart:</strong> Menampilkan data kategorikal dengan batang vertikal atau horizontal</li>
          <li><strong>Histogram:</strong> Menampilkan distribusi frekuensi data kontinu</li>
          <li><strong>Line Chart:</strong> Menampilkan trend data sepanjang waktu</li>
          <li><strong>Pie Chart:</strong> Menampilkan proporsi bagian dari keseluruhan</li>
          <li><strong>Polygon:</strong> Menghubungkan titik tengah histogram dengan garis</li>
          <li><strong>Ogive:</strong> Grafik frekuensi kumulatif</li>
          <li><strong>Scatter Plot:</strong> Menampilkan hubungan antara dua variabel kontinu</li>
          <li><strong>Box Plot:</strong> Menampilkan distribusi data melalui kuartil</li>
          <li><strong>Stem-and-Leaf:</strong> Menampilkan distribusi dengan mempertahankan nilai asli</li>
        </ul>
        
        <h3>Ukuran Pemusatan Data</h3>
        <p>Ukuran pemusatan memberikan informasi tentang nilai tengah atau pusat dari suatu distribusi data:</p>
        
        <ul>
          <li><strong>Mean (Rata-rata Aritmatika):</strong>
            <p>Formula: μ = Σxi/n (populasi) atau x̄ = Σxi/n (sampel)</p>
            <p>Kelebihan: Menggunakan semua data, mudah dihitung</p>
            <p>Kelemahan: Sensitif terhadap outlier</p>
          </li>
          <li><strong>Median:</strong>
            <p>Nilai tengah setelah data diurutkan dari terkecil ke terbesar</p>
            <p>Kelebihan: Tidak terpengaruh outlier</p>
            <p>Kelemahan: Tidak menggunakan semua informasi data</p>
          </li>
          <li><strong>Modus:</strong>
            <p>Nilai yang paling sering muncul dalam data</p>
            <p>Dapat digunakan untuk semua jenis data (nominal, ordinal, interval, rasio)</p>
          </li>
        </ul>
        
        <h3>Ukuran Penyebaran Data</h3>
        <p>Ukuran penyebaran menggambarkan seberapa tersebar atau bervariasi data dari pusat distribusi:</p>
        
        <ul>
          <li><strong>Range:</strong> Selisih antara nilai maksimum dan minimum</li>
          <li><strong>Varians:</strong>
            <p>σ² = Σ(xi-μ)²/N (populasi) atau s² = Σ(xi-x̄)²/(n-1) (sampel)</p>
          </li>
          <li><strong>Standar Deviasi:</strong>
            <p>σ = √σ² (populasi) atau s = √s² (sampel)</p>
          </li>
          <li><strong>Kuartil:</strong>
            <p>Q1 (kuartil pertama), Q2 (median), Q3 (kuartil ketiga)</p>
          </li>
          <li><strong>Interquartile Range (IQR):</strong> Q3 - Q1</li>
          <li><strong>Koefisien Variasi:</strong> CV = (σ/μ) × 100%</p>
          </li>
        </ul>
        
        <h3>Bentuk Distribusi Data</h3>
        <ul>
          <li><strong>Simetris:</strong> Data terdistribusi merata di sekitar pusat</li>
          <li><strong>Skewness Positif:</strong> Ekor distribusi memanjang ke kanan</li>
          <li><strong>Skewness Negatif:</strong> Ekor distribusi memanjang ke kiri</li>
          <li><strong>Kurtosis:</strong> Mengukur keruncingan distribusi</li>
        </ul>
        
        <div class="references">
          <h4>Referensi</h4>
          <ol>
            <li>A. Agresti and B. Finlay, "Statistical Methods for the Social Sciences," 5th ed., Pearson, 2014.</li>
            <li>D. S. Moore et et al., "Introduction to the Practice of Statistics," 9th ed., W.H. Freeman, 2017.</li>
            <li>R. Lind et al., "Statistical Techniques in Business and Economics," 17th ed., McGraw-Hill, 2018.</li>
            <li>B. Render et al., "Quantitative Analysis for Management," 13th ed., Pearson, 2018.</li>
          </ol>
        </div>
      `
    },
    {
      id: 3,
	  title: "3. Statistika Inferensial",
      subtitle: "Distribusi peluang, uji hipotesis, parametrik, non-parametrik",
      content: `
        <h2>3. Statistika Inferensial</h2>
        
        <h3>Pengertian Statistika Inferensial</h3>
        <p>Statistika inferensial adalah cabang statistika yang berkaitan dengan penarikan kesimpulan tentang populasi berdasarkan informasi yang diperoleh dari sampel. Berbeda dengan statistika deskriptif, statistika inferensial memungkinkan kita membuat generalisasi dan prediksi.</p>
        
        <h3>Distribusi Peluang</h3>
        <p>Distribusi peluang adalah fondasi matematika untuk statistika inferensial yang menggambarkan bagaimana probabilitas terdistribusi over nilai-nilai yang mungkin dari suatu variabel random.</p>
        
        <p><strong>Distribusi Peluang Diskrit:</strong></p>
        <ul>
          <li><strong>Distribusi Binomial:</strong> B(n,p) - untuk eksperimen berulang dengan probabilitas sukses konstan</li>
          <li><strong>Distribusi Poisson:</strong> P(λ) - untuk kejadian langka dalam interval waktu/ruang tertentu</li>
          <li><strong>Distribusi Geometrik:</strong> untuk jumlah percobaan hingga sukses pertama</li>
          <li><strong>Distribusi Hipergeometrik:</strong> sampling tanpa pengembalian</li>
        </ul>
        
        <p><strong>Distribusi Peluang Kontinu:</strong></p>
        <ul>
          <li><strong>Distribusi Normal:</strong> N(μ,σ²) - distribusi simetrik berbentuk lonceng</li>
          <li><strong>Distribusi t-Student:</strong> untuk sampel kecil dengan σ tidak diketahui</li>
          <li><strong>Distribusi Chi-square (χ²):</strong> untuk uji varians dan goodness of fit</li>
          <li><strong>Distribusi F:</strong> untuk uji rasio dua varians</li>
          <li><strong>Distribusi Uniform:</strong> semua nilai dalam interval memiliki probabilitas sama</li>
        </ul>
        
        <h3>Pendugaan Parameter</h3>
        <p>Estimasi parameter populasi menggunakan statistik sampel:</p>
        
        <ul>
          <li><strong>Point Estimate:</strong>
            <p>Dugaan tunggal untuk parameter populasi (contoh: x̄ sebagai dugaan μ)</p>
          </li>
          <li><strong>Interval Estimate (Confidence Interval):</strong>
            <p>Rentang nilai yang memiliki probabilitas tertentu memuat parameter populasi</p>
            <p>CI = point estimate ± margin of error</p>
          </li>
        </ul>
        
        <h3>Konsep Uji Hipotesis</h3>
        <p>Uji hipotesis adalah prosedur statistik untuk menguji klaim atau asumsi tentang parameter populasi berdasarkan evidence dari sampel.</p>
        
        <p><strong>Komponen Uji Hipotesis:</strong></p>
        <ul>
          <li><strong>H₀ (Hipotesis Nol):</strong> Pernyataan yang diuji, biasanya "tidak ada efek" atau "tidak ada perbedaan"</li>
          <li><strong>H₁ atau Ha (Hipotesis Alternatif):</strong> Pernyataan yang akan diterima jika H₀ ditolak</li>
          <li><strong>α (Alpha):</strong> Tingkat signifikansi, probabilitas menolak H₀ yang benar (Type I error)</li>
          <li><strong>β (Beta):</strong> Probabilitas menerima H₀ yang salah (Type II error)</li>
          <li><strong>Power:</strong> 1-β, probabilitas menolak H₀ yang salah</li>
          <li><strong>p-value:</strong> Probabilitas mendapat hasil ekstrem atau lebih ekstrem jika H₀ benar</li>
        </ul>
        
        <h3>Jenis Uji Hipotesis</h3>
        <ul>
          <li><strong>Uji Deskriptif:</strong> Menguji karakteristik satu variabel (contoh: uji rata-rata satu sampel)</li>
          <li><strong>Uji Komparatif:</strong> Membandingkan antar kelompok (contoh: uji beda rata-rata dua kelompok)</li>
          <li><strong>Uji Asosiatif:</strong> Menguji hubungan antar variabel (contoh: uji korelasi, uji independensi)</li>
        </ul>
        
        <h3>Statistika Inferensial Parametrik</h3>
        <p>Metode yang mengasumsikan data mengikuti distribusi tertentu (biasanya normal):</p>
        <ul>
          <li><strong>Uji-t:</strong> One-sample, two-sample, paired t-test</li>
          <li><strong>ANOVA:</strong> One-way, two-way, repeated measures ANOVA</li>
          <li><strong>Uji Korelasi Pearson:</strong> Mengukur hubungan linear antar variabel</li>
          <li><strong>Regresi Linear:</strong> Memodelkan hubungan antar variabel</li>
        </ul>
        
        <h3>Statistika Inferensial Non-Parametrik</h3>
        <p>Metode yang tidak mengasumsikan distribusi tertentu, cocok untuk data tidak normal:</p>
        <ul>
          <li><strong>Uji Chi-square:</strong> Uji independensi dan goodness of fit</li>
          <li><strong>Uji Binomial:</strong> Untuk proporsi dalam sampel kecil</li>
          <li><strong>Uji Tanda:</strong> Membandingkan median dengan nilai tertentu</li>
          <li><strong>Uji Mann-Whitney (Wilcoxon Rank-Sum):</strong> Membandingkan dua kelompok independen</li>
          <li><strong>Uji Wilcoxon Signed-Rank:</strong> Untuk data berpasangan</li>
          <li><strong>Uji Kruskal-Wallis:</strong> Alternatif non-parametrik untuk one-way ANOVA</li>
        </ul>
        
        <h3>Uji Asumsi Klasik</h3>
        <p>Pengujian asumsi yang harus dipenuhi dalam analisis parametrik:</p>
        <ul>
          <li><strong>Uji Normalitas:</strong> Shapiro-Wilk, Kolmogorov-Smirnov, Anderson-Darling</li>
          <li><strong>Uji Homogenitas Varians:</strong> Levene's test, Bartlett's test</li>
          <li><strong>Uji Independensi:</strong> Durbin-Watson test untuk autokorelasi</li>
          <li><strong>Uji Linearitas:</strong> Untuk hubungan linear dalam regresi</li>
        </ul>
        
        <div class="references">
          <h4>Referensi</h4>
          <ol>
            <li>R. V. Hogg et al., "Introduction to Mathematical Statistics," 8th ed., Pearson, 2019.</li>
            <li>J. E. Freund and B. M. Perles, "Modern Elementary Statistics," 12th ed., Pearson, 2014.</li>
            <li>G. Casella and R. L. Berger, "Statistical Inference," 2nd ed., Duxbury, 2002.</li>
            <li>D. Wackerly et al., "Mathematical Statistics with Applications," 7th ed., Cengage, 2008.</li>
            <li>B. Efron and T. Hastie, "Computer Age Statistical Inference", Cambridge University Press, 2016.</li>
          </ol>
        </div>
      `
    },
    {
      id: 4,
	  title: "4. Probabilitas dan Distribusi",
      subtitle: "Konsep dasar probabilitas, distribusi diskrit dan kontinu",
      content: `
        <h2>4. Probabilitas dan Distribusi Lanjutan</h2>
        
        <h3>Konsep Fundamental Probabilitas</h3>
        <p>Probabilitas adalah ukuran numerik kemungkinan terjadinya suatu kejadian, dengan nilai antara 0 dan 1. Konsep ini merupakan fondasi untuk semua metode statistika inferensial.</p>
        
        <p><strong>Definisi Probabilitas:</strong></p>
        <ul>
          <li><strong>Pendekatan Klasik:</strong> P(A) = jumlah hasil yang menguntungkan / total hasil yang mungkin</li>
          <li><strong>Pendekatan Frekuensi Relatif:</b> P(A) = limit (frekuensi A / jumlah percobaan) saat n → ∞</li>
          <li><strong>Pendekatan Subjektif:</strong> Berdasarkan keyakinan atau pengalaman pribadi</li>
        </ul>
        
        <h3>Ruang Sampel dan Kejadian</h3>
        <ul>
          <li><strong>Ruang Sampel (S):</strong> Himpunan semua hasil yang mungkin dari suatu eksperimen</li>
          <li><strong>Kejadian (Event):</strong> Subset dari ruang sampel</li>
          <li><strong>Kejadian Sederhana:</strong> Kejadian yang hanya memuat satu hasil</li>
          <li><strong>Kejadian Majemuk:</strong> Kejadian yang memuat lebih dari satu hasil</li>
        </ul>
        
        <h3>Aturan-aturan Probabilitas</h3>
        <ul>
          <li><strong>Aturan Penjumlahan:</strong>
            <p>P(A∪B) = P(A) + P(B) - P(A∩B)</p>
            <p>Untuk kejadian saling asing: P(A∪B) = P(A) + P(B)</p>
          </li>
          <li><strong>Aturan Perkalian:</strong>
            <p>P(A∩B) = P(A|B) × P(B) = P(B|A) × P(A)</p>
            <p>Untuk kejadian independen: P(A∩B) = P(A) × P(B)</p>
          </li>
          <li><strong>Probabilitas Bersyarat:</strong>
            <p>P(A|B) = P(A∩B) / P(B), dimana P(B) > 0</p>
          </li>
          <li><strong>Teorema Bayes:</strong>
            <p>P(A|B) = [P(B|A) × P(A)] / P(B)</p>
          </li>
        </ul>
        
        <h3>Distribusi Sampling</h3>
        <p>Distribusi sampling adalah distribusi probabilitas dari statistik sampel yang diperoleh dari pengambilan sampel berulang dari populasi yang sama.</p>
        
        <ul>
          <li><strong>Central Limit Theorem (CLT):</strong>
            <p>Untuk sampel berukuran besar (n≥30), distribusi sampling rata-rata mendekati normal terlepas dari bentuk distribusi populasi</p>
          </li>
          <li><strong>Standard Error:</strong>
            <p>SE = σ/√n (jika σ diketahui) atau SE = s/√n (jika σ tidak diketahui)</p>
          </li>
          <li><strong>Distribusi Sampling Proporsi:</strong>
            <p>Untuk sampel besar, p̂ ~ N(π, √[π(1-π)/n])</p>
          </li>
        </ul>
        
        <h3>Teorema Limit Pusat dan Aplikasinya</h3>
        <p>CLT memungkinkan kita menggunakan distribusi normal untuk inferensi statistik meskipun populasi tidak berdistribusi normal, asalkan ukuran sampel cukup besar.</p>
        
        <div class="references">
          <h4>Referensi</h4>
          <ol>
            <li>S. Ross, "A First Course in Probability," 10th ed., Pearson, 2019.</li>
            <li>A. Papoulis and S. U. Pillai, "Probability, Random Variables and Stochastic Processes," 4th ed., McGraw-Hill, 2002.</li>
            <li>K. L. Chung, "A Course in Probability Theory," 3rd ed., Academic Press, 2001.</li>
            <li>P. G. Hoel et al., "Introduction to Probability Theory," Houghton Mifflin, 1971.</li>
          </ol>
        </div>
      `
    },
    {
      id: 5,
	  title: "5. Teori Statistika Lanjut",
      subtitle: "GLM, Non-Linear Model, Bayesian",
      content: `
        <h2>5. Teori Statistika Lanjut</h2>
        
        <h3>Generalized Linear Models (GLM)</h3>
        <p>GLM adalah ekstensi fleksibel dari regresi linear klasik yang memungkinkan variabel respon memiliki distribusi selain normal dan hubungan non-linear dengan variabel prediktor melalui fungsi link.</p>
        
        <p><strong>Komponen GLM:</strong></p>
        <ul>
          <li><strong>Random Component:</strong> Distribusi variabel respon (eksponensial family)</li>
          <li><strong>Systematic Component:</strong> Linear combination dari variabel prediktor</li>
          <li><strong>Link Function:</strong> Menghubungkan mean dengan linear predictor</li>
        </ul>
        
        <p><strong>Jenis-jenis GLM:</strong></p>
        <ul>
          <li><strong>Regresi Logistik:</strong> Untuk variabel respon biner (0/1), link function = logit</li>
          <li><strong>Regresi Poisson:</strong> Untuk data count, link function = log</li>
          <li><strong>Regresi Gamma:</strong> Untuk data positif kontinyu dengan varians yang meningkat dengan mean</li>
          <li><strong>Regresi Multinomial:</strong> Untuk variabel kategorikal dengan lebih dari 2 kategori</li>
        </ul>
        
        <h3>Model Non-Linear</h3>
        <p>Model yang menangkap hubungan non-linear antar variabel tanpa transformasi linear:</p>
        
        <ul>
          <li><strong>Polynomial Regression:</strong>
            <p>y = β₀ + β₁x + β₂x² + ... + βₖxᵏ + ε</p>
          </li>
          <li><strong>Exponential Models:</strong>
            <p>y = ae^(bx) + ε</p>
          </li>
          <li><strong>Power Models:</strong>
            <p>y = ax^b + ε</p>
          </li>
          <li><strong>Logistic Growth Models:</strong>
            <p>y = K/(1 + ae^(-bx))</p>
          </li>
          <li><strong>Spline Regression:</strong> Piecewise polynomials untuk fleksibilitas lokal</li>
        </ul>
        
        <h3>Statistika Bayesian</h3>
        <p>Pendekatan statistika yang menggunakan teorema Bayes untuk update keyakinan (belief) tentang parameter berdasarkan data yang diamati.</p>
        
        <p><strong>Komponen Utama:</strong></p>
        <ul>
          <li><strong>Prior Distribution π(θ):</strong> Keyakinan awal tentang parameter sebelum melihat data</li>
          <li><strong>Likelihood L(θ|data):</strong> Fungsi kemungkinan data given parameter</li>
          <li><strong>Posterior Distribution π(θ|data):</strong> Keyakinan yang diperbarui setelah melihat data</li>
          <li><strong>Predictive Distribution:</strong> Distribusi untuk prediksi data masa depan</li>
        </ul>
        
        <p><strong>Teorema Bayes:</strong></p>
        <p>π(θ|data) ∝ L(θ|data) × π(θ)</p>
        
        <p><strong>Keunggulan Pendekatan Bayesian:</strong></p>
        <ul>
          <li>Dapat mengincorporate prior knowledge</li>
          <li>Memberikan distribusi lengkap parameter, bukan hanya point estimate</li>
          <li>Natural way untuk sequential learning</li>
          <li>Dapat handle uncertainty secara komprehensif</li>
        </ul>
        
        <h3>Metode Komputasi Modern</h3>
        <ul>
          <li><strong>Markov Chain Monte Carlo (MCMC):</strong>
            <p>Gibbs Sampling, Metropolis-Hastings algorithm</p>
          </li>
          <li><strong>Variational Inference:</strong> Aproksimasi deterministik untuk posterior</li>
          <li><strong>Bootstrap Methods:</strong> Resampling untuk estimasi distribusi sampling</li>
          <li><strong>Cross-Validation:</strong> Untuk model selection dan validation</li>
        </ul>
        
        <div class="references">
          <h4>Referensi</h4>
          <ol>
            <li>P. McCullagh and J. A. Nelder, "Generalized Linear Models," 2nd ed., Chapman & Hall, 1989.</li>
            <li>A. Gelman et al., "Bayesian Data Analysis," 3rd ed., CRC Press, 2013.</li>
            <li>D. M. Bates and D. G. Watts, "Nonlinear Regression Analysis and Its Applications," Wiley, 1988.</li>
            <li>C. P. Robert, "The Bayesian Choice," 2nd ed., Springer, 2007.</li>
            <li>T. Hastie et al., "The Elements of Statistical Learning," 2nd ed., Springer, 2009.</li>
            <li>B. Efron and R. J. Tibshirani, "An Introduction to the Bootstrap," Chapman & Hall, 1993.</li>
          </ol>
        </div>
      `
    },
    {
	  id: 6,
      title: "6. Penerapan Statistika",
      subtitle: "Komputer, AI, sains data, big data",
      content: `
        <h2>6. Penerapan Statistika dalam Berbagai Bidang</h2>
        
        <h3>Statistika dalam Ilmu Komputer</h3>
        <p>Statistika memainkan peran fundamental dalam berbagai aspek ilmu komputer dan teknologi informasi:</p>
        
        <ul>
          <li><strong>Algoritma Randomized:</strong>
            <p>- Monte Carlo methods untuk simulasi dan optimisasi</p>
            <p>- Simulated annealing untuk optimisasi global</p>
            <p>- Randomized algorithms dalam sorting dan searching</p>
          </li>
          <li><strong>Kriptografi dan Keamanan:</strong>
            <p>- Analisis entropi untuk kekuatan kunci enkripsi</p>
            <p>- Statistical tests untuk random number generators</p>
            <p>- Frequency analysis dalam cryptanalysis</p>
          </li>
          <li><strong>Computer Graphics dan Rendering:</strong>
            <p>- Monte Carlo ray tracing</p>
            <p>- Importance sampling untuk rendering realistik</p>
            <p>- Noise functions untuk procedural textures</p>
          </li>
          <li><strong>Database dan Information Retrieval:</strong>
            <p>- Query optimization menggunakan statistik tabel</p>
            <p>- Text mining dan document classification</p>
            <p>- Recommendation systems</p>
          </li>
        </ul>
        
        <h3>Artificial Intelligence (AI) dan Machine Learning</h3>
        <p>Statistika adalah fondasi matematika untuk sebagian besar teknik AI modern:</p>
        
        <ul>
          <li><strong>Supervised Learning:</strong>
            <p>- Classification: Logistic regression, SVM, decision trees</p>
            <p>- Regression: Linear/non-linear regression, ensemble methods</p>
            <p>- Model evaluation: Cross-validation, ROC curves, confusion matrices</p>
          </li>
          <li><strong>Unsupervised Learning:</strong>
            <p>- Clustering: K-means, hierarchical clustering, DBSCAN</p>
            <p>- Dimensionality reduction: PCA, t-SNE, UMAP</p>
            <p>- Density estimation: Gaussian mixture models</p>
          </li>
          <li><strong>Deep Learning:</strong>
            <p>- Stochastic gradient descent dan variants</p>
            <p>- Regularization techniques (L1/L2, dropout)</p>
            <p>- Bayesian neural networks</p>
          </li>
          <li><strong>Natural Language Processing:</strong>
            <p>- N-gram models dan language modeling</p>
            <p>- Hidden Markov Models untuk sequence labeling</p>
            <p>- Topic modeling (LDA, LSA)</p>
          </li>
        </ul>
        
        <h3>Data Science dan Analytics</h3>
        <p>Integrasi statistika, programming, dan domain knowledge untuk ekstraksi insight dari data:</p>
        
        <ul>
          <li><strong>Exploratory Data Analysis (EDA):</strong>
            <p>- Descriptive statistics dan visualization</p>
            <p>- Pattern recognition dan anomaly detection</p>
            <p>- Data quality assessment</p>
          </li>
          <li><strong>Feature Engineering:</strong>
            <p>- Variable selection dan transformation</p>
            <p>- Handling missing data dan outliers</p>
            <p>- Creating derived variables</p>
          </li>
          <li><strong>Model Development:</strong>
            <p>- Model selection dan hyperparameter tuning</p>
            <p>- Cross-validation dan performance metrics</p>
            <p>- Ensemble methods dan model stacking</p>
          </li>
          <li><strong>Experimental Design:</strong>
            <p>- A/B testing dan multivariate testing</p>
            <p>- Causal inference methods</p>
            <p>- Statistical power analysis</p>
          </li>
        </ul>
        
        <h3>Big Data dan Computational Statistics</h3>
        <p>Tantangan dan solusi statistika dalam era big data:</p>
        
        <ul>
          <li><strong>Sampling Strategies:</strong>
            <p>- Reservoir sampling untuk streaming data</p>
            <p>- Stratified sampling untuk dataset besar</p>
            <p>- Adaptive sampling methods</p>
          </li>
          <li><strong>Distributed Computing:</strong>
            <p>- MapReduce framework untuk statistical computation</p>
            <p>- Parallel algorithms untuk matrix operations</p>
            <p>- Distributed machine learning (Apache Spark MLlib)</p>
          </li>
          <li><strong>Streaming Analytics:</strong>
            <p>- Online algorithms untuk real-time statistics</p>
            <p>- Sliding window techniques</p>
            <p>- Approximate algorithms (Count-Min Sketch, HyperLogLog)</p>
          </li>
          <li><strong>Scalable Statistical Methods:</strong>
            <p>- Stochastic gradient methods</p>
            <p>- Mini-batch processing</p>
            <p>- Approximation algorithms untuk large-scale inference</p>
          </li>
        </ul>
        
        <h3>Aplikasi Spesifik Bidang Lain</h3>
        <ul>
          <li><strong>Bioinformatics:</strong> Sequence analysis, gene expression, phylogenetics</li>
          <li><strong>Finance:</strong> Risk modeling, portfolio optimization, algorithmic trading</li>
          <li><strong>Healthcare:</strong> Clinical trials, epidemiology, medical imaging</li>
          <li><strong>Marketing:</strong> Customer segmentation, churn prediction, recommendation</li>
          <li><strong>Quality Control:</strong> Statistical process control, Six Sigma</li>
        </ul>
        
        <div class="references">
          <h4>Referensi</h4>
          <ol>
            <li>T. Hastie et al., "The Elements of Statistical Learning," 2nd ed., Springer, 2009.</li>
            <li>G. James et al., "An Introduction to Statistical Learning," 2nd ed., Springer, 2021.</li>
            <li>J. VanderPlas, "Python Data Science Handbook," O'Reilly, 2016.</li>
            <li>C. M. Bishop, "Pattern Recognition and Machine Learning," Springer, 2006.</li>
            <li>A. Gelman and J. Hill, "Data Analysis Using Regression and Multilevel/Hierarchical Models," Cambridge, 2007.</li>
            <li>J. Dean and S. Ghemawat, "MapReduce: Simplified Data Processing on Large Clusters," OSDI, 2004.</li>
          </ol>
        </div>
      `
    },
	{
	  id: 7,
      title: "7. Materi Lainnya",
      subtitle: "Topik tambahan dan pengembangan",
      content: `
        <h2>7. Materi Lainnya</h2>
        
        <h3>Statistika Multivariat</h3>
        <p>Analisis data dengan banyak variabel secara simultan untuk memahami struktur dan hubungan kompleks dalam data:</p>
        
        <ul>
          <li><strong>MANOVA (Multivariate ANOVA):</strong>
            <p>Ekstensi ANOVA untuk multiple dependent variables</p>
          </li>
          <li><strong>Principal Component Analysis (PCA):</strong>
            <p>Reduksi dimensi dengan mempertahankan varians maksimum</p>
          </li>
          <li><strong>Factor Analysis:</strong>
            <p>Mengidentifikasi faktor laten yang menjelaskan korelasi antar variabel</p>
          </li>
          <li><strong>Canonical Correlation Analysis:</strong>
            <p>Menganalisis hubungan antara dua set variabel</p>
          </li>
          <li><strong>Discriminant Analysis:</strong>
            <p>Klasifikasi berdasarkan kombinasi linear variabel prediktor</p>
          </li>
          <li><strong>Cluster Analysis:</strong>
            <p>Pengelompokan objek berdasarkan kemiripan karakteristik</p>
          </li>
          <li><strong>Multidimensional Scaling (MDS):</strong>
            <p>Visualisasi data high-dimensional dalam ruang lower-dimensional</p>
          </li>
        </ul>
        
        <h3>Time Series Analysis</h3>
        <p>Analisis data yang berurutan dalam waktu untuk memahami pola temporal dan membuat prediksi:</p>
        
        <ul>
          <li><strong>Komponen Time Series:</strong>
            <p>- Trend: Pola jangka panjang</p>
            <p>- Seasonality: Pola berulang dalam periode tertentu</p>
            <p>- Cyclical: Pola berulang tanpa periode tetap</p>
            <p>- Irregular: Komponen random</p>
          </li>
          <li><strong>ARIMA Models:</strong>
            <p>- AR (Autoregressive): Xt = φ₁Xt-1 + ... + φₚXt-p + εt</p>
            <p>- MA (Moving Average): Xt = εt + θ₁εt-1 + ... + θₚεt-q</p>
            <p>- Integration: Differencing untuk stationarity</p>
          </li>
          <li><strong>Forecasting Methods:</strong>
            <p>- Exponential smoothing</p>
            <p>- Holt-Winters method</p>
            <p>- State space models</p>
          </li>
          <li><strong>Advanced Models:</strong>
            <p>- GARCH untuk volatility modeling</p>
            <p>- Vector Autoregression (VAR)</p>
            <p>- Cointegration analysis</p>
          </li>
        </ul>
        
        <h3>Survival Analysis</h3>
        <p>Analisis waktu hingga kejadian tertentu terjadi (event time analysis):</p>
        
        <ul>
          <li><strong>Key Concepts:</strong>
            <p>- Survival function S(t) = P(T > t)</p>
            <p>- Hazard function h(t) = lim[P(t ≤ T < t+Δt|T ≥ t)/Δt]</p>
            <p>- Censoring: Right, left, interval censoring</p>
          </li>
          <li><strong>Non-parametric Methods:</strong>
            <p>- Kaplan-Meier estimator untuk survival curve</p>
            <p>- Log-rank test untuk comparing survival curves</p>
          </li>
          <li><strong>Semi-parametric Methods:</strong>
            <p>- Cox proportional hazards model</p>
            <p>- Partial likelihood estimation</p>
          </li>
          <li><strong>Parametric Methods:</strong>
            <p>- Exponential, Weibull, Log-normal models</p>
            <p>- Accelerated failure time models</p>
          </li>
        </ul>
        
        <h3>Statistika Non-parametrik Lanjutan</h3>
        <p>Metode robust yang tidak mengasumsikan distribusi parametrik tertentu:</p>
        
        <ul>
          <li><strong>Resampling Methods:</strong>
            <p>- Bootstrap untuk estimasi standard error dan confidence intervals</p>
            <p>- Jackknife untuk bias reduction</p>
            <p>- Permutation tests untuk exact p-values</p>
          </li>
          <li><strong>Rank-based Methods:</strong>
            <p>- Spearman correlation untuk monotonic relationships</p>
            <p>- Kendall's tau untuk concordance</p>
            <p>- Rank sum tests (Mann-Whitney, Kruskal-Wallis)</p>
          </li>
          <li><strong>Kernel Methods:</strong>
            <p>- Kernel density estimation</p>
            <p>- Non-parametric regression (local regression, splines)</p>
            <p>- Support vector machines</p>
          </li>
          <li><strong>Order Statistics:</strong>
            <p>- Quantile regression</p>
            <p>- Extreme value theory</p>
            <p>- Robust estimators (median, MAD)</p>
          </li>
        </ul>
        
        <h3>Computational Statistics</h3>
        <ul>
          <li><strong>Numerical Methods:</strong> Newton-Raphson, EM algorithm</li>
          <li><strong>Simulation Methods:</strong> Monte Carlo integration, importance sampling</li>
          <li><strong>Optimization:</strong> Maximum likelihood estimation, least squares</li>
          <li><strong>High-Performance Computing:</strong> Parallel processing untuk statistical computation</li>
        </ul>
        
        <div class="references">
          <h4>Referensi</h4>
          <ol>
            <li>R. A. Johnson and D. W. Wichern, "Applied Multivariate Statistical Analysis," 6th ed., Pearson, 2014.</li>
            <li>P. J. Brockwell and R. A. Davis, "Introduction to Time Series and Forecasting," 3rd ed., Springer, 2016.</li>
            <li>D. Collett, "Modelling Survival Data in Medical Research," 3rd ed., CRC Press, 2015.</li>
            <li>E. L. Lehmann and J. P. Romano, "Testing Statistical Hypotheses," 3rd ed., Springer, 2005.</li>
            <li>W. Härdle et al., "Nonparametric and Semiparametric Models," Springer, 2004.</li>
            <li>G. H. Givens and J. A. Hoeting, "Computational Statistics," 2nd ed., Wiley, 2013.</li>
          </ol>
        </div>
      `
    }
    ];
   
   saveToLocalStorage('materialsArray', materialsArray);
  }
  
  // Hitung next ID untuk tambah baru (global agar bisa diakses di addMaterial)
  window.nextMaterialId = materialsArray.length + 1;
  
  console.log('Materials loaded:', materialsArray.length, 'items');
}

// Konten untuk analysis tools (sekarang disimpan dalam objek global)
let analysisToolContents = {
'deskriptif': `
  <h2>Tool Analisis Statistik Deskriptif</h2>
  <p>Analisis komprehensif karakteristik data Anda dengan berbagai ukuran pemusatan, penyebaran, dan visualisasi grafik.</p>

  <div class="analysis-form">
    <h3>Input Data</h3>
    <div class="form-group">
      <label>Metode Input Data:</label>
      <select id="inputMethod_deskriptif" onchange="toggleInputMethod('deskriptif')">
        <option value="manual">Input Manual</option>
        <option value="sample">Gunakan Sample Data</option>
        <option value="file">Upload File (.csv, .xlsx)</option>
      </select>
    </div>

    <div class="form-group file-input-group_deskriptif" style="display:none;">
      <label>Upload File Data:</label>
      <input type="file" accept=".csv,.xlsx" id="dataFile_deskriptif" onchange="handleFileUpload('deskriptif')"/>
    </div>

    <div class="form-group manual-input-group_deskriptif">
      <label>Atau Input Data Manual (pisahkan dengan koma atau baris baru):</label>
      <textarea id="manualData_deskriptif" rows="6" placeholder="Contoh: 23, 45, 67, 34, 56, 78, 45, 67, 89, 23"></textarea>
    </div>

    <div class="form-group sample-input-group_deskriptif" style="display:none;">
      <label>Pilih Sample Data:</label>
      <select id="sampleData_deskriptif" onchange="loadSampleData('deskriptif')">
        <option value="">-- Pilih Sample --</option>
        <option value="sample1">Sample Data 1 (Penjualan)</option>
        <option value="sample2">Sample Data 2 (Tinggi Badan)</option>
      </select>
    </div>

    <div class="form-group">
      <label>Pilih Variabel untuk Analisis:</label>
      <select id="variables_deskriptif" multiple size="5">
        <option value="Data">Data</option>
      </select>
    </div>

    <button class="btn-primary" onclick="runDescriptive()">Analisis Deskriptif</button>

    <div id="descriptiveResults" style="margin-top: 20px;"></div>

    <!-- Container untuk Grafik (Pertama, tanpa dropdown) -->
    <div id="descriptiveChartContainer" style="margin-top: 20px; display: none;">
      <h4 id="chartTitle">Visualisasi Grafik</h4>
      <div class="chart-container" id="descriptiveChart"></div>
    </div>

    <!-- **PERBAIKAN: Dropdown Dipindah ke Bawah Grafik (Awalnya Hidden)** -->
    <div id="chartSelectorContainer_deskriptif" class="form-group" style="margin-top: 15px; display: none;">
      <label>Pilih Jenis Visualisasi Grafik:</label>
      <select id="chartType_deskriptif" disabled>
        <option value="histogram">Histogram (Default)</option>
        <option value="line">Line Chart</option>
        <option value="pie">Pie Chart</option>
        <option value="bar">Bar Chart</option>
        <option value="ogive">Ogive (Kumulatif)</option>
        <option value="boxplot">Box Plot</option>
        <option value="stemleaf">Stem-and-Leaf Plot</option>
      </select>
      <small>Pilih grafik untuk update visualisasi secara langsung setelah analisis.</small>
    </div>
  </div>
`,
      
    'uji-mean': `
      <h2>Tool Uji t (t-Test)</h2>
      <p>Uji hipotesis untuk rata-rata populasi dengan berbagai variasi uji t.</p>
      
      <div class="analysis-form">
        <h3>Input Data</h3>
        <div class="form-group">
          <label>Metode Input Data:</label>
          <select id="inputMethod_uji-mean" onchange="toggleInputMethod('uji-mean')">
            <option value="manual">Input Manual</option>
            <option value="sample">Gunakan Sample Data</option>
            <option value="file">Upload File (.csv, .xlsx)</option>
          </select>
        </div>
        
        <div class="form-group file-input-group_uji-mean" style="display:none;">
          <label>Upload File Data:</label>
          <input type="file" accept=".csv,.xlsx" id="dataFile_uji-mean" onchange="handleFileUpload('uji-mean')"/>
        </div>
        
        <div class="form-group sample-input-group_uji-mean" style="display:none;">
          <label>Pilih Sample Data:</label>
          <select id="sampleData_uji-mean" onchange="loadSampleData('uji-mean')">
            <option value="">-- Pilih Sample --</option>
            <option value="sample_one_sample">One-sample t-test (Data A)</option>
            <option value="sample_two_sample">Two-sample t-test (Data A & B)</option>
            <option value="sample_paired">Paired t-test (Pre & Post)</option>
          </select>
        </div>

        <h3>Pengaturan Uji t</h3>
        <div class="form-group">
          <label>Jenis Uji t:</label>
          <select id="tTestType" onchange="updateTTestForm()">
            <option value="one-sample">One-sample t-test</option>
            <option value="two-sample">Independent two-sample t-test</option>
            <option value="paired">Paired t-test</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Tingkat Signifikansi (α):</label>
          <select id="alpha">
            <option value="0.01">0.01 (99% confidence)</option>
            <option value="0.05" selected>0.05 (95% confidence)</option>
            <option value="0.10">0.10 (90% confidence)</option>
          </select>
        </div>
        
        <div class="form-group manual-input-group_uji-mean">
          <label>Data Sampel 1 (pisahkan dengan koma atau baris baru):</label>
          <textarea id="sample1_tTest" rows="4" placeholder="Contoh: 23, 45, 67, 34, 56"></textarea>
        </div>
        
        <div class="form-group" id="sample2Group_tTest" style="display:none;">
          <label>Data Sampel 2 (pisahkan dengan koma atau baris baru):</label>
          <textarea id="sample2_tTest" rows="4" placeholder="Contoh: 30, 50, 70, 40, 60"></textarea>
        </div>
        
        <div class="form-group" id="muGroup_tTest">
          <label>Nilai μ₀ (untuk one-sample test):</label>
          <input type="number" id="mu0_tTest" value="0" step="0.01"/>
        </div>
        
        <button class="btn-primary" onclick="runTTest()">Hitung Uji t</button>
        
        <div id="tTestResults" style="margin-top: 20px;"></div>
      </div>
    `,
    
    'anova': `
      <h2>Tool Analisis Varians (ANOVA)</h2>
      <p>Uji perbedaan rata-rata antar kelompok untuk tiga atau lebih kelompok.</p>
      
      <div class="analysis-form">
        <h3>Input Data</h3>
        <div class="form-group">
          <label>Metode Input Data:</label>
          <select id="inputMethod_anova" onchange="toggleInputMethod('anova')">
            <option value="manual">Input Manual</option>
            <option value="sample">Gunakan Sample Data</option>
            <option value="file">Upload File (.csv, .xlsx)</option>
          </select>
        </div>
        
        <div class="form-group file-input-group_anova" style="display:none;">
          <label>Upload File Data:</label>
          <input type="file" accept=".csv,.xlsx" id="dataFile_anova" onchange="handleFileUpload('anova')"/>
        </div>
        
        <div class="form-group sample-input-group_anova" style="display:none;">
          <label>Pilih Sample Data:</label>
          <select id="sampleData_anova" onchange="loadSampleData('anova')">
            <option value="">-- Pilih Sample --</option>
            <option value="sample_one_way">One-way ANOVA (3 Kelompok)</option>
          </select>
        </div>

        <h3>Pengaturan ANOVA</h3>
        <div class="form-group">
          <label>Jenis ANOVA:</label>
          <select id="anovaType">
            <option value="one-way">One-way ANOVA</option>
            <!-- <option value="two-way">Two-way ANOVA</option> -->
            <!-- <option value="repeated">Repeated Measures ANOVA</option> -->
          </select>
        </div>
        
        <div class="form-group manual-input-group_anova">
          <label>Input Data Kelompok (pisahkan nilai dengan koma, kelompok dengan baris baru):</label>
          <textarea id="anovaData" rows="8" placeholder="Format data:
Kelompok1: 23, 45, 67, 34, 56
Kelompok2: 34, 56, 78, 45, 67
Kelompok3: 45, 67, 89, 56, 78"></textarea>
        </div>
        
        <div class="form-group">
          <label>Tingkat Signifikansi (α):</label>
          <select id="alpha_anova">
            <option value="0.01">0.01 (99% confidence)</option>
            <option value="0.05" selected>0.05 (95% confidence)</option>
            <option value="0.10">0.10 (90% confidence)</option>
          </select>
        </div>

        <div class="form-group">
          <label>Post-hoc Test (jika ANOVA signifikan):</label>
          <select id="posthoc_anova">
            <option value="none">Tidak ada</option>
            <option value="tukey">Tukey HSD</option>
            <!-- <option value="bonferroni">Bonferroni</option> -->
            <!-- <option value="scheffe">Scheffé</option> -->
          </select>
        </div>
        
        <button class="btn-primary" onclick="runANOVA()">Analisis ANOVA</button>
        
        <div id="anovaResults" style="margin-top: 20px;"></div>
      </div>
    `,
    
    'korelasi': `
      <h2>Tool Analisis Korelasi</h2>
      <p>Menganalisis kekuatan dan arah hubungan antara dua atau lebih variabel.</p>
      
      <div class="analysis-form">
        <h3>Input Data</h3>
        <div class="form-group">
          <label>Metode Input Data:</label>
          <select id="inputMethod_korelasi" onchange="toggleInputMethod('korelasi')">
            <option value="manual">Input Manual</option>
            <option value="sample">Gunakan Sample Data</option>
            <option value="file">Upload File (.csv, .xlsx)</option>
          </select>
        </div>
        
        <div class="form-group file-input-group_korelasi" style="display:none;">
          <label>Upload File Data:</label>
          <input type="file" accept=".csv,.xlsx" id="dataFile_korelasi" onchange="handleFileUpload('korelasi')"/>
        </div>
        
        <div class="form-group sample-input-group_korelasi" style="display:none;">
          <label>Pilih Sample Data:</label>
          <select id="sampleData_korelasi" onchange="loadSampleData('korelasi')">
            <option value="">-- Pilih Sample --</option>
            <option value="sample_pearson">Pearson Correlation (X & Y)</option>
          </select>
        </div>

        <h3>Pengaturan Analisis Korelasi</h3>
        <div class="form-group">
          <label>Jenis Korelasi:</label>
          <select id="correlationType">
            <option value="pearson">Pearson (Linear correlation)</option>
            <option value="spearman">Spearman (Rank correlation)</option>
            <!-- <option value="kendall">Kendall's Tau</option> -->
          </select>
        </div>
        
        <div class="form-group manual-input-group_korelasi">
          <label>Data Variabel X (pisahkan dengan koma atau baris baru):</label>
          <textarea id="varX_korelasi" rows="3" placeholder="Contoh: 10, 12, 15, 18, 20"></textarea>
        </div>
        
        <div class="form-group manual-input-group_korelasi">
          <label>Data Variabel Y (pisahkan dengan koma atau baris baru):</label>
          <textarea id="varY_korelasi" rows="3" placeholder="Contoh: 25, 28, 30, 35, 38"></textarea>
        </div>
        
        <div class="form-group">
          <label>Tingkat Signifikansi (α):</label>
          <select id="corrAlpha">
            <option value="0.01">0.01</option>
            <option value="0.05" selected>0.05</option>
            <option value="0.10">0.10</option>
          </select>
        </div>
        
        <button class="btn-primary" onclick="runCorrelation()">Hitung Korelasi</button>
        
        <div id="correlationResults" style="margin-top: 20px;"></div>
      </div>
    `,
    
    'regresi': `
      <h2>Tool Analisis Regresi Linear</h2>
      <p>Memodelkan hubungan antara variabel dependen dan satu atau lebih variabel independen.</p>
      
      <div class="analysis-form">
        <h3>Input Data</h3>
        <div class="form-group">
          <label>Metode Input Data:</label>
          <select id="inputMethod_regresi" onchange="toggleInputMethod('regresi')">
            <option value="manual">Input Manual</option>
            <option value="sample">Gunakan Sample Data</option>
            <option value="file">Upload File (.csv, .xlsx)</option>
          </select>
        </div>
        
        <div class="form-group file-input-group_regresi" style="display:none;">
          <label>Upload File Data:</label>
          <input type="file" accept=".csv,.xlsx" id="dataFile_regresi" onchange="handleFileUpload('regresi')"/>
        </div>
        
        <div class="form-group sample-input-group_regresi" style="display:none;">
          <label>Pilih Sample Data:</label>
          <select id="sampleData_regresi" onchange="loadSampleData('regresi')">
            <option value="">-- Pilih Sample --</option>
            <option value="sample_simple_linear">Simple Linear Regression (X & Y)</option>
          </select>
        </div>

        <h3>Pengaturan Regresi</h3>
        <div class="form-group">
          <label>Jenis Regresi:</label>
          <select id="regressionType">
            <option value="simple">Simple Linear Regression</option>
            <!-- <option value="multiple">Multiple Linear Regression</option> -->
            <!-- <option value="polynomial">Polynomial Regression</option> -->
          </select>
        </div>
        
        <div class="form-group manual-input-group_regresi">
          <label>Variabel Dependen (Y) (pisahkan dengan koma atau baris baru):</label>
          <textarea id="dependentVar_regresi" rows="3" placeholder="Contoh: 25, 28, 30, 35, 38"></textarea>
        </div>
        
        <div class="form-group manual-input-group_regresi">
          <label>Variabel Independen (X) (pisahkan dengan koma atau baris baru):</label>
          <textarea id="independentVar_regresi" rows="3" placeholder="Contoh: 10, 12, 15, 18, 20"></textarea>
        </div>
        
        <div class="form-group">
          <label>Confidence Level:</label>
          <select id="confLevel">
            <option value="90">90%</option>
            <option value="95" selected>95%</option>
            <option value="99">99%</option>
          </select>
        </div>
        
        <div class="form-group">
          <input type="checkbox" id="includeResiduals"/>
          <label for="includeResiduals">Tampilkan analisis residual</label>
        </div>
        
        <button class="btn-primary" onclick="runRegression()">Analisis Regresi</button>
        
        <div id="regressionResults" style="margin-top: 20px;"></div>
      </div>
    `,
    'mann-whitney': `
      <h2>Tool Uji Mann-Whitney U</h2>
      <p>Uji non-parametrik untuk membandingkan dua kelompok independen.</p>
      <div class="analysis-form">
        <h3>Input Data</h3>
        <div class="form-group">
          <label>Metode Input Data:</label>
          <select id="inputMethod_mann-whitney" onchange="toggleInputMethod('mann-whitney')">
            <option value="manual">Input Manual</option>
            <option value="sample">Gunakan Sample Data</option>
            <option value="file">Upload File (.csv, .xlsx)</option>
          </select>
        </div>
        
        <div class="form-group file-input-group_mann-whitney" style="display:none;">
          <label>Upload File Data:</label>
          <input type="file" accept=".csv,.xlsx" id="dataFile_mann-whitney" onchange="handleFileUpload('mann-whitney')"/>
        </div>
        
        <div class="form-group sample-input-group_mann-whitney" style="display:none;">
          <label>Pilih Sample Data:</label>
          <select id="sampleData_mann-whitney" onchange="loadSampleData('mann-whitney')">
            <option value="">-- Pilih Sample --</option>
            <option value="sample_two_groups">Dua Kelompok Independen</option>
          </select>
        </div>

        <h3>Pengaturan Uji Mann-Whitney U</h3>
        <div class="form-group manual-input-group_mann-whitney">
          <label>Data Kelompok 1 (pisahkan dengan koma atau baris baru):</label>
          <textarea id="group1_mannwhitney" rows="4" placeholder="Contoh: 10, 12, 15, 11, 13"></textarea>
        </div>
        <div class="form-group manual-input-group_mann-whitney">
          <label>Data Kelompok 2 (pisahkan dengan koma atau baris baru):</label>
          <textarea id="group2_mannwhitney" rows="4" placeholder="Contoh: 14, 16, 13, 17, 15"></textarea>
        </div>
        <div class="form-group">
          <label>Tingkat Signifikansi (α):</label>
          <select id="alpha_mannwhitney">
            <option value="0.01">0.01</option>
            <option value="0.05" selected>0.05</option>
            <option value="0.10">0.10</option>
          </select>
        </div>
        <button class="btn-primary" onclick="runMannWhitney()">Hitung Mann-Whitney U</button>
        <div id="mannWhitneyResults" style="margin-top: 20px;"></div>
      </div>
    `,
    'chi-square': `
      <h2>Tool Uji Chi-Square</h2>
      <p>Uji untuk menganalisis hubungan antara variabel kategorikal (uji independensi) atau kesesuaian distribusi (goodness of fit).</p>
      <div class="analysis-form">
        <h3>Input Data</h3>
        <div class="form-group">
          <label>Metode Input Data:</label>
          <select id="inputMethod_chi-square" onchange="toggleInputMethod('chi-square')">
            <option value="manual">Input Manual</option>
            <option value="sample">Gunakan Sample Data</option>
            <option value="file">Upload File (.csv, .xlsx)</option>
          </select>
        </div>
        
        <div class="form-group file-input-group_chi-square" style="display:none;">
          <label>Upload File Data:</label>
          <input type="file" accept=".csv,.xlsx" id="dataFile_chi-square" onchange="handleFileUpload('chi-square')"/>
        </div>
        
        <div class="form-group sample-input-group_chi-square" style="display:none;">
          <label>Pilih Sample Data:</label>
          <select id="sampleData_chi-square" onchange="loadSampleData('chi-square')">
            <option value="">-- Pilih Sample --</option>
            <option value="sample_independence">Uji Independensi (Tabel 2x2)</option>
            <option value="sample_goodness_of_fit">Uji Goodness of Fit (3 Kategori)</option>
          </select>
        </div>

        <h3>Pengaturan Uji Chi-Square</h3>
        <div class="form-group">
          <label>Jenis Uji Chi-Square:</label>
          <select id="chiSquareType" onchange="updateChiSquareForm()">
            <option value="independence">Uji Independensi (Tabel Kontingensi)</option>
            <option value="goodness-of-fit">Uji Goodness of Fit</option>
          </select>
        </div>
        <div class="form-group manual-input-group_chi-square" id="contingencyTableGroup">
          <label>Input Tabel Kontingensi (pisahkan nilai dengan koma, baris dengan baris baru):</label>
          <textarea id="contingencyTable" rows="6" placeholder="Contoh (2x2):
10, 20
15, 5"></textarea>
          <small>Pastikan jumlah kolom konsisten untuk setiap baris.</small>
        </div>
        <div class="form-group manual-input-group_chi-square" id="goodnessOfFitGroup" style="display:none;">
          <label>Input Frekuensi Observasi (pisahkan dengan koma):</label>
          <textarea id="observedFrequencies" rows="3" placeholder="Contoh: 20, 30, 50"></textarea>
          <label>Input Frekuensi Harapan (pisahkan dengan koma, opsional, jika tidak diisi akan dianggap sama rata):</label>
          <textarea id="expectedFrequencies" rows="3" placeholder="Contoh: 25, 25, 50"></textarea>
        </div>
        <div class="form-group">
          <label>Tingkat Signifikansi (α):</label>
          <select id="alpha_chiSquare">
            <option value="0.01">0.01</option>
            <option value="0.05" selected>0.05</option>
            <option value="0.10">0.10</option>
          </select>
        </div>
        <button class="btn-primary" onclick="runChiSquare()">Hitung Chi-Square</button>
        <div id="chiSquareResults" style="margin-top: 20px;"></div>
      </div>
    `,
    'clustering': `
      <h2>Tool Clustering (K-Means)</h2>
      <p>Mengelompokkan data ke dalam K kelompok berdasarkan kemiripan.</p>
      <div class="analysis-form">
        <h3>Input Data</h3>
        <div class="form-group">
          <label>Metode Input Data:</label>
          <select id="inputMethod_clustering" onchange="toggleInputMethod('clustering')">
            <option value="manual">Input Manual</option>
            <option value="sample">Gunakan Sample Data</option>
            <option value="file">Upload File (.csv, .xlsx)</option>
          </select>
        </div>
        
        <div class="form-group file-input-group_clustering" style="display:none;">
          <label>Upload File Data:</label>
          <input type="file" accept=".csv,.xlsx" id="dataFile_clustering" onchange="handleFileUpload('clustering')"/>
        </div>
        
        <div class="form-group sample-input-group_clustering" style="display:none;">
          <label>Pilih Sample Data:</label>
          <select id="sampleData_clustering" onchange="loadSampleData('clustering')">
            <option value="">-- Pilih Sample --</option>
            <option value="sample_2d">Data 2 Dimensi</option>
          </select>
        </div>

        <h3>Pengaturan K-Means Clustering</h3>
        <div class="form-group manual-input-group_clustering">
          <label>Input Data (pisahkan nilai dengan koma, observasi dengan baris baru):</label>
          <textarea id="clusteringData" rows="8" placeholder="Contoh (data 2 dimensi):
1.0, 1.1
1.0, 1.2
3.0, 3.1
3.1, 3.0"></textarea>
          <small>Setiap baris adalah satu observasi, setiap kolom adalah satu fitur.</small>
        </div>
        <div class="form-group">
          <label>Jumlah Kluster (K):</label>
          <input type="number" id="numClusters" value="3" min="2"/>
        </div>
        <button class="btn-primary" onclick="runClustering()">Jalankan Clustering</button>
        <div id="clusteringResults" style="margin-top: 20px;"></div>
      </div>
    `,
    'factor-analysis': `
      <h2>Tool Factor Analysis (Analisis Faktor)</h2>
      <p>Mengidentifikasi faktor laten yang menjelaskan korelasi antar variabel yang diamati.</p>
      <div class="analysis-form">
        <h3>Input Data</h3>
        <div class="form-group">
          <label>Metode Input Data:</label>
          <select id="inputMethod_factor-analysis" onchange="toggleInputMethod('factor-analysis')">
            <option value="manual">Input Manual</option>
            <option value="sample">Gunakan Sample Data</option>
            <option value="file">Upload File (.csv, .xlsx)</option>
          </select>
        </div>
        
        <div class="form-group file-input-group_factor-analysis" style="display:none;">
          <label>Upload File Data:</label>
          <input type="file" accept=".csv,.xlsx" id="dataFile_factor-analysis" onchange="handleFileUpload('factor-analysis')"/>
        </div>
        
        <div class="form-group sample-input-group_factor-analysis" style="display:none;">
          <label>Pilih Sample Data:</label>
          <select id="sampleData_factor-analysis" onchange="loadSampleData('factor-analysis')">
            <option value="">-- Pilih Sample --</option>
            <option value="sample_3vars">Data 3 Variabel</option>
          </select>
        </div>

        <h3>Pengaturan Analisis Faktor</h3>
        <div class="form-group manual-input-group_factor-analysis">
          <label>Input Data (pisahkan nilai dengan koma, observasi dengan baris baru):</label>
          <textarea id="factorAnalysisData" rows="8" placeholder="Contoh (data 3 variabel):
10, 12, 11
15, 14, 16
20, 22, 21"></textarea>
          <small>Setiap baris adalah satu observasi, setiap kolom adalah satu variabel.</small>
        </div>
        <div class="form-group">
          <label>Jumlah Faktor yang Diekstrak:</label>
          <input type="number" id="numFactors" value="1" min="1"/>
        </div>
        <button class="btn-primary" onclick="runFactorAnalysis()">Jalankan Analisis Faktor</button>
        <div id="factorAnalysisResults" style="margin-top: 20px;"></div>
      </div>
    `,
    'uji-asumsi': `
      <h2>Tool Uji Asumsi Klasik</h2>
      <p>Melakukan pengujian asumsi normalitas, homogenitas varians, dan linearitas.</p>
      <div class="analysis-form">
        <h3>Input Data</h3>
        <div class="form-group">
          <label>Metode Input Data:</label>
          <select id="inputMethod_uji-asumsi" onchange="toggleInputMethod('uji-asumsi')">
            <option value="manual">Input Manual</option>
            <option value="sample">Gunakan Sample Data</option>
            <option value="file">Upload File (.csv, .xlsx)</option>
          </select>
        </div>
        
        <div class="form-group file-input-group_uji-asumsi" style="display:none;">
          <label>Upload File Data:</label>
          <input type="file" accept=".csv,.xlsx" id="dataFile_uji-asumsi" onchange="handleFileUpload('uji-asumsi')"/>
        </div>
        
        <div class="form-group sample-input-group_uji-asumsi" style="display:none;">
          <label>Pilih Sample Data:</label>
          <select id="sampleData_uji-asumsi" onchange="loadSampleData('uji-asumsi')">
            <option value="">-- Pilih Sample --</option>
            <option value="sample_normalitas">Uji Normalitas</option>
            <option value="sample_homogenitas">Uji Homogenitas</option>
          </select>
        </div>

        <h3>Pengaturan Uji Asumsi</h3>
        <div class="form-group">
          <label>Pilih Uji Asumsi:</label>
          <select id="assumptionTestType" onchange="updateAssumptionTestForm()">
            <option value="normalitas">Uji Normalitas (Shapiro-Wilk)</option>
            <option value="homogenitas">Uji Homogenitas Varians (Levene's Test)</option>
            <!-- <option value="linearitas">Uji Linearitas</option> -->
          </select>
        </div>
        <div class="form-group manual-input-group_uji-asumsi" id="normalitasDataGroup">
          <label>Input Data untuk Normalitas (pisahkan dengan koma atau baris baru):</label>
          <textarea id="normalitasData" rows="4" placeholder="Contoh: 23, 45, 67, 34, 56, 78, 45, 67, 89, 23"></textarea>
        </div>
        <div class="form-group manual-input-group_uji-asumsi" id="homogenitasDataGroup" style="display:none;">
          <label>Input Data Kelompok untuk Homogenitas (pisahkan nilai dengan koma, kelompok dengan baris baru):</label>
          <textarea id="homogenitasData" rows="6" placeholder="Contoh:
Kelompok1: 23, 45, 67
Kelompok2: 34, 56, 78"></textarea>
        </div>
        <div class="form-group">
          <label>Tingkat Signifikansi (α):</label>
          <select id="alpha_assumption">
            <option value="0.01">0.01</option>
            <option value="0.05" selected>0.05</option>
            <option value="0.10">0.10</option>
          </select>
        </div>
        <button class="btn-primary" onclick="runAssumptionTest()">Jalankan Uji Asumsi</button>
        <div id="assumptionTestResults" style="margin-top: 20px;"></div>
      </div>
    `,
    'uji-instrumen': `
      <h2>Tool Uji Validitas & Reliabilitas</h2>
      <p>Menguji kualitas instrumen penelitian (kuesioner).</p>
      <div class="analysis-form">
        <h3>Input Data</h3>
        <div class="form-group">
          <label>Metode Input Data:</label>
          <select id="inputMethod_uji-instrumen" onchange="toggleInputMethod('uji-instrumen')">
            <option value="manual">Input Manual</option>
            <option value="sample">Gunakan Sample Data</option>
            <option value="file">Upload File (.csv, .xlsx)</option>
          </select>
        </div>
        
        <div class="form-group file-input-group_uji-instrumen" style="display:none;">
          <label>Upload File Data:</label>
          <input type="file" accept=".csv,.xlsx" id="dataFile_uji-instrumen" onchange="handleFileUpload('uji-instrumen')"/>
        </div>
        
        <div class="form-group sample-input-group_uji-instrumen" style="display:none;">
          <label>Pilih Sample Data:</label>
          <select id="sampleData_uji-instrumen" onchange="loadSampleData('uji-instrumen')">
            <option value="">-- Pilih Sample --</option>
            <option value="sample_instrument">Data Kuesioner (3 Item)</option>
          </select>
        </div>

        <h3>Pengaturan Uji Instrumen</h3>
        <div class="form-group manual-input-group_uji-instrumen">
          <label>Input Data Respon Kuesioner (pisahkan nilai dengan koma, responden dengan baris baru):</label>
          <textarea id="instrumentData" rows="8" placeholder="Contoh (3 item, 5 responden):
1, 2, 3
2, 3, 4
3, 4, 5
4, 5, 4
5, 4, 3"></textarea>
          <small>Setiap baris adalah satu responden, setiap kolom adalah satu item pertanyaan.</small>
        </div>
        <div class="form-group">
          <label>Tingkat Signifikansi (α) untuk Validitas:</label>
          <select id="alpha_validity">
            <option value="0.01">0.01</option>
            <option value="0.05" selected>0.05</option>
            <option value="0.10">0.10</option>
          </select>
        </div>
        <button class="btn-primary" onclick="runInstrumentTest()">Jalankan Uji Instrumen</button>
        <div id="instrumentTestResults" style="margin-top: 20px;"></div>
      </div>
    `,
'Sample Size': `
  <h2>Menetukan Ukuran Sampel</h2>
  <p>Menentukan ukuran sampel yang diperlukan atau kekuatan uji statistik. Gunakan accordion di bawah untuk navigasi submenu.</p>
  
  <details>
    <summary>nCalculator</summary>
    <div class="analysis-section" style="margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
      <h3>nCalculator</h3>
      <p>Hitung ukuran sampel berdasarkan rumus Slovin, Cochran, dan Lemeshow.</p>
      <div class="form-group">
        <label for="populasi">Ukuran Populasi (N):</label>
        <input type="number" id="populasi" value="1000" min="1" placeholder="Contoh: 1000">
      </div>
      <div class="form-group">
        <label for="margin-error">Margin Error (e, %):</label>
        <input type="number" id="margin-error" value="5" min="1" max="20" step="0.5" placeholder="Contoh: 5">
      </div>
      <div class="form-group">
        <label for="confidence">Confidence Level:</label>
        <select id="confidence">
          <option value="90">90% (Z=1.645)</option>
          <option value="95" selected>95% (Z=1.96)</option>
          <option value="99">99% (Z=2.576)</option>
        </select>
      </div>
      <div class="form-group">
        <label for="proporsi">Proporsi Estimasi (p, 0-1):</label>
        <input type="number" id="proporsi" value="0.5" min="0" max="1" step="0.1" placeholder="Default: 0.5">
      </div>
      <button class="btn-primary" onclick="calculateSampleSizeAll()" style="margin-bottom: 20px;">Hitung Sample Size</button>
      <div id="sample-output">
        <h4>Hasil Perhitungan:</h4>
        <table id="sample-table" style="width: 100%; border-collapse: collapse; font-size: 14px;">
          <thead><tr style="background: #f0f0f0;"><th style="border: 1px solid #ddd; padding: 8px;">Rumus</th><th style="border: 1px solid #ddd; padding: 8px;">Ukuran Sampel (n)</th><th style="border: 1px solid #ddd; padding: 8px;">Penjelasan</th></tr></thead>
          <tbody><!-- Diisi JS --></tbody>
        </table>
      </div>
      <div class="references" style="margin-top: 20px; font-size: 12px;">
        <h4>Referensi:</h4>
        <ul>
          <li>Slovin: Populasi terbatas.</li>
          <li>Cochran: Estimasi proporsi.</li>
          <li>Lemeshow: Survei kesehatan (Lemeshow et al., 1990).</li>
        </ul>
      </div>
    </div>
  </details>
  
  <details>
    <summary>Power Sample</summary>
    <div class="analysis-form" style="margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
      <h3>Power Sample</h3>
      <div class="form-group">
        <label>Jenis Uji:</label>
        <select id="powerTestType" onchange="updatePowerAnalysisForm()">
          <option value="t-test">Uji t (Two-sample)</option>
          <option value="anova">ANOVA (One-way)</option>
          <option value="correlation">Korelasi Pearson</option>
          <option value="regression">Regresi Linear Sederhana</option>
        </select>
      </div>
      <div class="form-group">
        <label id="effectSizeLabel">Ukuran Efek (Cohen's d):</label>
        <input type="number" id="effectSize" value="0.5" step="0.1"/>
        <small id="effectSizeHint">0.2 (kecil), 0.5 (sedang), 0.8 (besar)</small>
      </div>
      <div class="form-group">
        <label>Tingkat Signifikansi (α):</label>
        <select id="alpha_power">
          <option value="0.01">0.01</option>
          <option value="0.05" selected>0.05</option>
          <option value="0.10">0.10</option>
        </select>
      </div>
      <div class="form-group">
        <label>Power yang Diinginkan (1-β):</label>
        <input type="number" id="desiredPower" value="0.8" step="0.05" min="0.5" max="0.99"/>
      </div>
      <button class="btn-primary" onclick="runPowerAnalysis()">Hitung Power</button>
      <div id="powerAnalysisResults" style="margin-top: 20px;"></div>
    </div>
  </details>
  
  <details>
    <summary>RN Generator</summary>
    <div class="analysis-section" style="margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
      <h3>Random Number Generator (RNG)</h3>
      <p>Generate nomor acak untuk sampel terpilih dari populasi (1 sampai N). Gunakan setelah hitung ukuran sampel di atas.</p>
      <div class="form-group">
        <label for="populasi-rng">Ukuran Populasi (N):</label>
        <input type="number" id="populasi-rng" value="1000" min="1" max="10000" placeholder="Contoh: 1000">
      </div>
      <div class="form-group">
        <label for="sampel-rng">Ukuran Sampel (n):</label>
        <input type="number" id="sampel-rng" value="100" min="1" placeholder="Contoh: 100 (harus ≤ N)">
      </div>
      <div class="form-group">
        <label>
          <input type="checkbox" id="with-replacement" style="margin-right: 5px;"> Izinkan Pengulangan (Dengan Replacement)
        </label>
      </div>
      <div class="form-group">
        <label>
          <input type="checkbox" id="sort-results" checked style="margin-right: 5px;"> Urutkan Hasil (Ascending)
        </label>
      </div>
      <button class="btn-primary" onclick="generateRandomSample()" style="margin-bottom: 20px;">Generate Nomor Acak</button>
      <button class="btn-secondary" onclick="generateRandomSample(true)" style="margin-left: 10px;">Generate Baru (Random Ulang)</button>
      
      <div id="rng-output">
        <h4>Hasil Nomor Sampel Acak:</h4>
        <div id="random-numbers-list" style="background: #f8f9fa; padding: 10px; border-radius: 5px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px;">
          <!-- Daftar nomor akan diisi oleh JS -->
        </div>
        <p id="rng-stats" style="margin-top: 10px; font-weight: bold; color: #28a745;"></p>
      </div>
      
      <div class="references" style="margin-top: 20px; font-size: 12px;">
        <h4>Referensi Metode:</h4>
        <ul>
          <li><strong>Tanpa Pengulangan:</strong> Fisher-Yates Shuffle (algoritma acak unik).</li>
          <li><strong>Dengan Pengulangan:</strong> Random independen (boleh duplikat).</li>
          <li>Nomor: 1 sampai N. Gunakan untuk sampling acak sederhana.</li>
        </ul>
      </div>
    </div>
  </details>
`
  };
  
  let currentDescriptiveData = [];

// Initial content for the welcome page
let initialWelcomeContent = ''; // Will be set after DOMContentLoaded

// Whiteboard Variables (Global)
let canvas, ctx, isDrawing = false, isErasing = false, isTextMode = false;
let currentColor = '#0000FF', currentLineWidth = 2;
let startX, startY, textX, textY;
let toolActive = 'pen'; // Default tool
let isDragging = false;  // Status dragging
let selectedObject = null;  // Objek yang dipilih (index di objects array)
let dragOffsetX = 0;  // Offset X untuk drag
let dragOffsetY = 0;  // Offset Y untuk drag
let objects = [];  // Array untuk menyimpan semua objek dengan urutan (strokes, texts, images, erases)
let lastMouseX = 0;
let lastMouseY = 0;
let currentStroke = null;  // Stroke yang sedang digambar
let currentErase = null;  // Erase stroke yang sedang digambar
let undoStack = [];
let redoStack = [];
let tempText = '';  // Untuk teks sementara saat mengetik

// Tambahan variabel untuk resize
let resizingObject = null;  // Index objek yang sedang di-resize
let resizeHandle = null;    // Handle resize (misalnya, posisi sudut)
let isResizing = false;     // Status apakah sedang resize
let resizeStartX = 0;       // Posisi awal mouse untuk resize
let resizeStartY = 0;
let originalSize = { width: 0, height: 0, fontSize: 0 };

// Tambahan: Elemen untuk menu konteks (ditambahkan secara dinamis)
let contextMenu = null;
let longPressTimer = null;
let isLongPress = false;
let copiedObject = null;
let selectedObjects = []; // Array untuk objek yang dipilih (multiple)
let copiedObjects = []; // Array untuk objek yang di-copy (multiple)
let initialDistance = 0

// Initialize Whiteboard when shown
function initWhiteboard() {
  canvas = document.getElementById('whiteboard-canvas');
  if (!canvas) return;
  ctx = canvas.getContext('2d');
  
  // Deklarasi variabel global yang hilang (jika belum ada)
  let lastMouseX = 0;
  let lastMouseY = 0;
  let longPressTimer = null;
  let isLongPress = false;
  let touchMoved = false;
  let initialDistance = 0;
  let originalSize = null;
  
  // Resize canvas to fit container
  function resizeCanvas() {
    const container = canvas.parentElement;
    canvas.width = container.clientWidth;
    canvas.height = container.clientHeight;
    redrawCanvas();  // Redraw setelah resize
  }
  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);

  // Event Listeners for Tools
  document.getElementById('pen-tool').addEventListener('click', () => selectTool('pen'));
  document.getElementById('select-tool').addEventListener('click', () => selectTool('select'));
  document.getElementById('text-tool').addEventListener('click', () => selectTool('text'));
  document.getElementById('eraser-tool').addEventListener('click', () => selectTool('erase'));
  
  // Color Change
  document.getElementById('color-picker').addEventListener('change', (e) => {
    currentColor = e.target.value;
    document.getElementById('color-input').value = currentColor;
  });
  document.getElementById('color-input').addEventListener('change', (e) => {
    currentColor = e.target.value;
    document.getElementById('color-picker').value = currentColor;
  });
  
  // Line Width
  document.getElementById('line-width').addEventListener('input', (e) => {
    currentLineWidth = e.target.value;
    document.getElementById('line-width-value').textContent = currentLineWidth + 'px';
  });
  
  // Text Input
  const textInput = document.getElementById('text-input');
  textInput.addEventListener('input', (e) => {
    tempText = e.target.value;  // Update teks sementara
    redrawCanvas();  // Redraw untuk menampilkan teks real-time
  });
  textInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      addTextFromInput();  // Konfirmasi dan simpan teks
      e.target.style.display = 'none';
      document.getElementById('text-cursor').style.display = 'none';
      isTextMode = false;
    } else if (e.key === 'Escape') {
      // Batal tanpa menambah teks
      textInput.value = '';
      tempText = '';
      textInput.style.display = 'none';
      document.getElementById('text-cursor').style.display = 'none';
      isTextMode = false;
      redrawCanvas();  // Redraw untuk menghapus teks sementara
    }
  });

  // Tambahkan event blur untuk menambah teks jika ada isi
  textInput.addEventListener('blur', () => {
    if (isTextMode && tempText.trim()) {
      addTextFromInput();
    } else {
      // Jika tidak ada teks, reset
      tempText = '';
      textInput.style.display = 'none';
      document.getElementById('text-cursor').style.display = 'none';
      isTextMode = false;
      redrawCanvas();
    }
  });
  
  // Tambahan: Event untuk klik kanan (desktop)
  canvas.addEventListener('contextmenu', (e) => {
    e.preventDefault(); // Selalu cegah menu browser default
    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;
    const objIndex = getObjectAtPosition(mouseX, mouseY);
    if (objIndex !== null) {
      selectedObject = objIndex; // Pilih objek
      showContextMenu(e.clientX, e.clientY, true); // Menu untuk objek
    } else {
      showContextMenu(e.clientX, e.clientY, false); // Menu untuk area kosong
    }
  });

  // Event listeners untuk touch dengan passive: false (menghilangkan warning)
  canvas.addEventListener('touchstart', (e) => {
    isLongPress = false;
    touchMoved = false;
    if (e.touches.length === 2 && selectedObjects.length > 0) {
      // Prioritas: Mulai pinch resize jika 2 jari dan objek dipilih
      initialDistance = getDistance(e.touches);
      resizingObject = selectedObjects[0]; // Resize objek pertama yang dipilih
      originalSize = { ...objects[resizingObject] }; // Simpan ukuran asli
      e.preventDefault();
      return; // Jangan lanjut ke long press
    }
    // Jika bukan pinch, cek long press
    const rect = canvas.getBoundingClientRect();
    const touchX = e.touches[0].clientX - rect.left;
    const touchY = e.touches[0].clientY - rect.top;
    const objIndex = getObjectAtPosition(touchX, touchY);
    if (objIndex !== null) {
      selectedObject = objIndex; // Pilih objek
      longPressTimer = setTimeout(() => {
        if (!touchMoved) { // Hanya jika tidak ada gerakan
          isLongPress = true;
          showContextMenu(e.touches[0].clientX, e.touches[0].clientY, true); // Menu untuk objek
          setTimeout(hideContextMenu, 3000);
        }
      }, 500);
    } else {
      longPressTimer = setTimeout(() => {
        if (!touchMoved) { // Hanya jika tidak ada gerakan
          isLongPress = true;
          showContextMenu(e.touches[0].clientX, e.touches[0].clientY, false); // Menu untuk area kosong
          setTimeout(hideContextMenu, 3000);
        }
      }, 500);
    }
    // Lanjut ke handleTouchStart asli
    handleTouchStart(e);
  }, { passive: false });

  canvas.addEventListener('touchmove', (e) => {
    if (e.touches.length === 2 && resizingObject !== null) {
      // Handle pinch resize
      const currentDistance = getDistance(e.touches);
      const scaleFactor = currentDistance / initialDistance;
      const obj = objects[resizingObject];
      
      if (obj.type === 'text') {
        obj.fontSize = Math.max(10, originalSize.fontSize * scaleFactor);
      } else if (obj.type === 'image') {
        obj.width = Math.max(10, originalSize.width * scaleFactor);
        obj.height = Math.max(10, originalSize.height * scaleFactor);
      } else if (obj.type === 'stroke') {
        const bounds = getStrokeBounds(obj);
        const centerX = (bounds.minX + bounds.maxX) / 2;
        const centerY = (bounds.minY + bounds.maxY) / 2;
        obj.points.forEach(point => {
          point.x = centerX + (point.x - centerX) * scaleFactor;
          point.y = centerY + (point.y - centerY) * scaleFactor;
        });
      }
      redrawCanvas();
      e.preventDefault();
    } else {
      // Jika bukan pinch, set flag gerakan dan clear long press timer
      touchMoved = true;
      clearTimeout(longPressTimer);
      // Lanjut ke handleTouchMove asli
      handleTouchMove(e);
    }
  }, { passive: false });
  
  canvas.addEventListener('touchend', (e) => {
    if (resizingObject !== null && e.touches.length < 2) {
      // Stop pinch resize jika kurang dari 2 jari
      resizingObject = null;
      initialDistance = 0;
    } else if (!isLongPress) {
      // Jika bukan long press, lanjut ke handleTouchEnd asli
      handleTouchEnd(e);
    }
    // Clear timer jika masih ada
    clearTimeout(longPressTimer);
  }, { passive: false });
  
  // Event listeners untuk mouse/touch
  canvas.addEventListener('mousedown', handleMouseDown);
  canvas.addEventListener('mousemove', handleMouseMove);
  canvas.addEventListener('mouseup', handleMouseUp);
  canvas.addEventListener('mouseout', handleMouseOut);
  canvas.addEventListener('dblclick', handleDoubleClick);  // Tambahan untuk resize
  
  // Tambahan: Event untuk Ctrl+C
  document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key === 'c' && selectedObject !== null) {
      e.preventDefault();
      copySelectedObject();
    }
  });
  document.addEventListener('keydown', handleKeyDown);

  // Initial Draw
  redrawCanvas();

  // Event listener untuk paste
  document.addEventListener('paste', handlePaste);
  
  // Event listener untuk reset canvas
  document.getElementById('reset-canvas-btn').addEventListener('click', resetCanvas);

  console.log('Whiteboard initialized successfully');
}

// Fungsi untuk select all objects
function selectAllObjects() {
  selectedObjects = [];
  for (let i = 0; i < objects.length; i++) {
    selectedObjects.push(i);
  }
  redrawCanvas();
}

// Fungsi untuk clear seleksi
function clearSelection() {
  selectedObjects = [];
  redrawCanvas();
}

  // Modifikasi fungsi createContextMenu untuk dinamis berdasarkan posisi
  function createContextMenu(isOnObject = false) {
    if (contextMenu) return; // Jika sudah ada, jangan buat ulang
    contextMenu = document.createElement('div');
    contextMenu.id = 'context-menu';
    contextMenu.style.position = 'absolute';
    contextMenu.style.background = '#fff';
    contextMenu.style.border = '1px solid #ccc';
    contextMenu.style.borderRadius = '4px';
    contextMenu.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
    contextMenu.style.zIndex = '1001';
    contextMenu.style.display = 'none';
    contextMenu.style.fontSize = '14px';
    contextMenu.style.minWidth = '150px';
    // Konten menu dinamis
    updateContextMenuContent(isOnObject);
    document.body.appendChild(contextMenu);

    // Sembunyikan menu saat klik di luar
    document.addEventListener('click', hideContextMenu);
    document.addEventListener('touchstart', hideContextMenu);
  }
  
  // Fungsi untuk update konten menu berdasarkan konteks
  function updateContextMenuContent(isOnObject) {
    if (!contextMenu) return;
    if (isOnObject) {
      contextMenu.innerHTML = `
        <div style="padding: 8px; cursor: pointer;" onclick="copySelectedObject()">Copy</div>
		<div style="padding: 8px; cursor: pointer;" onclick="deleteSelectedObject()">Delete</div>
      `;
    } else {
      contextMenu.innerHTML = `
        <div style="padding: 8px; cursor: pointer; border-bottom: 1px solid #eee;" onclick="insertFromDrive()">Insert object</div>
        <div style="padding: 8px; cursor: pointer;" onclick="pasteFromClipboard()">Paste</div>
      `;
    }
  }

// Fungsi untuk copy objek yang dipilih
function copySelectedObject() {
  if (selectedObjects.length === 0) {
    alert('Tidak ada objek yang dipilih untuk di-copy.');
    return;
  }
  copiedObjects = [];
  selectedObjects.forEach(index => {
    const obj = objects[index];
    const copy = JSON.parse(JSON.stringify(obj));
    if (obj.type === 'image') {
      copy.src = obj.src;
      copy.img = null;
    }
    copiedObjects.push(copy);
  });
  // Simpan ke clipboard browser jika memungkinkan
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(JSON.stringify(copiedObjects)).catch(err => {
      console.warn('Gagal menyimpan ke clipboard browser:', err);
    });
  }
}

function deleteSelectedObject() {
  if (selectedObjects.length === 0) return;
  // Hapus objek dari array objects (dari belakang ke depan untuk hindari index shift)
  selectedObjects.sort((a, b) => b - a); // Sort descending
  selectedObjects.forEach(index => {
    objects.splice(index, 1);
  });
  selectedObjects = []; // Reset selection
  redrawCanvas();
  saveState(); // Asumsikan ada
}

  // Fungsi untuk menampilkan menu konteks
  function showContextMenu(x, y, isOnObject = false) {
    if (!contextMenu) createContextMenu(isOnObject);
    updateContextMenuContent(isOnObject);
    contextMenu.style.left = x + 'px';
    contextMenu.style.top = y + 'px';
    contextMenu.style.display = 'block';
  }

  // Fungsi untuk menyembunyikan menu konteks
  function hideContextMenu() {
    if (contextMenu) contextMenu.style.display = 'none';
  }

  // Fungsi Insert from Drive (membuka file picker lokal)
  function insertFromDrive() {
    hideContextMenu();
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          const img = new Image();
          img.onload = function() {
            const scale = Math.min(canvas.width / img.width, canvas.height / img.height, 1);
            const imgObj = {
              type: 'image',
              src: event.target.result,
              img: img,
              loaded: true,
              x: 10, // Posisi default, bisa disesuaikan
              y: 10,
              width: img.width * scale,
              height: img.height * scale
            };
            saveState();
            objects.push(imgObj);
            redrawCanvas();
            alert('Gambar dari drive berhasil ditambahkan!');
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      }
    };
    input.click();
  }

// Modifikasi pasteFromClipboard untuk multiple objek
async function pasteFromClipboard() {
  hideContextMenu();
  // Prioritas: Paste objek internal dulu
  if (copiedObjects.length > 0) {
    copiedObjects.forEach((obj, idx) => {
      const copy = JSON.parse(JSON.stringify(obj));
      // Offset bertahap agar tidak menumpuk
      const offset = (idx + 1) * 10;
      if (copy.type === 'text') {
        copy.x += offset;
        copy.y += offset;
      } else if (copy.type === 'stroke') {
        copy.points.forEach(point => {
          point.x += offset;
          point.y += offset;
        });
      } else if (copy.type === 'image') {
        copy.x += offset;
        copy.y += offset;
        const img = new Image();
        img.onload = function() {
          copy.img = img;
          copy.loaded = true;
          saveState();
          objects.push(copy);
          redrawCanvas();
        };
        img.src = copy.src;
        return; // Skip push langsung, tunggu onload
      }
      saveState();
      objects.push(copy);
    });
    redrawCanvas();
    return;
  }

  // Jika tidak ada objek internal, cek clipboard eksternal (seperti sebelumnya)
  try {
    if (navigator.clipboard && navigator.clipboard.read) {
      const items = await navigator.clipboard.read();
      for (const item of items) {
        for (const type of item.types) {
          if (type.startsWith('image/')) {
            const blob = await item.getType(type);
            const reader = new FileReader();
            reader.onload = function(event) {
              const img = new Image();
              img.onload = function() {
                const scale = Math.min(canvas.width / img.width, canvas.height / img.height, 1);
                const imgObj = {
                  type: 'image',
                  src: event.target.result,
                  img: img,
                  loaded: true,
                  x: 10,
                  y: 10,
                  width: img.width * scale,
                  height: img.height * scale
                };
                saveState();
                objects.push(imgObj);
                redrawCanvas();
              };
              img.src = event.target.result;
            };
            reader.readAsDataURL(blob);
            return;
          } else if (type === 'text/plain') {
            const text = await item.getType(type);
            const textObj = {
              type: 'text',
              x: 10,
              y: 30,
              text: text,
              fontSize: 16,
              color: currentColor
            };
            saveState();
            objects.push(textObj);
            redrawCanvas();
            return;
          }
        }
      }
      alert('Tidak ada gambar atau teks di clipboard eksternal.');
    } else {
      alert('Fitur paste tidak didukung di browser ini. Gunakan Ctrl+V langsung di kanvas.');
    }
  } catch (err) {
    alert('Gagal mengakses clipboard: ' + err.message);
  }
}

// Modifikasi handlePaste untuk multiple objek
function handlePaste(e) {
  e.preventDefault();
  
  // Prioritas: Selalu cek clipboard eksternal dulu (untuk paste dari luar aplikasi)
  const items = e.clipboardData.items;
  let pastedExternal = false;
  for (let i = 0; i < items.length; i++) {
    if (items[i].type.indexOf('image') !== -1) {
      const blob = items[i].getAsFile();
      const reader = new FileReader();
      reader.onload = function(event) {
        const img = new Image();
        img.onload = function() {
          const scale = Math.min(canvas.width / img.width, canvas.height / img.height, 1);
          const imgObj = {
            type: 'image',
            src: event.target.result,
            img: img,
            loaded: true,
            x: 10,
            y: 10,
            width: img.width * scale,
            height: img.height * scale
          };
          saveState();
          objects.push(imgObj);
          redrawCanvas();
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(blob);
      pastedExternal = true;
      return;  // Hentikan setelah paste eksternal
    }
  }
  
  // Jika tidak ada paste eksternal, baru paste objek internal
  if (!pastedExternal && copiedObjects.length > 0) {
    copiedObjects.forEach((obj, idx) => {
      const copy = JSON.parse(JSON.stringify(obj));
      const offset = (idx + 1) * 10;
      if (copy.type === 'text') {
        copy.x += offset;
        copy.y += offset;
      } else if (copy.type === 'stroke') {
        copy.points.forEach(point => {
          point.x += offset;
          point.y += offset;
        });
      } else if (copy.type === 'image') {
        copy.x += offset;
        copy.y += offset;
        const img = new Image();
        img.onload = function() {
          copy.img = img;
          copy.loaded = true;
          saveState();
          objects.push(copy);
          redrawCanvas();
        };
        img.src = copy.src;
        return;  // Skip push langsung untuk image
      }
      saveState();
      objects.push(copy);
    });
    redrawCanvas();
  }
  
  // Jika tidak ada yang ter-paste, beri alert
  if (!pastedExternal && copiedObjects.length === 0) {
    alert('Tidak ada gambar atau objek yang terdeteksi di clipboard.');
  }
}

// Modifikasi redrawCanvas untuk highlight multiple objek
function redrawCanvas() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = 'white';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  // Gambar semua objek
  objects.forEach((obj, index) => {
    if (obj.type === 'stroke') {
      ctx.globalCompositeOperation = 'source-over';
      ctx.strokeStyle = obj.color;
      ctx.lineWidth = obj.width;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.beginPath();
      obj.points.forEach((point, idx) => {
        if (idx === 0) ctx.moveTo(point.x, point.y);
        else ctx.lineTo(point.x, point.y);
      });
      ctx.stroke();
    } else if (obj.type === 'erase') {
      ctx.globalCompositeOperation = 'destination-out';
      ctx.strokeStyle = 'rgba(0,0,0,1)';
      ctx.lineWidth = obj.width;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.beginPath();
      obj.points.forEach((point, idx) => {
        if (idx === 0) ctx.moveTo(point.x, point.y);
        else ctx.lineTo(point.x, point.y);
      });
      ctx.stroke();
      ctx.globalCompositeOperation = 'source-over';
    } else if (obj.type === 'text') {
      ctx.globalCompositeOperation = 'source-over';
      ctx.fillStyle = obj.color;
      ctx.font = `${obj.fontSize}px Arial`;
      ctx.fillText(obj.text, obj.x, obj.y);
    } else if (obj.type === 'image' && obj.loaded) {
      ctx.globalCompositeOperation = 'source-over';
      ctx.drawImage(obj.img, obj.x, obj.y, obj.width, obj.height);
    }
    
    // Highlight jika dipilih
    if (selectedObjects.includes(index)) {
      ctx.strokeStyle = '#2196F3';
      ctx.lineWidth = 2;
      ctx.setLineDash([5, 5]);
      if (obj.type === 'text') {
        const textWidth = ctx.measureText(obj.text).width;
        const textHeight = obj.fontSize;
        ctx.strokeRect(obj.x - 2, obj.y - textHeight - 2, textWidth + 4, textHeight + 4);
      } else if (obj.type === 'stroke') {
        const xs = obj.points.map(p => p.x);
        const ys = obj.points.map(p => p.y);
        const minX = Math.min(...xs) - 5;
        const minY = Math.min(...ys) - 5;
        const maxX = Math.max(...xs) + 5;
        const maxY = Math.max(...ys) + 5;
        ctx.strokeRect(minX, minY, maxX - minX, maxY - minY);
      } else if (obj.type === 'image') {
        ctx.strokeRect(obj.x - 2, obj.y - 2, obj.width + 4, obj.height + 4);
      }
      ctx.setLineDash([]);
    }
// Tambahkan handle resize ('+') di pojok kanan bawah jika objek dipilih dan bisa di-resize
if (selectedObjects.includes(index) && (obj.type === 'text' || obj.type === 'image' || obj.type === 'stroke')) {
  let handleX, handleY;
  if (obj.type === 'text') {
    const textWidth = ctx.measureText(obj.text).width;
    handleX = obj.x + textWidth;
    handleY = obj.y;
  } else if (obj.type === 'image') {
    handleX = obj.x + obj.width;
    handleY = obj.y + obj.height;
  } else if (obj.type === 'stroke') {
    const bounds = getStrokeBounds(obj);
    handleX = bounds.maxX;
    handleY = bounds.maxY;
  }
  // Gambar simbol '+' di posisi eksak (tanpa offset)
  ctx.fillStyle = '#2196F3';
  ctx.font = '16px Arial';
  ctx.fillText('+', handleX, handleY);  // Posisi langsung di pojok
}
  });
  
  // Render teks sementara jika dalam mode text
  if (isTextMode && tempText) {
    ctx.globalCompositeOperation = 'source-over';
    ctx.fillStyle = currentColor;
    ctx.font = `16px Arial`;
    ctx.fillText(tempText, textX, textY);
  }
}

// Fungsi untuk menambahkan teks ke kanvas dari input
function addTextFromInput() {
  const textInput = document.getElementById('text-input');
  const text = textInput.value.trim();
  if (text) {
    saveState(); // Simpan state sebelum menambah teks (untuk undo/redo)
    const textObj = {
      type: 'text',
      x: textX,
      y: textY,
      text: text,
      fontSize: 16,
      color: currentColor
    };
    objects.push(textObj);
    redrawCanvas();
  }
  // Reset dan sembunyikan elemen
  textInput.value = '';
  tempText = '';  // Reset teks sementara
  textInput.style.display = 'none';
  document.getElementById('text-cursor').style.display = 'none';
  isTextMode = false;
}

// Fungsi untuk menyimpan state sebelum perubahan
function saveState() {
  undoStack.push(JSON.parse(JSON.stringify(objects))); // Deep copy objects
  redoStack = []; // Clear redo stack saat ada perubahan baru
}

// Undo: Kembali ke state sebelumnya
function undo() {
  if (undoStack.length > 0) {
    redoStack.push(JSON.parse(JSON.stringify(objects)));
    objects = undoStack.pop();
    selectedObject = null;
    isDragging = false;
    redrawCanvas();
  }
}

// Redo: Maju ke state berikutnya
function redo() {
  if (redoStack.length > 0) {
    undoStack.push(JSON.parse(JSON.stringify(objects)));
    objects = redoStack.pop();
    selectedObject = null;
    isDragging = false;
    redrawCanvas();
  }
}

// Modifikasi deleteSelected untuk multiple objek
function deleteSelected() {
  if (selectedObjects.length === 0) return;
  saveState();
  // Sort descending untuk delete dari belakang
  selectedObjects.sort((a, b) => b - a);
  selectedObjects.forEach(index => {
    objects.splice(index, 1);
  });
  selectedObjects = [];
  redrawCanvas();
}

// Modifikasi selectTool untuk selalu aktifkan select mode tanpa toggle
function selectTool(tool) {
  if (tool === 'select') {
    toolActive = 'select'; // Selalu set ke select, tanpa toggle
  } else {
    toolActive = tool;
  }
  isErasing = toolActive === 'erase'; // Update berdasarkan toolActive
  isTextMode = toolActive === 'text';
  
  // Update active class
  document.querySelectorAll('#whiteboard-toolbar .tool-btn').forEach(btn => btn.classList.remove('active'));
  document.getElementById(toolActive + '-tool')?.classList.add('active'); // Gunakan toolActive
  
  canvas.style.cursor = toolActive === 'pen' || toolActive === 'erase' ? 'crosshair' : toolActive === 'select' ? 'move' : 'default';
  
  // Hapus set globalCompositeOperation untuk erase, agar tidak erase pixel
  ctx.globalCompositeOperation = 'source-over';  // Selalu normal draw
}


// Event Handlers (diperbaiki untuk tool lainnya)
function handleMouseDown(e) {
  const rect = canvas.getBoundingClientRect();
  const mouseX = e.clientX - rect.left;
  const mouseY = e.clientY - rect.top;

  if (resizingObject !== null) {
    const obj = objects[resizingObject];
    let handleX, handleY;
    if (obj.type === 'text') {
      const textWidth = ctx.measureText(obj.text).width;
      handleX = obj.x + textWidth;
      handleY = obj.y;
    } else if (obj.type === 'image') {
      handleX = obj.x + obj.width;
      handleY = obj.y + obj.height;
    } else if (obj.type === 'stroke') {
      const bounds = getStrokeBounds(obj);
      handleX = bounds.maxX;
      handleY = bounds.maxY;
    }
    if (Math.abs(mouseX - handleX) < 10 && Math.abs(mouseY - handleY) < 10) {
      isResizing = true;
      resizeStartX = mouseX;
      resizeStartY = mouseY;
      // Inisialisasi lastMouseX dan lastMouseY ke posisi mouse saat ini untuk menghindari loncatan awal
      lastMouseX = mouseX;
      lastMouseY = mouseY;
      saveState();
      return;
    }
  }

  if (toolActive === 'select') {
    // Jika sudah dragging objek yang sama, klik lagi untuk stop
    if (isDragging && selectedObject !== null) {
      const obj = getObjectAtPosition(mouseX, mouseY);  // Sekarang mouseX tersedia
      if (obj !== null && obj === selectedObject) {
        isDragging = false;
        selectedObject = null;
        redrawCanvas();
        return;
      }
    }
    // Mulai select baru
    handleSelectStart(e);
  } else if (toolActive === 'pen') {
    // Jika sedang drawing, klik lagi untuk stop
    if (isDrawing) {
      stopDrawing();
      return;
    }
    // Mulai drawing baru
    startDrawing(e);
  } else if (toolActive === 'erase') {
    // Jika sedang erasing, klik lagi untuk stop
    if (isDrawing) {
      stopErase();
      return;
    }
    // Mulai erasing baru
    startErase(e);
  } else if (toolActive === 'text') {
    textX = mouseX;  // Sekarang mouseX tersedia
    textY = mouseY;  // Sekarang mouseY tersedia
    const rect = canvas.getBoundingClientRect();
    document.getElementById('text-cursor').style.left = (rect.left + textX) + 'px';
    document.getElementById('text-cursor').style.top = (rect.top + textY) + 'px';
    document.getElementById('text-cursor').style.display = 'block';
    const textInput = document.getElementById('text-input');
    textInput.style.left = (rect.left + textX) + 'px';
    textInput.style.top = (rect.top + textY) + 'px';
    textInput.style.display = 'block';
    setTimeout(() => textInput.focus(), 10);  // Fokus dengan delay untuk memastikan display block
    isTextMode = true;
  }
}

// Modifikasi handleMouseMove untuk mendukung resize (dari kode asli) dan drag multiple
function handleMouseMove(e) {
// Deteksi hover pada handle resize dan ubah cursor
let isNearHandle = false;
if (selectedObjects.length > 0) {
  selectedObjects.forEach(index => {
    const obj = objects[index];
    if (obj.type === 'text' || obj.type === 'image' || obj.type === 'stroke') {
      let handleX, handleY;
      if (obj.type === 'text') {
        const textWidth = ctx.measureText(obj.text).width;
        handleX = obj.x + textWidth;
        handleY = obj.y;
      } else if (obj.type === 'image') {
        handleX = obj.x + obj.width;
        handleY = obj.y + obj.height;
      } else if (obj.type === 'stroke') {
        const bounds = getStrokeBounds(obj);
        handleX = bounds.maxX;
        handleY = bounds.maxY;
      }
      // Cek jarak mouse ke handle (toleransi 10px)
      const rect = canvas.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;
      if (Math.abs(mouseX - handleX) < 10 && Math.abs(mouseY - handleY) < 10) {
        isNearHandle = true;
      }
    }
  });
}
// Ubah cursor jika dekat handle
if (isNearHandle) {
  canvas.style.cursor = 'se-resize';  // Panah diagonal untuk resize
} else if (toolActive === 'select') {
  canvas.style.cursor = 'move';  // Default untuk select
} else {
  canvas.style.cursor = toolActive === 'pen' || toolActive === 'erase' ? 'crosshair' : 'default';
}

  // Prioritas: Handle resize jika aktif
if (isResizing) {
  const obj = objects[resizingObject];
  const rect = canvas.getBoundingClientRect();
  const mouseX = e.clientX - rect.left;
  const mouseY = e.clientY - rect.top;
  const deltaX = mouseX - lastMouseX;
  const deltaY = mouseY - lastMouseY;
  
  if (obj.type === 'text') {
    // Resize text: Ubah font size berdasarkan delta
    const scaleFactor = 1 + (deltaY / 100);  // Scale berdasarkan Y
    obj.fontSize = Math.max(10, obj.fontSize * scaleFactor);
  } else if (obj.type === 'image') {
    // Resize image: Ubah width dan height
    obj.width = Math.max(10, obj.width + deltaX);
    obj.height = Math.max(10, obj.height + deltaY);
  } else if (obj.type === 'stroke') {
    // Resize stroke: Scale semua points berdasarkan faktor dari delta
    const centerX = (obj.points[0].x + obj.points[obj.points.length - 1].x) / 2;  // Center berdasarkan titik awal dan akhir
    const centerY = (obj.points[0].y + obj.points[obj.points.length - 1].y) / 2;
    const scaleFactorX = 1 + (deltaX / 100);  // Faktor scale dari delta (bisa disesuaikan)
    const scaleFactorY = 1 + (deltaY / 100);
    obj.points.forEach(point => {
      point.x = centerX + (point.x - centerX) * scaleFactorX;
      point.y = centerY + (point.y - centerY) * scaleFactorY;
    });
  }
  
  lastMouseX = mouseX;
  lastMouseY = mouseY;
  redrawCanvas();
}

  // Jika tidak resize, handle drag multiple objek
  if (isDragging && selectedObjects.length > 0) {
    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;
    
    selectedObjects.forEach(index => {
      const obj = objects[index];
      if (obj.type === 'text') {
        obj.x = mouseX - dragOffsetX;
        obj.y = mouseY - dragOffsetY;
      } else if (obj.type === 'stroke') {
        const deltaX = mouseX - dragOffsetX - getStrokeCenter(obj).x;
        const deltaY = mouseY - dragOffsetY - getStrokeCenter(obj).y;
        obj.points.forEach(point => {
          point.x += deltaX;
          point.y += deltaY;
        });
        dragOffsetX = mouseX - getStrokeCenter(obj).x;
        dragOffsetY = mouseY - getStrokeCenter(obj).y;
      } else if (obj.type === 'image') {
        obj.x = mouseX - dragOffsetX;
        obj.y = mouseY - dragOffsetY;
      }
    });
    
    redrawCanvas();
  } else if (toolActive === 'pen' && isDrawing) {
    draw(e);
  } else if (toolActive === 'erase' && isDrawing) {
    erase(e);
  }
}

// Modifikasi handleMouseUp untuk mendukung stop resize (dari kode asli) dan stop drawing/erasing
function handleMouseUp() {
  if (isResizing) {
    isResizing = false;
    return;
  }

  if (toolActive === 'pen' && isDrawing) {
    stopDrawing();
  } else if (toolActive === 'erase' && isDrawing) {
    stopErase();
  }
  isDragging = false;
}

function handleMouseOut() {
  if (isDrawing) {
    if (toolActive === 'pen') {
      stopDrawing();
    } else if (toolActive === 'erase') {
      stopErase();
    }
  }
}

// Modifikasi handleKeyDown untuk menambahkan keyboard drag
function handleKeyDown(e) {
  if (e.key === 'Delete' && selectedObjects.length > 0) {
    deleteSelected();
  } else if (e.ctrlKey && e.key === 'x' && selectedObjects.length > 0) {
    e.preventDefault();
    deleteSelected();
  } else if (e.ctrlKey && e.key === 'z') {
    e.preventDefault();
    undo();
  } else if (e.ctrlKey && e.key === 'y') {
    e.preventDefault();
    redo();
  } else if (e.ctrlKey && e.key === 'c' && selectedObjects.length > 0) {
    e.preventDefault();
    copySelectedObject();
  } else if (e.ctrlKey && e.key === 'a' && toolActive === 'select') {
    e.preventDefault();
    selectAllObjects();
  } else if (selectedObjects.length > 0 && ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
    // Keyboard drag: Pindahkan objek yang dipilih dengan panah
    e.preventDefault();
    const moveStep = 5; // 5px per tekanan
    selectedObjects.forEach(index => {
      const obj = objects[index];
      if (e.key === 'ArrowUp') obj.y -= moveStep;
      else if (e.key === 'ArrowDown') obj.y += moveStep;
      else if (e.key === 'ArrowLeft') obj.x -= moveStep;
      else if (e.key === 'ArrowRight') obj.x += moveStep;
      // Untuk stroke, pindahkan semua points
      if (obj.type === 'stroke') {
        obj.points.forEach(point => {
          if (e.key === 'ArrowUp') point.y -= moveStep;
          else if (e.key === 'ArrowDown') point.y += moveStep;
          else if (e.key === 'ArrowLeft') point.x -= moveStep;
          else if (e.key === 'ArrowRight') point.x += moveStep;
        });
      }
    });
    redrawCanvas();
  } else if (e.key === 'Escape') {
    if (isDragging) {
      isDragging = false;
      selectedObjects = [];
      redrawCanvas();
    } else if (toolActive === 'pen' && isDrawing) {
      stopDrawing();
    } else if (toolActive === 'erase' && isDrawing) {
      stopErase();
    }
  }
}

// Fungsi helper untuk menghitung jarak antara 2 titik (untuk pinch)
function getDistance(touches) {
  const dx = touches[0].clientX - touches[1].clientX;
  const dy = touches[0].clientY - touches[1].clientY;
  return Math.sqrt(dx * dx + dy * dy);
}

function handleDoubleClick(e) {
  const rect = canvas.getBoundingClientRect();
  const mouseX = e.clientX - rect.left;
  const mouseY = e.clientY - rect.top;
  
  // Cari objek yang diklik (dari belakang)
  for (let i = objects.length - 1; i >= 0; i--) {
    const obj = objects[i];
    if (isPointInObject(mouseX, mouseY, obj)) {
      resizingObject = i;
      originalSize = getObjectSize(obj);  // Simpan ukuran asli
      redrawCanvas();
      return;
    }
  }
  // Jika tidak ada objek, nonaktifkan resize
  resizingObject = null;
  redrawCanvas();
}

// Drawing Functions untuk 'Pen' (simpan sebagai stroke di objects)
function startDrawing(e) {
  saveState();
  isDrawing = true;
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  currentStroke = {
    type: 'stroke',
    points: [{ x, y }],
    color: currentColor,
    width: currentLineWidth
  };
  objects.push(currentStroke);  // Push ke objects
}

function draw(e) {
  if (!isDrawing || toolActive !== 'pen') return;
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  currentStroke.points.push({ x, y });
  redrawCanvas();
}

function stopDrawing() {
  isDrawing = false;
  currentStroke = null;
}

// Erase Functions untuk 'Erase' (simpan sebagai erase di objects)
function startErase(e) {
  saveState();
  isDrawing = true;
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  currentErase = {
    type: 'erase',
    points: [{ x, y }],
    width: currentLineWidth
  };
  objects.push(currentErase);  // Push ke objects
}

function erase(e) {
  if (!isDrawing || toolActive !== 'erase') return;
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  currentErase.points.push({ x, y });
  redrawCanvas();
}

function stopErase() {
  isDrawing = false;
  currentErase = null;
}

// Modifikasi handleSelectStart untuk mode select tetap aktif saat klik objek, lepas hanya jika klik kosong
function handleSelectStart(e) {
  console.log('Before handleSelectStart, toolActive:', toolActive); // Debug
  const rect = canvas.getBoundingClientRect();
  const mouseX = e.clientX - rect.left;
  const mouseY = e.clientY - rect.top;
  
  // Loop dari belakang (objek terbaru dulu)
  for (let i = objects.length - 1; i >= 0; i--) {
    const obj = objects[i];
    if (obj.type === 'text') {
      const textWidth = ctx.measureText(obj.text).width;
      const textHeight = obj.fontSize;
      if (mouseX >= obj.x && mouseX <= obj.x + textWidth &&
          mouseY >= obj.y - textHeight && mouseY <= obj.y) {
        // Tambah ke seleksi jika belum ada (tanpa hapus jika sudah ada)
        if (!selectedObjects.includes(i)) {
          selectedObjects.push(i);
        }
        isDragging = true;
        dragOffsetX = mouseX - obj.x;
        dragOffsetY = mouseY - obj.y;
        redrawCanvas();
        return; // Jangan lanjut ke clear
      }
    } else if (obj.type === 'stroke') {
      if (isPointNearStroke(mouseX, mouseY, obj)) {
        // Tambah ke seleksi jika belum ada (tanpa hapus jika sudah ada)
        if (!selectedObjects.includes(i)) {
          selectedObjects.push(i);
        }
        isDragging = true;
        const center = getStrokeCenter(obj);
        dragOffsetX = mouseX - center.x;
        dragOffsetY = mouseY - center.y;
        redrawCanvas();
        return; // Jangan lanjut ke clear
      }
    } else if (obj.type === 'image') {
      if (mouseX >= obj.x && mouseX <= obj.x + obj.width &&
          mouseY >= obj.y && mouseY <= obj.y + obj.height) {
        // Tambah ke seleksi jika belum ada (tanpa hapus jika sudah ada)
        if (!selectedObjects.includes(i)) {
          selectedObjects.push(i);
        }
        isDragging = true;
        dragOffsetX = mouseX - obj.x;
        dragOffsetY = mouseY - obj.y;
        redrawCanvas();
        return; // Jangan lanjut ke clear
      }
    }
  }
  // Jika klik di area kosong, clear seleksi (tapi mode select tetap aktif)
  clearSelection();
  console.log('After handleSelectStart, toolActive:', toolActive); // Debug
}

// Helper: Dapatkan objek di posisi mouse
function getObjectAtPosition(mouseX, mouseY) {
  for (let i = objects.length - 1; i >= 0; i--) {
    const obj = objects[i];
    if (obj.type === 'text') {
      const textWidth = ctx.measureText(obj.text).width;
      const textHeight = obj.fontSize;
      if (mouseX >= obj.x && mouseX <= obj.x + textWidth &&
          mouseY >= obj.y - textHeight && mouseY <= obj.y) {
        return i;
      }
    } else if (obj.type === 'stroke') {
      if (isPointNearStroke(mouseX, mouseY, obj)) {
        return i;
      }
    } else if (obj.type === 'image') {
      if (mouseX >= obj.x && mouseX <= obj.x + obj.width &&
          mouseY >= obj.y && mouseY <= obj.y + obj.height) {
        return i;
      }
    }
  }
  return null;
}

// Helper: Cek apakah titik dekat stroke
function isPointNearStroke(px, py, stroke) {
  return stroke.points.some(point => Math.sqrt((point.x - px) ** 2 + (point.y - py) ** 2) < stroke.width / 2 + 5);
}

// Helper: Dapatkan center stroke
function getStrokeCenter(stroke) {
  const xs = stroke.points.map(p => p.x);
  const ys = stroke.points.map(p => p.y);
  return {
    x: (Math.min(...xs) + Math.max(...xs)) / 2,
    y: (Math.min(...ys) + Math.max(...ys)) / 2
  };
}

// Helper: Dapatkan bounds stroke
function getStrokeBounds(stroke) {
  const xs = stroke.points.map(p => p.x);
  const ys = stroke.points.map(p => p.y);
  return {
    minX: Math.min(...xs),
    maxX: Math.max(...xs),
    minY: Math.min(...ys),
    maxY: Math.max(...ys)
  };
}

// Helper: Hitung jarak antara dua titik
function distance(x1, y1, x2, y2) {
  return Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
}

// Helper: Cek apakah titik dalam objek
function isPointInObject(mouseX, mouseY, obj) {
  if (obj.type === 'text') {
    const textWidth = ctx.measureText(obj.text).width;
    const textHeight = obj.fontSize;
    return mouseX >= obj.x && mouseX <= obj.x + textWidth &&
           mouseY >= obj.y - textHeight && mouseY <= obj.y;
  } else if (obj.type === 'image') {
    return mouseX >= obj.x && mouseX <= obj.x + obj.width &&
           mouseY >= obj.y && mouseY <= obj.y + obj.height;
  } else if (obj.type === 'stroke') {
    return isPointNearStroke(mouseX, mouseY, obj);
  }
  return false;
}

// Helper: Dapatkan ukuran objek
function getObjectSize(obj) {
  if (obj.type === 'text') return { fontSize: obj.fontSize };
  if (obj.type === 'image') return { width: obj.width, height: obj.height };
  if (obj.type === 'stroke') {
    const bounds = getStrokeBounds(obj);
    return { width: bounds.maxX - bounds.minX, height: bounds.maxY - bounds.minY };
  }
  return {};
}

// Touch Events
function handleTouchStart(e) {
if (e.target === canvas) {
    e.preventDefault();
  }
  e.preventDefault();
  handleMouseDown({ clientX: e.touches[0].clientX, clientY: e.touches[0].clientY });
}

function handleTouchMove(e) {
if (isDrawing || isResizing) {
    e.preventDefault();
  }
  e.preventDefault();
  handleMouseMove({ clientX: e.touches[0].clientX, clientY: e.touches[0].clientY });
}

function handleTouchEnd(e) {
  e.preventDefault();
  handleMouseUp();
}

// Clear Canvas
function clearCanvas() {
  saveState();
  objects = [];
  redrawCanvas();
}

// Save Canvas
function saveCanvas() {
  redrawCanvas();
  const link = document.createElement('a');
  link.download = 'whiteboard.png';
  link.href = canvas.toDataURL();
  link.click();
}

function resetCanvas() {
  // Kosongkan semua objek
  objects = [];
  
  // Reset variabel state
  selectedObjects = [];
  selectedObject = null;
  copiedObjects = [];
  resizingObject = null;
  isResizing = false;
  isDrawing = false;
  isTextMode = false;
  tempText = '';
  
  // Reset tool ke default (misalnya, pen)
  selectTool('pen');
  
  // Clear undo/redo history jika ada (opsional, jika Anda punya array undoStack/redoStack)
  // undoStack = [];
  // redoStack = [];
  
  // Redraw kanvas kosong
  redrawCanvas();
  
  // Sembunyikan input teks jika sedang aktif
  const textInput = document.getElementById('text-input');
  if (textInput) {
    textInput.style.display = 'none';
    textInput.value = '';
  }
  const textCursor = document.getElementById('text-cursor');
  if (textCursor) {
    textCursor.style.display = 'none';
  }
  
  console.log('Canvas reset to initial state');
}

// Fullscreen Toggle (Base dari kode sederhana Anda + fix toolbar visible, resize, switch text)
function toggleFullscreen() {
  const container = document.getElementById('whiteboard-container');  // Target utama (include toolbar)
  const fallbackContainer = document.getElementById('canvas-wrapper');  // Backup seperti kode Anda
  const fullscreenBtn = document.getElementById('fullscreen-tool');
  const canvas = document.getElementById('whiteboard-canvas');
  const ctx = canvas ? canvas.getContext('2d') : null;  // Fix: Definisikan ctx di sini

  if (!container || !fullscreenBtn || !canvas || !ctx) {
    alert('Elemen tidak ditemukan. Refresh halaman.');
    return;
  }

  if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement) {
    // Enter: Coba container utama, fallback ke canvas-wrapper (seperti kode Anda)
    const target = container.requestFullscreen ? container : fallbackContainer;
    target.requestFullscreen()
      .then(() => {
        // Switch text & warna
        fullscreenBtn.textContent = 'ExitFull';
        fullscreenBtn.style.background = '#f44336';
        
        // Resize canvas full (sederhana, setelah success)
        setTimeout(() => {
          canvas.width = target.clientWidth || window.innerWidth;
          canvas.height = target.clientHeight || (window.innerHeight - 60);  // Minus toolbar
          ctx.fillStyle = 'white';
          ctx.fillRect(0, 0, canvas.width, canvas.height);  // Redraw white
          console.log(`Fullscreen enter: Canvas ${canvas.width}x${canvas.height}`);
        }, 10);  // Delay kecil untuk DOM update
      })
      .catch(err => {
        alert('Fullscreen tidak didukung: ' + err.message);
        console.error(err);
      });
  } else {
    // Exit
    document.exitFullscreen()
      .then(() => {
        // Switch text & warna
        fullscreenBtn.textContent = '⛶ Full';
        fullscreenBtn.style.background = '#607D8B';
        
        // Resize ke asli
        setTimeout(() => {
          canvas.width = 800;  // Ukuran asli dari HTML
          canvas.height = 500;
          ctx.fillStyle = 'white';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          console.log('Fullscreen exit: Canvas reset 800x500');
        }, 10);
      })
      .catch(err => console.error('Exit error:', err));
  }
}

// Update showMaterial to init whiteboard
const originalShowMaterial = showMaterial;
showMaterial = function(materialId) {
  originalShowMaterial(materialId);
  if (materialId === 'whiteboard') {
    // Delay init to ensure DOM is ready
    setTimeout(initWhiteboard, 100);
  }
}

// PERBAIKAN: Show material/tools dengan ID numerik atau string
function showMaterial(materialId) {
  // Force close sidebar on mobile
  if (window.innerWidth <= 768) {
    const sidebar = document.getElementById('materials-sidebar');
    sidebar.classList.remove('open');
    sidebar.style.left = '-100%';
  }

  // Remove active dari semua items
  document.querySelectorAll('.material-item').forEach(item => item.classList.remove('active'));
  const clickedItem = document.querySelector(`[data-material-id="${materialId}"]`);
  if (clickedItem) clickedItem.classList.add('active');

  const pageContentDiv = document.getElementById('pageContent');
  let content = '<p>Materi tidak ditemukan.</p>';

  // Handle materials (ID numerik)
  if (typeof materialId === 'number' || !isNaN(materialId)) {
    const material = materialsArray.find(m => m.id == materialId); // == untuk string/number
    if (material) content = material.content;
  } 
  // Handle tools (ID string)
  else if (typeof materialId === 'string') {
    const tool = toolsArray.find(t => t.id === materialId);
    if (tool) content = tool.content;
  }

  pageContentDiv.innerHTML = content;

  // Re-enable editing jika admin
  if (isAdminMode) enableAdminEditing();

  destroyChart(); // Destroy chart jika ada
}

  /**
   * Displays the content of a selected analysis tool.
   * @param {string} toolId - The ID of the analysis tool to display.
   */
  function showAnalysisTool(toolId) {
    // Close sidebar on mobile after selection
    if (window.innerWidth <= 768) { // Adjust breakpoint as needed
      toggleSidebar(); // Re-added sidebar toggle
    }

    // Remove active class from all material items
    document.querySelectorAll('.material-item').forEach(item => {
      item.classList.remove('active');
    });
    // Set active class for Analysis sidebar item
    const AnalysisItem = document.querySelector('.material-item[data-material-id="8"]'); // Assuming Analysis is always ID 8 initially
    if (AnalysisItem) {
      AnalysisItem.classList.add('active');
    }

    const pageContentDiv = document.getElementById('pageContent');
    const content = analysisToolContents[toolId];
    if (content) {
      pageContentDiv.innerHTML = content;
      // Initialize specific tool forms if needed
      toggleInputMethod(toolId); // Initialize input method display for all tools
      if (toolId === 'uji-mean') {
        updateTTestForm();
      } else if (toolId === 'chi-square') {
        updateChiSquareForm();
      } else if (toolId === 'uji-asumsi') {
        updateAssumptionTestForm();
      } else if (toolId === 'Sample Size') {
        updatePowerAnalysisForm(); // Initialize power analysis form
      }
    } else {
      pageContentDiv.innerHTML = `
        <h2>${toolId}</h2>
        <p>Tool analisis untuk ${toolId} sedang dalam pengembangan.</p>
        <div class="analysis-form">
          <h3>Coming Soon</h3>
          <p>Fitur ini akan segera tersedia. Silakan hubungi admin untuk informasi lebih lanjut.</p>
        </div>
      `;
    }
    destroyChart(); // Destroy any chart when switching tool
  }

 /**
 * Toggles the visibility of the Help & ChatAI modal.
 */
function toggleHelpFAQModal() {
  const modal = document.getElementById('help-faq-modal');
  modal.classList.toggle('open');
  // Scroll chatbot messages to bottom when opened
  if (modal.classList.contains('open')) {
    const messagesContainer = document.getElementById('chatbot-messages');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }
}

/**
 * Sends a message to the ChatAI and displays the response.
 */
function sendChatMessage() {
  const inputField = document.getElementById('chatbot-input-field');
  const message = inputField.value.trim();
  if (message === '') return;

  const messagesContainer = document.getElementById('chatbot-messages');
  
  // Add user message
  const userMessageDiv = document.createElement('div');
  userMessageDiv.classList.add('chatbot-message', 'user');
  userMessageDiv.textContent = message;
  messagesContainer.appendChild(userMessageDiv);

  inputField.value = ''; // Clear input
  messagesContainer.scrollTop = messagesContainer.scrollHeight; // Scroll to bottom

  // Get AI response
  setTimeout(() => {
    const aiResponse = getAIResponse(message);
    const botMessageDiv = document.createElement('div');
    botMessageDiv.classList.add('chatbot-message', 'bot');
    botMessageDiv.innerHTML = aiResponse; // Use innerHTML for potential links/formatting
    messagesContainer.appendChild(botMessageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight; // Scroll to bottom
  }, 500);
}

/**
 * Handles Enter key press in the ChatAI input field.
 * @param {KeyboardEvent} event - The keyboard event.
 */
function handleChatInput(event) {
  if (event.key === 'Enter') {
    sendChatMessage();
  }
}

/**
 * Provides an automated AI response for data analysis questions.
 * If the AI cannot answer, it directs to CS Admin.
 * @param {string} userMessage - The user's message.
 * @returns {string} The AI's response.
 */
function getAIResponse(userMessage) {
  const lowerCaseMessage = userMessage.toLowerCase();

  // AI for Data Analysis responses
  if (lowerCaseMessage.includes('halo') || lowerCaseMessage.includes('hai')) {
    return 'Halo! Saya ChatAI SARC, asisten Anda untuk analisis data statistik. Ada yang bisa saya bantu?';
  } else if (lowerCaseMessage.includes('apa itu statistika')) {
    return 'Statistika adalah ilmu yang berkaitan dengan pengumpulan, pengorganisasian, analisis, interpretasi, dan presentasi data. Anda bisa membaca lebih lanjut di materi <a href="#" onclick="showMaterial(1); toggleHelpFAQModal();">Pengantar Statistika</a>.';
  } else if (lowerCaseMessage.includes('tools analisis') || lowerCaseMessage.includes('alat analisis')) {
    return 'Kami memiliki berbagai tools analisis statistik interaktif. Anda bisa melihatnya di menu <a href="#" onclick="showMaterial(8); toggleHelpFAQModal();">Analysis</a>. Beberapa tool yang tersedia antara lain Statistik Deskriptif, Uji t, ANOVA, Korelasi, dan Regresi Linear.';
  } else if (lowerCaseMessage.includes('uji t') || lowerCaseMessage.includes('t-test')) {
    return 'Uji t digunakan untuk membandingkan rata-rata satu atau dua kelompok. Anda bisa mencobanya di <a href="#" onclick="showAnalysisTool(\'uji-mean\'); toggleHelpFAQModal();">Tool Uji t</a>. Ada tiga jenis utama: One-sample, Independent Two-sample, dan Paired t-test.';
  } else if (lowerCaseMessage.includes('anova')) {
    return 'ANOVA (Analysis of Variance) digunakan untuk membandingkan rata-rata tiga atau lebih kelompok. Coba di <a href="#" onclick="showAnalysisTool(\'anova\'); toggleHelpFAQModal();">Tool ANOVA</a>. Ini sangat berguna untuk desain eksperimen dengan banyak grup.';
  } else if (lowerCaseMessage.includes('korelasi')) {
    return 'Analisis korelasi mengukur kekuatan dan arah hubungan linear antara dua variabel. Anda bisa menggunakannya di <a href="#" onclick="showAnalysisTool(\'korelasi\'); toggleHelpFAQModal();">Tool Analisis Korelasi</a>. Koefisien korelasi Pearson adalah yang paling umum.';
  } else if (lowerCaseMessage.includes('regresi')) {
    return 'Regresi linear memodelkan hubungan antara variabel dependen dan satu atau lebih variabel independen. Coba di <a href="#" onclick="showAnalysisTool(\'regresi\'); toggleHelpFAQModal();">Tool Analisis Regresi Linear</a> untuk memprediksi nilai variabel dependen.';
  } else if (lowerCaseMessage.includes('statistik deskriptif')) {
    return 'Statistik deskriptif meringkas dan menggambarkan karakteristik utama dari suatu set data, seperti mean, median, modus, dan standar deviasi. Anda bisa mencobanya di <a href="#" onclick="showAnalysisTool(\'deskriptif\'); toggleHelpFAQModal();">Tool Statistik Deskriptif</a>.';
  } else if (lowerCaseMessage.includes('uji asumsi')) {
    return 'Uji asumsi klasik adalah prasyarat untuk banyak uji statistik parametrik, meliputi normalitas, homogenitas varians, dan linearitas. Anda bisa mengujinya di <a href="#" onclick="showAnalysisTool(\'uji-asumsi\'); toggleHelpFAQModal();">Tool Uji Asumsi Klasik</a>.';
  } else if (lowerCaseMessage.includes('uji validitas') || lowerCaseMessage.includes('uji reliabilitas')) {
    return 'Uji validitas dan reliabilitas digunakan untuk menilai kualitas instrumen penelitian (misalnya kuesioner). Validitas mengukur apakah instrumen mengukur apa yang seharusnya diukur, sedangkan reliabilitas mengukur konsistensi. Anda bisa mencobanya di <a href="#" onclick="showAnalysisTool(\'uji-instrumen\'); toggleHelpFAQModal();">Tool Uji Validitas & Reliabilitas</a>.';
  } else if (lowerCaseMessage.includes('sample size') || lowerCaseMessage.includes('ukuran sampel')) {
    return 'Power analysis membantu menentukan ukuran sampel yang diperlukan untuk mendeteksi efek dengan probabilitas tertentu, atau untuk mengevaluasi kekuatan uji statistik yang sudah ada. Anda bisa menggunakan <a href="#" onclick="showAnalysisTool(\'Sample Size\'); toggleHelpFAQModal();">Tool Sample Size</a>.';
  } else if (lowerCaseMessage.includes('clustering') || lowerCaseMessage.includes('klastering')) {
    return 'Clustering adalah teknik unsupervised learning untuk mengelompokkan titik data ke dalam grup (cluster) berdasarkan kesamaan. K-Means adalah algoritma clustering yang populer. Anda bisa mencobanya di <a href="#" onclick="showAnalysisTool(\'clustering\'); toggleHelpFAQModal();">Tool Clustering</a>.';
  } else if (lowerCaseMessage.includes('factor analysis') || lowerCaseMessage.includes('analisis faktor')) {
    return 'Analisis faktor adalah metode statistik untuk mengurangi dimensi data dengan mengidentifikasi faktor-faktor laten yang mendasari variabel-variabel yang diamati. Anda bisa mencobanya di <a href="#" onclick="showAnalysisTool(\'factor-analysis\'); toggleHelpFAQModal();">Tool Factor Analysis</a>.';
  } else if (lowerCaseMessage.includes('referensi')) {
    return 'Setiap materi memiliki bagian referensi di akhir kontennya. Anda bisa menavigasi ke materi yang relevan untuk melihat daftar referensi.';
  } else if (lowerCaseMessage.includes('download materi')) {
    return 'Saat ini fitur unduh materi belum tersedia. Namun, Anda bisa menyalin teks materi langsung dari halaman.';
  } else if (lowerCaseMessage.includes('kontak') || lowerCaseMessage.includes('admin') || lowerCaseMessage.includes('bantuan lebih lanjut')) {
    return 'Untuk pertanyaan yang tidak dapat saya jawab atau bantuan lebih lanjut, silakan hubungi Customer Service Admin kami melalui email: <a href="mailto:konsultasi@statistika.ac.id">konsultasi@statistika.ac.id</a> atau telepon/WhatsApp: <a href="https://wa.me/628567792297" target="_blank">0856-7792-297</a>.';
  } else if (lowerCaseMessage.includes('terima kasih')) {
    return 'Sama-sama! Senang bisa membantu Anda dalam perjalanan analisis data statistik.';
  } else {
    // Default response for questions AI cannot answer, directs to CS Admin
    return 'Maaf, saya belum bisa menjawab pertanyaan Anda secara spesifik. Untuk bantuan lebih lanjut atau pertanyaan yang lebih kompleks, silakan hubungi Customer Service Admin kami melalui email: <a href="mailto:konsultasi@statistika.ac.id">konsultasi@statistika.ac.id</a> atau telepon/WhatsApp: <a href="https://wa.me/628567792297" target="_blank">0856-7792-297</a>.';
  }
}

  // --- Admin Mode Functionality ---

  /**
   * Menutup bagian login admin.
   */
  function closeAdminLoginSection() {
    const adminLoginSection = document.getElementById('admin-login-section');
    adminLoginSection.style.display = 'none';
    document.getElementById('admin-password').value = ''; // Clear password field
    const adminToggleBtn = document.getElementById('admin-mode-toggle-btn');
    if (!isAdminMode) { // Only reset button text if not logged in
        adminToggleBtn.textContent = 'Login';
        adminToggleBtn.classList.remove('active');
    }
  }

  /**
   * Toggles the admin mode login/logout section visibility.
   */
  function toggleAdminMode() {
    const adminToggleBtn = document.getElementById('admin-mode-toggle-btn');
    const adminLoginSection = document.getElementById('admin-login-section');

    if (isAdminMode) { // If currently ON, just logout
      logoutAdmin();
    } else { // If currently OFF, toggle login form visibility
      if (adminLoginSection.style.display === 'flex') {
        closeAdminLoginSection(); // Hide if already visible
      } else {
        adminLoginSection.style.display = 'flex'; // Show login form
        adminToggleBtn.classList.add('active'); // Keep active state for visual feedback
        adminToggleBtn.textContent = 'Login'; // Ensure button text is "Login" when form is shown
      }
    }
  }

  /**
   * Handles admin login attempt.
   */
  function loginAdmin() {
    const passwordInput = document.getElementById('admin-password');
    const adminLoginSection = document.getElementById('admin-login-section');
    const adminToggleBtn = document.getElementById('admin-mode-toggle-btn');

    if (passwordInput.value === ADMIN_PASSWORD) {
      isAdminMode = true;
      document.body.classList.add('admin-active');
      document.getElementById('admin-login-form').style.display = 'none';
      document.getElementById('admin-logout-form').style.display = 'block';
      adminToggleBtn.textContent = 'Logout'; // Update button text
      enableAdminEditing();
      alert('Berhasil masuk mode Admin!');
      adminLoginSection.style.display = 'none'; // Hide login section after successful login
    } else {
      alert('Password salah!');
      passwordInput.value = '';
    }
  }

  /**
   * Handles admin logout.
   */
  function logoutAdmin() {
    isAdminMode = false;
    document.body.classList.remove('admin-active');
    document.getElementById('admin-login-form').style.display = 'block';
    document.getElementById('admin-logout-form').style.display = 'none';
    document.getElementById('admin-password').value = '';
    document.getElementById('admin-mode-toggle-btn').textContent = 'Login'; // Update button text
    document.getElementById('admin-mode-toggle-btn').classList.remove('active');
    disableAdminEditing();
    alert('Berhasil keluar dari mode Admin.');
    // Reload current page content to remove editable borders
    const currentMaterialId = document.querySelector('.material-item.active')?.dataset.materialId;
    if (currentMaterialId) {
        showMaterial(parseInt(currentMaterialId));
    } else {
        document.getElementById('pageContent').innerHTML = initialWelcomeContent;
        loadPageContentFromLocalStorage(); // Re-apply non-admin content
    }
    closeAdminLoginSection(); // Ensure the login section is hidden after logout
  }

  /**
   * Enables contenteditable for all elements with class 'editable-content'.
   */
function enableAdminEditing() {
  document.querySelectorAll('.editable-content').forEach(el => {
    // Skip jika di Tools section
    if (el.closest('.tools-section')) return;
    el.setAttribute('contenteditable', 'true');
    el.addEventListener('focus', handleEditFocus);
    el.addEventListener('blur', handleEditBlur);
  });
}

  /**
   * Disables contenteditable for all elements with class 'editable-content'.
   */
  function disableAdminEditing() {
    document.querySelectorAll('.editable-content').forEach(el => {
      el.removeAttribute('contenteditable');
      el.removeEventListener('focus', handleEditFocus);
      el.removeEventListener('blur', handleEditBlur);
    });
  }

  /**
   * Stores the original content of an editable element when it gains focus.
   * @param {FocusEvent} event - The focus event.
   */
  function handleEditFocus(event) {
    currentEditableContent = event.target;
    originalContent = event.target.innerHTML;
  }

  /**
   * Saves the new content of an editable element to local storage when it loses focus.
   * @param {FocusEvent} event - The blur event.
   */
  function handleEditBlur(event) {
    const id = event.target.dataset.editableId;
    const newContent = event.target.innerHTML;

    if (id.startsWith('material-title-')) {
      const materialId = parseInt(id.replace('material-title-', ''));
      if (materialContents[materialId]) {
        materialContents[materialId].title = newContent;
        saveToLocalStorage('materialContents', materialContents);
        // Update the sidebar item directly
        const sidebarItem = document.querySelector(`.material-item[data-material-id="${materialId}"] strong`);
        if (sidebarItem) sidebarItem.innerHTML = newContent;
      }
    } else if (id.startsWith('material-subtitle-')) {
      const materialId = parseInt(id.replace('material-subtitle-', ''));
      if (materialContents[materialId]) {
        materialContents[materialId].subtitle = newContent;
        saveToLocalStorage('materialContents', materialContents);
        // Update the sidebar item directly
        const sidebarItem = document.querySelector(`.material-item[data-material-id="${materialId}"] .material-subtitle`);
        if (sidebarItem) sidebarItem.innerHTML = newContent;
      }
    } else if (id.startsWith('material-content-')) {
      const materialId = parseInt(id.replace('material-content-', ''));
      if (materialContents[materialId]) {
        materialContents[materialId].content = newContent;
        saveToLocalStorage('materialContents', materialContents);
      }
    } else {
      // For other general editable content on the page (header, footer,, welcome, etc.)
      const pageData = loadFromLocalStorage('pageData') || {};
      pageData[id] = newContent;
      saveToLocalStorage('pageData', pageData);
    }
    currentEditableContent = null;
    originalContent = '';
  }

  /**
   * Displays the edit form for a specific material.
   * @param {number} materialId - The ID of the material to edit.
   * @param {Event} event - The event object (to stop propagation).
   */
  function editMaterial(materialId, event) {
    event.stopPropagation(); // Prevent showMaterial from being called immediately
    if (!isAdminMode) return; // Only allow editing in admin mode

    const material = materialContents[materialId];
    if (!material) return;

    const pageContentDiv = document.getElementById('pageContent');
    pageContentDiv.innerHTML = `
      <h2>Edit Materi: <span class="editable-content" data-editable-id="material-title-${materialId}">${material.title}</span></h2>
      <p>Subtitle: <span class="editable-content" data-editable-id="material-subtitle-${materialId}">${material.subtitle}</span></p>
      <hr/>
      <h3>Konten Utama:</h3>
      <div class="editable-content" data-editable-id="material-content-${materialId}" style="min-height: 300px; border: 1px solid #ccc; padding: 10px;">
        ${material.content}
      </div>
      <div style="margin-top: 20px;">
        <button class="btn-primary save-btn" onclick="saveMaterialContent(${materialId})">Simpan Perubahan</button>
        <button class="btn-primary cancel-btn" onclick="cancelMaterialEdit()">Batal</button>
      </div>
    `;
    enableAdminEditing(); // Make the newly loaded content editable
  }

  /**
   * Saves the edited content of a material.
   * @param {number} materialId - The ID of the material to save.
   */
  function saveMaterialContent(materialId) {
    const titleEl = document.querySelector(`[data-editable-id="material-title-${materialId}"]`);
    const subtitleEl = document.querySelector(`[data-editable-id="material-subtitle-${materialId}"]`);
    const contentEl = document.querySelector(`[data-editable-id="material-content-${materialId}"]`);

    if (materialContents[materialId]) {
      materialContents[materialId].title = titleEl ? titleEl.innerHTML : materialContents[materialId].title;
      materialContents[materialId].subtitle = subtitleEl ? subtitleEl.innerHTML : materialContents[materialId].subtitle;
      materialContents[materialId].content = contentEl ? contentEl.innerHTML : materialContents[materialId].content;
      saveToLocalStorage('materialContents', materialContents);
    }

    // Rebuild sidebar to ensure correct numbering and order
    loadInitialContent(); // This will rebuild the sidebar and re-apply page content
    alert('Konten materi berhasil disimpan (secara lokal)!');
    showMaterial(materialId); // Reload the material to show saved content
  }

  /**
   * Cancels the material editing and reverts to the previous view.
   */
  function cancelMaterialEdit() {
    // Reload the welcome page or the last viewed material
    document.getElementById('pageContent').innerHTML = initialWelcomeContent;
    if (isAdminMode) {
      enableAdminEditing();
    }
    // Re-apply saved page data if any
    loadPageContentFromLocalStorage();
  }

  let nextMaterialId = 7; // Start from the next available ID

// PERBAIKAN: Fungsi tambah materi dengan modal
function addMaterial() {
  if (!isAdminMode) {
    alert('Mode admin diperlukan untuk menambah materi!');
    toggleAdminMode(); // Buka login jika belum
    return;
  }
  const modal = document.getElementById('addMaterialModal');
  if (modal) {
    modal.style.display = 'flex'; // Tampilkan modal
    document.getElementById('new-material-title').focus(); // Fokus ke input judul
  } else {
    alert('Modal tidak ditemukan. Refresh halaman.');
  }
}

function confirmAddMaterial() {
  const title = document.getElementById('new-material-title').value.trim();
  const subtitle = document.getElementById('new-material-subtitle').value.trim();
  const content = document.getElementById('new-material-content').value.trim() || '<p>Konten default. Edit di mode admin untuk menambahkan detail.</p><div class="references"><h4>Referensi</h4><ol><li>Tambahkan referensi di sini.</li></ol></div>';

  if (!title) {
    alert('Judul materi wajib diisi!');
    return;
  }

  // Tambah ke array materials (ID sequential)
  const newId = window.nextMaterialId;
  materialsArray.push({
    id: newId,
    title: `${newId}. ${title}`, // Auto tambah nomor
    subtitle: subtitle || 'Deskripsi default',
    content: content
  });

  // Update next ID
  window.nextMaterialId++;

  // Simpan ke localStorage
  saveToLocalStorage('materialsArray', materialsArray);

  // Clear dan tutup modal
  document.getElementById('new-material-title').value = '';
  document.getElementById('new-material-subtitle').value = '';
  document.getElementById('new-material-content').value = '';
  closeAddMaterialModal();

  // Re-render sidebar untuk tampilkan materi baru
  loadInitialContent();

  alert(`Materi "${title}" berhasil ditambahkan dengan ID ${newId}!`);
  showMaterial(newId); // Load otomatis ke page content
}

function closeAddMaterialModal() {
  const modal = document.getElementById('addMaterialModal');
  if (modal) modal.style.display = 'none';
}

// Helper: Render Sidebar (jika belum ada, tambahkan ini di atas addMaterial)
function renderSidebar() {
  const sidebar = document.getElementById('sidebar');  // Sesuaikan id sidebar
  if (!sidebar) return;

  sidebar.innerHTML = '';  // Clear lama

  materialContents.forEach((material, index) => {
    const item = document.createElement('div');
    item.className = 'sidebar-item';  // Sesuaikan class
    item.innerHTML = `
      <h3>${material.title}</h3>
      <p>${material.description}</p>
      <button onclick="loadMaterial(${index})">Lihat</button>
      <button onclick="editMaterial(${index})">Edit</button>
      <button onclick="deleteMaterial(${index})">Hapus</button>
    `;
    sidebar.appendChild(item);
  });
}

// Helper: Attach Edit Listeners (untuk dynamic item baru, jika event delegation)
function attachEditListeners() {
  const sidebar = document.getElementById('sidebar');
  if (!sidebar) return;

  // Event delegation: Attach ke parent untuk item baru (efisien, no re-attach semua)
  sidebar.addEventListener('click', (e) => {
    if (e.target.textContent === 'Edit') {
      const item = e.target.closest('.sidebar-item');
      const index = Array.from(sidebar.children).indexOf(item);
      editMaterial(index);
    }
  });
}

// Fungsi Load Material (pastikan ini ada dan update untuk tampil analysistools)
function loadMaterial(id) {
  const material = materialContents[id];
  if (!material) return;

  const contentArea = document.getElementById('content-area');  // Sesuaikan id
  contentArea.innerHTML = material.content;  // Load konten (termasuk analysistools jika id match)

  // Highlight active di sidebar (opsional)
  document.querySelectorAll('.sidebar-item').forEach((item, idx) => {
    item.classList.toggle('active', idx === id);
  });

  console.log(`Loaded material ${id}: ${material.title}`);
}

// Fungsi Edit (contoh sederhana, sesuaikan jika ada modal edit)
function editMaterial(id) {
  const material = materialContents[id];
  if (!material) return;

  // Buka modal edit atau isi form (contoh: alert untuk test)
  const newTitle = prompt('Edit judul:', material.title);
  const newDesc = prompt('Edit deskripsi:', material.description);
  const newContent = prompt('Edit konten (HTML):', material.content.substring(0, 100) + '...');

  if (newTitle) {
    material.title = newTitle;
    material.description = newDesc || material.description;
    material.content = newContent || material.content;
    renderSidebar();  // Re-render setelah edit
    if (document.querySelector('.active')) loadMaterial(id);  // Reload jika active
    alert('Materi diupdate!');
  }
}

// Fungsi Delete (untuk lengkap, jika perlu)
function deleteMaterial(id) {
  if (confirm('Hapus materi?')) {
    materialContents.splice(id, 1);
    // Re-index id (opsional, atau gunakan index tetap)
    materialContents.forEach((mat, idx) => mat.id = idx);
    renderSidebar();
    loadMaterial(0);  // Kembali ke materi pertama
    alert('Dihapus!');
  }
}

// PERBAIKAN: Delete dari materialsArray, re-index, re-render
function deleteMaterial(materialId, event) {
  event.stopPropagation();
  if (!isAdminMode) return;

  const material = materialsArray.find(m => m.id == materialId);
  if (!material) return;

  if (confirm(`Hapus "${material.title}"?`)) {
    // Hapus dari array
    const index = materialsArray.findIndex(m => m.id == materialId);
    materialsArray.splice(index, 1);

    // Re-index ID selanjutnya (shift down)
    materialsArray.forEach((mat, idx) => {
      mat.id = idx + 1;
      mat.title = mat.title.replace(/^\d+\.\s*/, '') || mat.title; // Hapus prefix lama
      mat.title = `${mat.id}. ${mat.title}`; // Tambah prefix baru
    });

    // Update next ID
    window.nextMaterialId = materialsArray.length + 1;

    // Simpan
    saveToLocalStorage('materialsArray', materialsArray);

    // Re-render sidebar
    loadInitialContent();

    alert('Materi dihapus dan sidebar di-update!');
    // Kembali ke welcome atau material pertama
    document.getElementById('pageContent').innerHTML = initialWelcomeContent;
  }
}

  /**
   * Enables admin editing for a specific element.
   * @param {HTMLElement} el - The element to make editable.
   */
  function enableAdminEditingForElement(el) {
    el.setAttribute('contenteditable', 'true');
    el.addEventListener('focus', handleEditFocus);
    el.addEventListener('blur', handleEditBlur);
  }

// PERBAIKAN: Load initial content dengan array materials + tools statis
function loadInitialContent() {
  // Load materials dari storage (panggil di sini juga untuk refresh)
  loadMaterialsFromStorage();

  // Load pageData dari localStorage (tetap sama seperti lama)
  const pageData = loadFromLocalStorage('pageData');
  if (pageData) {
    for (const id in pageData) {
      const el = document.querySelector(`[data-editable-id="${id}"]`);
      if (el) el.innerHTML = pageData[id];
    }
  }

  const materialsNav = document.getElementById('materials-sidebar');
  if (!materialsNav) return; // Exit jika sidebar tidak ada

  // Clear sections lama
  const existingSections = materialsNav.querySelectorAll('.materials-section, .tools-section');
  existingSections.forEach(section => section.remove());

  // Buat Materials Section (editable)
  const materialsSection = document.createElement('div');
  materialsSection.classList.add('materials-section');
  materialsSection.innerHTML = `
    <div class="materials-title editable-content" data-editable-id="materials-sidebar-title">Materials</div>
  `;
  materialsNav.appendChild(materialsSection);

  // Render materials dari array (sequential, editable)
  materialsArray.forEach(material => {
    const item = document.createElement('div');
    item.classList.add('material-item');
    item.dataset.materialId = material.id;
    item.onclick = (e) => { e.stopPropagation(); showMaterial(material.id); };
    item.innerHTML = `
      <strong class="editable-content" data-editable-id="material-title-${material.id}">${material.title}</strong>
      <div class="material-subtitle editable-content" data-editable-id="material-subtitle-${material.id}">${material.subtitle}</div>
      <button class="edit-btn" onclick="editMaterial(${material.id}, event)">Edit</button>
      <button class="delete-btn" onclick="deleteMaterial(${material.id}, event)">Hapus</button>
    `;
    materialsSection.appendChild(item);
  });

  // Tambah admin-controls di akhir materials section
  const adminControls = document.createElement('div');
  adminControls.classList.add('admin-controls');
  adminControls.innerHTML = '<button class="add-material-btn" onclick="addMaterial()">+ Tambah Materi</button>';
  materialsSection.appendChild(adminControls);

  // Buat Tools Section (statis, ID string)
  const toolsSection = document.createElement('div');
  toolsSection.classList.add('tools-section');
  toolsSection.innerHTML = `
    <div class="tools-title">Tools</div>
  `;
  toolsArray.forEach(tool => {
    const item = document.createElement('div');
    item.classList.add('material-item');
    item.dataset.materialId = tool.id; // ID string
    item.onclick = (e) => { e.stopPropagation(); showMaterial(tool.id); };
    item.innerHTML = `
      <strong>${tool.title}</strong>
      <div class="material-subtitle">${tool.subtitle}</div>
    `;
    toolsSection.appendChild(item);
  });
  materialsNav.appendChild(toolsSection);

  // Enable editing jika admin mode (tetap sama)
  if (isAdminMode) {
    enableAdminEditing();
  }

  // Set initial welcome content
  initialWelcomeContent = document.getElementById('pageContent').innerHTML;

  console.log('Sidebar re-rendered: Materials count =', materialsArray.length, 'Tools count =', toolsArray.length);
}

  /**
   * Loads general page content (header, footer, welcome text) from local storage.
   */
  function loadPageContentFromLocalStorage() {
    const pageData = loadFromLocalStorage('pageData');
    if (pageData) {
      for (const id in pageData) {
        const el = document.querySelector(`[data-editable-id="${id}"]`);
        if (el) {
          el.innerHTML = pageData[id];
        }
      }
    }
  }

  // --- Analysis Tools Enhancements (Frontend Logic) ---

  // Global variable to store chart instances
  let currentChart = null;

  /**
   * Destroys the current chart instance if it exists.
   */
  function destroyChart() {
    if (currentChart) {
      currentChart.destroy();
      currentChart = null;
    }
  }

  /**
   * Creates a chart in the specified container.
   * @param {string} containerId - The ID of the div where the chart will be placed.
   * @param {string} chartType - The type of chart (e.g., 'bar', 'line', 'scatter', 'pie').
   * @param {object} chartData - The data object for Chart.js.
   * @param {object} chartOptions - The options object for Chart.js.
   */
  function createChart(containerId, chartType, chartData, chartOptions) {
    destroyChart(); // Destroy any existing chart before creating a new one

    const chartContainer = document.getElementById(containerId);
    if (!chartContainer) {
      console.error(`Chart container with ID '${containerId}' not found.`);
      return;
    }

    // Clear previous content and create a new canvas
    chartContainer.innerHTML = '<canvas></canvas>';
    const ctx = chartContainer.querySelector('canvas').getContext('2d');

    currentChart = new Chart(ctx, {
      type: chartType,
      data: chartData,
      options: chartOptions
    });
  }

  /**
   * Parses numerical data from a textarea, handling comma or newline separators.
   * @param {string} textareaId - The ID of the textarea element.
   * @returns {number[]|null} An array of numbers or null if invalid.
   */
  function parseData(textareaId) {
    const dataString = document.getElementById(textareaId)?.value.trim();
    if (!dataString) {
      // alert('Data tidak boleh kosong!'); // Removed alert for better UX, handle null return
      return null;
    }
    // Handle both comma-separated and newline-separated values
    const parsed = dataString.split(/[\n,]+/).map(s => parseFloat(s.trim())).filter(n => !isNaN(n));
    if (parsed.length === 0) {
        // alert('Data tidak valid. Pastikan hanya angka yang dipisahkan koma atau baris baru.'); // Removed alert
        return null;
    }
    return parsed;
  }

  /**
   * Parses multi-group data from a textarea (e.g., for ANOVA).
   * Format: "GroupName: val1, val2, val3\nGroupName2: val4, val5"
   * @param {string} textareaId - The ID of the textarea element.
   * @returns {Array<{name: string, values: number[]}>|null} An array of group objects or null if invalid.
   */
  function parseMultiGroupData(textareaId) {
    const dataString = document.getElementById(textareaId)?.value.trim();
    if (!dataString) {
      // alert('Data tidak boleh kosong!');
      return null;
    }
    const groups = dataString.split('\n').map(line => {
      const parts = line.split(':');
      if (parts.length < 2) return null;
      const groupName = parts[0].trim();
      const values = parts[1].split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n));
      return { name: groupName, values: values };
    }).filter(g => g && g.values.length > 0);

    if (groups.length === 0) {
      // alert('Format data kelompok tidak valid. Gunakan format "NamaKelompok: val1, val2, val3" per baris.');
      return null;
    }
    return groups;
  }

  /**
   * Parses a contingency table from a textarea.
   * Format: "val1, val2\nval3, val4"
   * @param {string} textareaId - The ID of the textarea element.
   * @returns {number[][]|null} A 2D array of numbers or null if invalid.
   */
  function parseContingencyTable(textareaId) {
    const dataString = document.getElementById(textareaId)?.value.trim();
    if (!dataString) {
      // alert('Tabel kontingensi tidak boleh kosong!');
      return null;
    }
    const rows = dataString.split('\n').map(line => {
      return line.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
    }).filter(row => row.length > 0);

    if (rows.length === 0 || rows.some(row => row.length !== rows[0].length)) {
      // alert('Format tabel kontingensi tidak valid. Pastikan semua baris memiliki jumlah kolom yang sama dan hanya berisi angka.');
      return null;
    }
    return rows;
  }

  /**
   * Placeholder for CSV/Excel file upload handling.
   * In a real application, this would involve a backend or a client-side library.
   * @param {string} toolId - The ID of the analysis tool.
   */
  function handleFileUpload(toolId) {
    const fileInput = document.getElementById(`dataFile_${toolId}`);
    if (fileInput && fileInput.files.length > 0) {
      const file = fileInput.files[0];
      alert(`File "${file.name}" diupload. Fungsionalitas parsing file CSV/Excel memerlukan backend atau library JavaScript eksternal (misal: PapaParse untuk CSV, SheetJS untuk Excel) untuk membaca dan memproses data.`);
      // In a real application, you'd use PapaParse for CSV or SheetJS for Excel
      // For now, just simulate variable loading
      const variablesSelect = document.getElementById(`variables_${toolId}`);
      if (variablesSelect) {
        variablesSelect.innerHTML = `
          <option value="var1">Variabel A (Simulasi)</option>
          <option value="var2">Variabel B (Simulasi)</option>
          <option value="var3">Variabel C (Simulasi)</option>
        `;
      }
    }
  }

  /**
   * Toggles the visibility of input method groups (manual, sample, file) for analysis tools.
   * @param {string} toolId - The ID of the analysis tool.
   */
  function toggleInputMethod(toolId) {
    const inputMethodSelect = document.getElementById(`inputMethod_${toolId}`);
    if (!inputMethodSelect) return; // Exit if the tool doesn't have this selector

    const method = inputMethodSelect.value;
    const fileInputGroup = document.querySelector(`.file-input-group_${toolId}`);
    const manualInputGroup = document.querySelector(`.manual-input-group_${toolId}`);
    const sampleInputGroup = document.querySelector(`.sample-input-group_${toolId}`);

    if (fileInputGroup) fileInputGroup.style.display = (method === 'file' ? 'block' : 'none');
    if (manualInputGroup) manualInputGroup.style.display = (method === 'manual' ? 'block' : 'none');
    if (sampleInputGroup) sampleInputGroup.style.display = (method === 'sample' ? 'block' : 'none');

    if (method === 'sample') {
      // loadSampleData(toolId); // Load sample data immediately when selected
    } else if (method === 'manual') {
        // Clear sample data if switching to manual
        const manualDataTextarea = document.getElementById(`manualData_${toolId}`);
        if (manualDataTextarea) manualDataTextarea.value = '';
        // For descriptive, clear variables select
        const variablesSelect = document.getElementById(`variables_${toolId}`);
        if (variablesSelect) variablesSelect.innerHTML = '<option value="Data">Data</option>';
        // For other tools, clear their specific textareas
        if (toolId === 'uji-mean') {
            const sample1_tTest = document.getElementById('sample1_tTest');
            const sample2_tTest = document.getElementById('sample2_tTest');
            if(sample1_tTest) sample1_tTest.value = '';
            if(sample2_tTest) sample2_tTest.value = '';
        } else if (toolId === 'anova') {
            const anovaData = document.getElementById('anovaData');
            if(anovaData) anovaData.value = '';
        } else if (toolId === 'korelasi') {
            const varX_korelasi = document.getElementById('varX_korelasi');
            const varY_korelasi = document.getElementById('varY_korelasi');
            if(varX_korelasi) varX_korelasi.value = '';
            if(varY_korelasi) varY_korelasi.value = '';
        } else if (toolId === 'regresi') {
            const dependentVar_regresi = document.getElementById('dependentVar_regresi');
            const independentVar_regresi = document.getElementById('independentVar_regresi');
            if(dependentVar_regresi) dependentVar_regresi.value = '';
            if(independentVar_regresi) independentVar_regresi.value = '';
        } else if (toolId === 'mann-whitney') {
            const group1_mannwhitney = document.getElementById('group1_mannwhitney');
            const group2_mannwhitney = document.getElementById('group2_mannwhitney');
            if(group1_mannwhitney) group1_mannwhitney.value = '';
            if(group2_mannwhitney) group2_mannwhitney.value = '';
        } else if (toolId === 'chi-square') {
            const contingencyTable = document.getElementById('contingencyTable');
            const observedFrequencies = document.getElementById('observedFrequencies');
            const expectedFrequencies = document.getElementById('expectedFrequencies');
            if(contingencyTable) contingencyTable.value = '';
            if(observedFrequencies) observedFrequencies.value = '';
            if(expectedFrequencies) expectedFrequencies.value = '';
        } else if (toolId === 'clustering') {
            const clusteringData = document.getElementById('clusteringData');
            if(clusteringData) clusteringData.value = '';
        } else if (toolId === 'factor-analysis') {
            const factorAnalysisData = document.getElementById('factorAnalysisData');
            if(factorAnalysisData) factorAnalysisData.value = '';
        } else if (toolId === 'uji-asumsi') {
            const normalitasData = document.getElementById('normalitasData');
            const homogenitasData = document.getElementById('homogenitasData');
            if(normalitasData) normalitasData.value = '';
            if(homogenitasData) homogenitasData.value = '';
        } else if (toolId === 'uji-instrumen') {
            const instrumentData = document.getElementById('instrumentData');
            if(instrumentData) instrumentData.value = '';
        }
    }
  }

  /**
   * Loads sample data into the input fields for a given analysis tool.
   * @param {string} toolId - The ID of the analysis tool.
   */
  function loadSampleData(toolId) {
    const sampleSelect = document.getElementById(`sampleData_${toolId}`);
    if (!sampleSelect) return;

    const selectedSample = sampleSelect.value;

    if (toolId === 'deskriptif') {
      const manualDataTextarea = document.getElementById(`manualData_${toolId}`);
      const variablesSelect = document.getElementById(`variables_${toolId}`);
      let sampleData = '';
      let sampleVariables = [];

      if (selectedSample === 'sample1') {
        sampleData = '120, 150, 130, 180, 140, 160, 170, 190, 155, 165';
        sampleVariables = ['Penjualan'];
      } else if (selectedSample === 'sample2') {
        sampleData = '165, 170, 168, 175, 160, 172, 169, 178, 163, 171';
        sampleVariables = ['Tinggi'];
      }
      if (manualDataTextarea) manualDataTextarea.value = sampleData;
      if (variablesSelect) {
          variablesSelect.innerHTML = sampleVariables.map(v => `<option value="${v}">${v}</option>`).join('');
          if (sampleVariables.length > 0) {
              variablesSelect.value = sampleVariables[0];
          }
      }
    } else if (toolId === 'uji-mean') {
        const sample1Textarea = document.getElementById('sample1_tTest');
        const sample2Textarea = document.getElementById('sample2_tTest');
        const mu0Input = document.getElementById('mu0_tTest');
        const tTestTypeSelect = document.getElementById('tTestType');

        if (selectedSample === 'sample_one_sample') {
            if(sample1Textarea) sample1Textarea.value = '23, 45, 67, 34, 56, 78, 45, 67, 89, 23';
            if(mu0Input) mu0Input.value = '50';
            if(tTestTypeSelect) tTestTypeSelect.value = 'one-sample';
            if(sample2Textarea) sample2Textarea.value = ''; // Clear sample2
        } else if (selectedSample === 'sample_two_sample') {
            if(sample1Textarea) sample1Textarea.value = '23, 45, 67, 34, 56';
            if(sample2Textarea) sample2Textarea.value = '30, 50, 70, 40, 60';
            if(tTestTypeSelect) tTestTypeSelect.value = 'two-sample';
            if(mu0Input) mu0Input.value = '0'; // Reset mu0
        } else if (selectedSample === 'sample_paired') {
            if(sample1Textarea) sample1Textarea.value = '10, 12, 15, 11, 13';
            if(sample2Textarea) sample2Textarea.value = '9, 11, 14, 10, 12';
            if(tTestTypeSelect) tTestTypeSelect.value = 'paired';
            if(mu0Input) mu0Input.value = '0'; // Reset mu0
        }
        updateTTestForm(); // Update form display based on selected type
    } else if (toolId === 'anova') {
        const anovaDataTextarea = document.getElementById('anovaData');
        if (selectedSample === 'sample_one_way') {
            if(anovaDataTextarea) anovaDataTextarea.value = `Kelompok1: 23, 45, 67, 34, 56
Kelompok2: 34, 56, 78, 45, 67
Kelompok3: 45, 67, 89, 56, 78`;
        }
    } else if (toolId === 'korelasi') {
        const varXTextarea = document.getElementById('varX_korelasi');
        const varYTextarea = document.getElementById('varY_korelasi');
        if (selectedSample === 'sample_pearson') {
            if(varXTextarea) varXTextarea.value = '10, 12, 15, 18, 20';
            if(varYTextarea) varYTextarea.value = '25, 28, 30, 35, 38';
        }
    } else if (toolId === 'regresi') {
        const dependentVarTextarea = document.getElementById('dependentVar_regresi');
        const independentVarTextarea = document.getElementById('independentVar_regresi');
        if (selectedSample === 'sample_simple_linear') {
            if(dependentVarTextarea) dependentVarTextarea.value = '25, 28, 30, 35, 38, 40, 42, 45, 48, 50';
            if(independentVarTextarea) independentVarTextarea.value = '10, 12, 15, 18, 20, 22, 25, 28, 30, 32';
        }
    } else if (toolId === 'mann-whitney') {
        const group1Textarea = document.getElementById('group1_mannwhitney');
        const group2Textarea = document.getElementById('group2_mannwhitney');
        if (selectedSample === 'sample_two_groups') {
            if(group1Textarea) group1Textarea.value = '10, 12, 15, 11, 13';
            if(group2Textarea) group2Textarea.value = '14, 16, 13, 17, 15';
        }
    } else if (toolId === 'chi-square') {
        const contingencyTableTextarea = document.getElementById('contingencyTable');
        const observedFrequenciesTextarea = document.getElementById('observedFrequencies');
        const expectedFrequenciesTextarea = document.getElementById('expectedFrequencies');
        const chiSquareTypeSelect = document.getElementById('chiSquareType');

        if (selectedSample === 'sample_independence') {
            if(contingencyTableTextarea) contingencyTableTextarea.value = '10, 20\n15, 5';
            if(chiSquareTypeSelect) chiSquareTypeSelect.value = 'independence';
            if(observedFrequenciesTextarea) observedFrequenciesTextarea.value = ''; // Clear other type's data
            if(expectedFrequenciesTextarea) expectedFrequenciesTextarea.value = '';
        } else if (selectedSample === 'sample_goodness_of_fit') {
            if(observedFrequenciesTextarea) observedFrequenciesTextarea.value = '20, 30, 50';
            if(expectedFrequenciesTextarea) expectedFrequenciesTextarea.value = '25, 25, 50';
            if(chiSquareTypeSelect) chiSquareTypeSelect.value = 'goodness-of-fit';
            if(contingencyTableTextarea) contingencyTableTextarea.value = ''; // Clear other type's data
        }
        updateChiSquareForm(); // Update form display
    } else if (toolId === 'clustering') {
        const clusteringDataTextarea = document.getElementById('clusteringData');
        if (selectedSample === 'sample_2d') {
            if(clusteringDataTextarea) clusteringDataTextarea.value = '1.0, 1.1\n1.0, 1.2\n3.0, 3.1\n3.1, 3.0\n1.2, 1.0\n3.2, 3.2\n5.0, 5.1\n5.2, 5.0';
            const numClusters = document.getElementById('numClusters');
            if(numClusters) numClusters.value = '3';
        }
    } else if (toolId === 'factor-analysis') {
        const factorAnalysisDataTextarea = document.getElementById('factorAnalysisData');
        if (selectedSample === 'sample_3vars') {
            if(factorAnalysisDataTextarea) factorAnalysisDataTextarea.value = '10, 12, 11\n15, 14, 16\n20, 22, 21\n11, 13, 10\n16, 15, 17\n21, 23, 20\n12, 14, 13\n17, 16, 18\n22, 24, 23\n13, 15, 12';
            const numFactors = document.getElementById('numFactors');
            if(numFactors) numFactors.value = '1';
        }
    } else if (toolId === 'uji-asumsi') {
        const normalitasDataTextarea = document.getElementById('normalitasData');
        const homogenitasDataTextarea = document.getElementById('homogenitasData');
        const assumptionTestTypeSelect = document.getElementById('assumptionTestType');

        if (selectedSample === 'sample_normalitas') {
            if(normalitasDataTextarea) normalitasDataTextarea.value = '23, 45, 67, 34, 56, 78, 45, 67, 89, 23, 50, 55, 60, 65, 70';
            if(assumptionTestTypeSelect) assumptionTestTypeSelect.value = 'normalitas';
            if(homogenitasDataTextarea) homogenitasDataTextarea.value = '';
        } else if (selectedSample === 'sample_homogenitas') {
            if(homogenitasDataTextarea) homogenitasDataTextarea.value = 'Kelompok1: 23, 45, 67, 30, 40\nKelompok2: 34, 56, 78, 45, 55\nKelompok3: 40, 60, 80, 50, 70';
            if(assumptionTestTypeSelect) assumptionTestTypeSelect.value = 'homogenitas';
            if(normalitasDataTextarea) normalitasDataTextarea.value = '';
        }
        updateAssumptionTestForm();
    } else if (toolId === 'uji-instrumen') {
        const instrumentDataTextarea = document.getElementById('instrumentData');
        if (selectedSample === 'sample_instrument') {
            if(instrumentDataTextarea) instrumentDataTextarea.value = '1, 2, 3\n2, 3, 4\n3, 4, 5\n4, 5, 4\n5, 4, 3\n1, 1, 2\n2, 2, 3\n3, 3, 4\n4, 4, 5\n5, 5, 4\n1, 2, 2\n2, 3, 3\n3, 4, 4\n4, 5, 5\n5, 4, 4';
        }
    }
  }

  // --- Placeholder functions for running analysis (will require backend integration) ---
  // These functions now include basic statistical calculations for demonstration.
  // For robust, production-ready statistics, a backend (Python/R) or a comprehensive JS library is needed.

  // Basic statistical functions (for frontend simulation)
  const calculateMean = (arr) => arr.reduce((a, b) => a + b, 0) / arr.length;
  const calculateMedian = (arr) => {
    const sorted = [...arr].sort((a, b) => a - b);
    const mid = Math.floor(sorted.length / 2);
    return sorted.length % 2 === 0 ? (sorted[mid - 1] + sorted[mid]) / 2 : sorted[mid];
  };
  const calculateMode = (arr) => {
    const counts = {};
    arr.forEach(x => { counts[x] = (counts[x] || 0) + 1; });
    let mode = [];
    let maxCount = 0;
    for (const key in counts) {
      if (counts[key] > maxCount) {
        mode = [parseFloat(key)];
        maxCount = counts[key];
      } else if (counts[key] === maxCount) {
        mode.push(parseFloat(key));
      }
    }
    return mode.join(', ');
  };
  const calculateVariance = (arr, mean) => arr.reduce((sum, x) => sum + Math.pow(x - mean, 2), 0) / (arr.length - 1);
  const calculateStdDev = (arr, mean) => Math.sqrt(calculateVariance(arr, mean));
  function calculateCustomQuartile(data, quartile) {
  const sorted = [...data].sort((a, b) => a - b);
  const n = sorted.length;
  const index = (n + 1) * (quartile / 4) - 1;
  if (index % 1 === 0) return sorted[Math.floor(index)];
  const lower = Math.floor(index);
  const upper = Math.ceil(index);
  return sorted[lower] + (sorted[upper] - sorted[lower]) * (index - lower);
}
  const calculatePearsonCorrelation = (x, y) => {
    const n = x.length;
    const meanX = calculateMean(x);
    const meanY = calculateMean(y);
    let sumXY = 0;
    let sumX2 = 0;
    let sumY2 = 0;
    for (let i = 0; i < n; i++) {
      sumXY += (x[i] - meanX) * (y[i] - meanY);
      sumX2 += Math.pow((x[i] - meanX), 2);
      sumY2 += Math.pow((y[i] - meanY), 2);
    }
    return sumXY / (Math.sqrt(sumX2) * Math.sqrt(sumY2));
  };
  // Simplified t-distribution critical value lookup (very rough approximation)
  const getZCritical = (alpha, twoTailed = true) => {
      if (alpha === 0.05) return twoTailed ? 1.96 : 1.645;
      if (alpha === 0.01) return twoTailed ? 2.576 : 2.326;
      if (alpha === 0.10) return twoTailed ? 1.645 : 1.28;
      return 1.96;
  };

/**
 * Runs descriptive statistical analysis on input data.
 */
function runDescriptive() {
  const manualData = document.getElementById('manualData_deskriptif').value.trim();
  const inputMethod = document.getElementById('inputMethod_deskriptif').value;
  let data = [];

  try {
    // Parse data berdasarkan metode input (tetap sama)
    if (inputMethod === 'manual' && manualData) {
      data = manualData.split(/[\s,;\n]+/).map(num => parseFloat(num.trim())).filter(num => !isNaN(num));
    } else if (inputMethod === 'sample') {
      const sampleSelect = document.getElementById('sampleData_deskriptif');
      if (sampleSelect.value === 'sample1') {
        data = [120, 150, 180, 200, 170, 190, 160, 140, 210, 155]; // Sample penjualan
      } else if (sampleSelect.value === 'sample2') {
        data = [165, 170, 162, 175, 168, 172, 160, 178, 169, 174]; // Sample tinggi badan
      }
    } else if (inputMethod === 'file') {
      data = [23, 45, 67, 34, 56, 78, 45, 67, 89, 23]; // Fallback sample
      alert('Upload file simulasi: Menggunakan data sample default.');
    }

    if (data.length === 0) {
      throw new Error('Tidak ada data valid. Pastikan input manual atau pilih sample.');
    }

    // Set global data untuk chart
    window.currentDescriptiveData = [...data];

    // Hitung statistik deskriptif (tetap sama)
    const n = data.length;
    const mean = data.reduce((a, b) => a + b, 0) / n;
    const sortedData = [...data].sort((a, b) => a - b);
    const median = n % 2 === 0 ? (sortedData[n/2 - 1] + sortedData[n/2]) / 2 : sortedData[Math.floor(n/2)];
    const mode = findMode(data);
    const range = Math.max(...data) - Math.min(...data);
    const variance = data.reduce((sum, num) => sum + Math.pow(num - mean, 2), 0) / n;
    const stdDev = Math.sqrt(variance);
    const q1Index = Math.floor((n + 1) / 4) - 1;
    const q3Index = Math.floor(3 * (n + 1) / 4) - 1;
    const q1 = n > 0 ? sortedData[q1Index] || 'N/A' : 'N/A';
    const q3 = n > 0 ? sortedData[q3Index] || 'N/A' : 'N/A';
    const iqr = (q1 !== 'N/A' && q3 !== 'N/A') ? (q3 - q1).toFixed(2) : 'N/A';

    // **PERBAIKAN: Tampilkan hasil dalam tabel rapi**
    const resultsDiv = document.getElementById('descriptiveResults');
    resultsDiv.innerHTML = `
      <h3>Hasil Analisis Statistik Deskriptif</h3>
      <p><em>Data: ${n} observasi. Contoh: ${data.slice(0, 5).join(', ')}${data.length > 5 ? '...' : ''}</em></p>
      
      <!-- Tabel Output Rapi -->
      <div class="table-container">
        <table class="descriptive-table">
          <thead>
            <tr>
              <th>Ukuran Statistik</th>
              <th>Nilai</th>
            </tr>
          </thead>
          <tbody>
            <tr><td>Jumlah Data (n)</td><td>${n}</td></tr>
            <tr><td>Mean (Rata-rata)</td><td>${mean.toFixed(2)}</td></tr>
            <tr><td>Median</td><td>${median.toFixed(2)}</td></tr>
            <tr><td>Modus</td><td>${mode ? mode.toFixed(2) : 'Tidak ada'}</td></tr>
            <tr><td>Range (Rentang)</td><td>${range.toFixed(2)}</td></tr>
            <tr><td>Variansi</td><td>${variance.toFixed(2)}</td></tr>
            <tr><td>Deviasi Standar</td><td>${stdDev.toFixed(2)}</td></tr>
            <tr><td>Kuartil 1 (Q1)</td><td>${typeof q1 === 'number' ? q1.toFixed(2) : q1}</td></tr>
            <tr><td>Kuartil 3 (Q3)</td><td>${typeof q3 === 'number' ? q3.toFixed(2) : q3}</td></tr>
            <tr><td>Interkuartil Range (IQR)</td><td>${iqr}</td></tr>
          </tbody>
        </table>
      </div>
      
      <!-- Opsional: Tambah interpretasi singkat -->
      <div class="interpretation" style="margin-top: 15px; padding: 10px; background: #f5f5f5; border-left: 4px solid #2196f3; border-radius: 4px;">
        <h4>Interpretasi Singkat:</h4>
        <ul>
          <li><strong>Mean & Median</strong>: Ukuran pemusatan data. Jika berbeda jauh, data mungkin skewed.</li>
          <li><strong>Deviasi Standar</strong>: Tingkat penyebaran data dari mean (semakin tinggi, semakin bervariasi).</li>
          <li><strong>IQR</strong>: Penyebaran 50% data tengah, tahan terhadap outlier.</li>
        </ul>
      </div>
    `;

    // Render histogram default (tetap sama)
    renderDescriptiveChart(window.currentDescriptiveData, 'histogram');

    // Enable dan show dropdown, attach listener (tetap sama seperti sebelumnya)
    const chartTypeSelect = document.getElementById('chartType_deskriptif');
    const chartSelectorContainer = document.getElementById('chartSelectorContainer_deskriptif');
    if (chartTypeSelect && chartSelectorContainer) {
      chartTypeSelect.disabled = false;
      chartSelectorContainer.style.display = 'block';
      chartTypeSelect.removeEventListener('change', handleChartTypeChange);
      chartTypeSelect.addEventListener('change', handleChartTypeChange);
      console.log('Event listener untuk dropdown deskriptif terpasang.');
    }

  } catch (error) {
    console.error('Error di runDescriptive:', error);
    document.getElementById('descriptiveResults').innerHTML = `
      <p style="color: #f44336;">Error: ${error.message}. Silakan periksa input data.</p>
    `;
  }
}

function findMode(data) {
  const freqMap = {};
  data.forEach(num => freqMap[num] = (freqMap[num] || 0) + 1);
  const maxFreq = Math.max(...Object.values(freqMap));
  const modes = Object.keys(freqMap).filter(key => freqMap[key] === maxFreq);
  return modes.length === 1 ? parseFloat(modes[0]) : null; // Single mode or null
}

// **PERBAIKAN: Fungsi helper untuk handle change event (pisah untuk modularitas)**
function handleChartTypeChange() {
  const chartType = this.value; // 'this' adalah select element
  if (window.currentDescriptiveData && window.currentDescriptiveData.length > 0) {
    console.log(`Mengubah grafik ke: ${chartType}`);
    // Tambah loading brief
    const chartCanvas = document.getElementById('descriptiveChart');
    if (chartCanvas) {
      chartCanvas.innerHTML = '<div style="text-align: center; padding: 20px;">Loading grafik...</div>';
    }
    renderDescriptiveChart(window.currentDescriptiveData, chartType);
  } else {
    console.warn('Data deskriptif tidak tersedia untuk render.');
    alert('Data tidak tersedia. Jalankan analisis ulang terlebih dahulu.');
  }
}

// **FUNGSI BARU: Helper untuk menghitung bins frekuensi (untuk Histogram, Pie, Bar, Ogive)**
/**
 * Menghitung bins frekuensi sederhana untuk data numerik.
 * Menggunakan Sturges' rule untuk jumlah bins (k ≈ 1 + log2(n)).
 * @param {number[]} data - Array data numerik.
 * @returns {object} {labels: string[], frequencies: number[]}
 */
function getHistogramBins(data) {
  if (!data || data.length < 2) {
    console.warn('Data terlalu sedikit untuk bins. Mengembalikan empty bins.');
    return { labels: [], frequencies: [] };
  }

  const n = data.length;
  const min = Math.min(...data);
  const max = Math.max(...data);
  const range = max - min;
  
  // Sturges' rule: k = 1 + log2(n), minimal 5 bins
  const numBins = Math.max(5, Math.floor(1 + Math.log2(n)));
  const binWidth = range / numBins;
  
  const bins = new Array(numBins).fill(0);
  const labels = [];

  for (let i = 0; i < numBins; i++) {
    const lower = min + i * binWidth;
    const upper = lower + binWidth;
    labels.push(`${lower.toFixed(1)} - ${upper.toFixed(1)}`);
  }

  data.forEach(val => {
    const binIndex = Math.min(Math.floor((val - min) / binWidth), numBins - 1);
    bins[binIndex]++;
  });

  return { labels, frequencies: bins };
}

// **FUNGSI UTAMA PERBAIKAN: renderDescriptiveChart (GANTI SELURUH FUNGSI LAMA DENGAN INI)**
/**
 * Renders dynamic chart for descriptive analysis based on selected type.
 * @param {number[]} data - The input data array.
 * @param {string} chartType - The selected chart type.
 */
function renderDescriptiveChart(data, chartType) {
  const chartContainer = document.getElementById('descriptiveChartContainer');
  const chartTitle = document.getElementById('chartTitle');
  const chartCanvas = document.getElementById('descriptiveChart');
  
  if (!chartContainer || !chartTitle || !chartCanvas) {
    console.error('Chart elements not found.');
    return;
  }

  // **PERBAIKAN: Validasi data minimal (minimal 2 poin untuk semua chart)**
  if (!data || data.length < 2) {
    chartCanvas.innerHTML = `
      <div style="text-align: center; padding: 20px; color: #f44336; font-weight: bold;">
        <p>⚠️ Data tidak cukup untuk membuat chart.</p>
        <p>Minimal 2 observasi diperlukan. Tambahkan data lebih banyak.</p>
        <button onclick="runDescriptive()" style="margin-top: 10px; padding: 5px 10px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer;">
          Coba Lagi
        </button>
      </div>
    `;
    chartContainer.style.display = 'block';
    return;
  }

  // **PERBAIKAN: Destroy chart instance secara robust (gunakan Chart.js v3+ method)**
  if (window.descriptiveChartInstance) {
    try {
      window.descriptiveChartInstance.destroy();
      console.log('Previous chart destroyed successfully.');
    } catch (error) {
      console.warn('Error destroying previous chart:', error);
    }
    window.descriptiveChartInstance = null;
  }

  // Sort data for some charts
  const sortedData = [...data].sort((a, b) => a - b);
  let chartConfig = null;
  let titleText = '';

  // **PERBAIKAN: Reset canvas div ke empty sebelum switch**
  chartCanvas.innerHTML = ''; // Clear previous content

  try {
    switch (chartType) {
      case 'line':
        titleText = 'Line Chart: Tren Data';
        chartConfig = generateLineChart(sortedData);
        break;
      case 'pie':
        titleText = 'Pie Chart: Proporsi Frekuensi';
        chartConfig = generatePieChart(data);
        break;
      case 'bar':
        titleText = 'Bar Chart: Frekuensi Bins';
        chartConfig = generateBarChart(data);
        break;
      case 'histogram':
        titleText = 'Histogram: Distribusi Frekuensi';
        chartConfig = generateHistogram(data);
        break;
      case 'ogive':
        titleText = 'Ogive: Frekuensi Kumulatif Kurang Dari & Lebih Dari';
        chartConfig = generateOgive(data);
        break;
      case 'boxplot':
        titleText = 'Box Plot: Ringkasan Distribusi';
        chartConfig = generateBoxPlot(data);
        if (!chartConfig) throw new Error('Data tidak cukup untuk Box Plot (minimal 4 poin).');
        break;
      case 'stemleaf':
        titleText = 'Stem-and-Leaf Plot: Representasi Teks';
        renderStemLeaf(data); // Non-chart, render as text
        chartContainer.style.display = 'block';
        return; // Exit early for text-based plot
      default:
        titleText = 'Histogram: Distribusi Frekuensi (Default)';
        chartConfig = generateHistogram(data);
    }

    chartTitle.textContent = titleText;
    chartContainer.style.display = 'block';

    // **PERBAIKAN: Handle Null Config dengan fallback histogram**
    if (!chartConfig) {
      console.warn(`Chart config is null for type '${chartType}'. Fallback ke histogram.`);
      chartConfig = generateHistogram(data);
    }

    // **PERBAIKAN: Buat canvas ELEKSIWIT dengan error handling**
    chartCanvas.innerHTML = '<canvas id="descriptiveCanvas"></canvas>'; // Tambah ID unik untuk canvas
    const canvasElement = document.getElementById('descriptiveCanvas');
    if (!canvasElement) throw new Error('Canvas creation failed.');
    
    const ctx = canvasElement.getContext('2d');
    if (!ctx) throw new Error('getContext failed.');

    window.descriptiveChartInstance = new Chart(ctx, chartConfig);
    console.log(`Chart '${chartType}' berhasil dibuat.`);

  } catch (error) {
    console.error('Error saat membuat chart:', error);
    chartCanvas.innerHTML = `
      <div style="text-align: center; padding: 20px; color: #f44336; font-weight: bold;">
        <p>⚠️ Error saat merender chart '${chartType}': ${error.message}</p>
        <p>Silakan periksa data input atau pilih chart lain.</p>
        <button onclick="runDescriptive()" style="margin-top: 10px; padding: 5px 10px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer;">
          Coba Lagi
        </button>
      </div>
    `;
  }
}

/**
 * Generates Line Chart config for sorted data.
 * @param {number[]} data - Sorted data.
 * @returns {object} Chart.js config.
 */
function generateLineChart(data) {
  return {
    type: 'line',
    data: {
      labels: data.map((_, i) => `Poin ${i + 1}`),
      datasets: [{
        label: 'Nilai Data',
        data: data,
        borderColor: 'rgb(75, 192, 192)',
        backgroundColor: 'rgba(75, 192, 192, 0.2)',
        tension: 0.1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { title: { display: true, text: 'Line Chart' } },
      scales: { y: { beginAtZero: true } }
    }
  };
}

/**
 * Generates Pie Chart config from frequency bins.
 * @param {number[]} data - Input data.
 * @returns {object} Chart.js config.
 */
function generatePieChart(data) {
  const bins = getHistogramBins(data);
  const labels = bins.labels;
  const frequencies = bins.frequencies;
  return {
    type: 'pie',
    data: {
      labels: labels,
      datasets: [{
        data: frequencies,
        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { title: { display: true, text: 'Pie Chart' } }
    }
  };
}

/**
 * Generates Bar Chart config from frequency bins.
 * @param {number[]} data - Input data.
 * @returns {object} Chart.js config.
 */
function generateBarChart(data) {
  const bins = getHistogramBins(data);
  return {
    type: 'bar',
    data: {
      labels: bins.labels,
      datasets: [{
        label: 'Frekuensi',
        data: bins.frequencies,
        backgroundColor: 'rgba(153, 102, 255, 0.6)',
        borderColor: 'rgba(153, 102, 255, 1)'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { title: { display: true, text: 'Bar Chart' } },
      scales: { y: { beginAtZero: true } }
    }
  };
}

/**
 * Generates Histogram config.
 * @param {number[]} data - Input data.
 * @returns {object} Chart.js config.
 */
function generateHistogram(data) {
  const bins = getHistogramBins(data);
  return {
    type: 'bar',
    data: {
      labels: bins.labels,
      datasets: [{
        label: 'Frekuensi',
        data: bins.frequencies,
        backgroundColor: 'rgba(75, 192, 192, 0.6)',
        borderColor: 'rgba(75, 192, 192, 1)'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { title: { display: true, text: 'Histogram' } },
      scales: {
        x: { title: { display: true, text: 'Interval' } },
        y: { beginAtZero: true, title: { display: true, text: 'Frekuensi' } }
      }
    }
  };
}

/**
 * Generates Ogive (Cumulative Frequency) config.
 * @param {number[]} data - Input data.
 * @returns {object} Chart.js config.
 */
function generateOgive(data) {
  if (!data || data.length < 5) {
    console.warn('Data terlalu sedikit untuk ogive (minimal 5 observasi). Fallback ke line sederhana.');
    // Fallback: Simple cumulative line jika data kurang
    const sortedData = [...data].sort((a, b) => a - b);
    const cumulative = sortedData.map((_, i) => (i + 1) / data.length * 100);
    return {
      type: 'line',
      data: {
        labels: sortedData,
        datasets: [{
          label: 'Kumulatif Sederhana (Fallback)',
          data: cumulative,
          borderColor: 'rgb(75, 192, 192)',
          backgroundColor: 'rgba(75, 192, 192, 0.2)',
          tension: 0.1,
          fill: false
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,  // PERBAIKAN: Set false untuk responsive di mobile
        layout: {
          padding: { left: 10, right: 10, top: 10, bottom: 20 }  // PERBAIKAN: Tambah padding bottom untuk ruang sumbu X
        },
        plugins: {
          title: { display: true, text: 'Ogive Sederhana (Data Kurang)' },
          legend: { display: true },
          tooltip: { enabled: true }
        },
        scales: {
          x: {
            title: { display: true, text: 'Batas Kelas' },
            ticks: { 
              maxRotation: 45,  // PERBAIKAN: Rotasi label X di mobile untuk hindari overlap
              minRotation: 0 
            },
            grid: { display: true }
          },
          y: {
            title: { display: true, text: 'Frekuensi Kumulatif (%)' },
            min: 0,
            max: 100,  // PERBAIKAN: Eksplisit max 100 untuk konsistensi
            ticks: { 
              callback: function(value) { return value + '%'; }, 
              stepSize: 10 
            },
            grid: { display: true }
          }
        },
        elements: { point: { radius: 3 } },  // PERBAIKAN: Kurangi ukuran titik di mobile
        interaction: { mode: 'index', intersect: false }  // Tooltip lebih mudah di-touch di HP
      }
    };
  }

  // Sort data dan hitung jumlah bins (Sturges' rule)
  const sortedData = [...data].sort((a, b) => a - b);
  const n = data.length;
  const numBins = Math.max(3, Math.floor(1 + Math.log2(n))); // Minimal 3 bins
  const minVal = Math.min(...data);
  const maxVal = Math.max(...data);
  const binWidth = (maxVal - minVal) / numBins;

  // Buat bins: lower dan upper limits
  const bins = [];
  const upperLimits = []; // Untuk x-axis (batas atas bin)
  for (let i = 0; i < numBins; i++) {
    const lower = minVal + i * binWidth;
    const upper = lower + binWidth;
    bins.push({ lower, upper });
    upperLimits.push(upper);
  }
  upperLimits.push(maxVal + binWidth); // Tambah bin terakhir untuk 100%

  // Hitung frekuensi untuk setiap bin
  const frequencies = bins.map(bin => 
    data.filter(val => val > bin.lower && val <= bin.upper).length / n * 100 // Relatif %
  );

  // Kumulatif Kurang Dari (Less Than): Naik dari kiri
  const cumLessThan = [];
  let cumSum = 0;
  frequencies.forEach(freq => {
    cumSum += freq;
    cumLessThan.push(Math.round(cumSum * 100) / 100); // Round ke 2 desimal
  });

  // Kumulatif Lebih Dari (More Than): Turun dari kanan (100% - cumLessThan terbalik)
  const cumMoreThan = [];
  for (let i = cumLessThan.length - 1; i >= 0; i--) {
    cumMoreThan.push(100 - (cumLessThan[i] || 0));
  }
  cumMoreThan.reverse(); // Balik agar align dengan x-axis

  // Labels x: Batas atas bin (untuk ogive)
  const labels = upperLimits.map(limit => Math.round(limit * 100) / 100).slice(0, -1); // Exclude extra

  return {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Kumulatif Kurang Dari (<)',
          data: cumLessThan,
          borderColor: 'rgb(54, 162, 235)', // Biru
          backgroundColor: 'rgba(54, 162, 235, 0.1)',
          tension: 0.3, // Smooth curve
          fill: false,
          pointRadius: 4,
          pointBackgroundColor: 'rgb(54, 162, 235)'
        },
        {
          label: 'Kumulatif Lebih Dari (>)',
          data: cumMoreThan,
          borderColor: 'rgb(255, 159, 64)', // Merah
          backgroundColor: 'rgba(255, 159, 64, 0.1)',
          tension: 0.3,
          fill: false,
          pointRadius: 4,
          pointBackgroundColor: 'rgb(255, 159, 64)'
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,  // PERBAIKAN: Set false untuk isi container penuh di mobile
      layout: {
        padding: { left: 10, right: 10, top: 10, bottom: 20 }  // PERBAIKAN: Padding bottom untuk ruang sumbu X
      },
      interaction: { mode: 'index', intersect: false }, // Tooltip untuk kedua line
      plugins: {
        title: { 
          display: true, 
          text: 'Ogive: Frekuensi Kumulatif Kurang Dari & Lebih Dari',
          font: { size: 16 }
        },
        legend: { 
          display: true, 
          position: 'top' 
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `${context.dataset.label}: ${context.parsed.y.toFixed(2)}%`;
            }
          }
        }
      },
      scales: {
        x: { 
          title: { display: true, text: 'Batas Kelas (Upper Limits)' },
          ticks: { 
            maxRotation: 45,  // PERBAIKAN: Rotasi label X di mobile
            minRotation: 0 
          },
          grid: { display: true }
        },
        y: { 
          title: { display: true, text: 'Frekuensi Kumulatif (%)' },
          min: 0,
          max: 100,
          ticks: { 
            callback: function(value) { return value + '%'; },
            stepSize: 10
          },
          grid: { display: true }
        }
      },
      elements: {
        point: { radius: 4 } // Titik lebih jelas
      }
    }
  };
}

// **FUNGSI PERBAIKAN: Generate Box Plot (Versi Baru dengan Bentuk Beraturan)**
/**
 * Generates Chart.js config for Box Plot simulation.
 * @param {number[]} data - Input data array.
 * @returns {object|null} Chart config or null if data insufficient.
 */
function generateBoxPlot(data) {
  const sorted = [...data].sort((a, b) => a - b);
  const n = sorted.length;
  if (n < 4) {
    console.warn('Data terlalu sedikit untuk box plot (minimal 4 poin). Mengembalikan null.');
    return null;
  }

  // Hitung quartiles dan median (asumsi calculateMedian sudah ada; jika tidak, gunakan yang di bawah)
  const q1Index = Math.floor((n + 1) / 4);
  const q2Index = Math.floor(1 * (n + 1) / 2);
  const q3Index = Math.floor(3 * (n + 1) / 4);
  const q1 = sorted.slice(0, q1Index).length > 0 ? calculateMedian(sorted.slice(0, q1Index)) : sorted[0];
  const median = calculateMedian(sorted);
  const q3 = sorted.slice(q3Index).length > 0 ? calculateMedian(sorted.slice(q3Index)) : sorted[n - 1];
  
  const q2 = median;
  const iqr = q3 - q1;
  const lowerFence = q1 - 1.5 * iqr;
  const upperFence = q3 + 1.5 * iqr;

  // Whiskers: min/max non-outlier (gunakan Math.max/min dengan filter)
  const upperWhisker = Math.max(...sorted.filter(x => x >= lowerFence));
  const lowerWhisker = Math.min(...sorted.filter(x => x <= upperFence));
  const outliers = sorted.filter(x => x < lowerFence || x > upperFence);

  // Koordinat untuk kotak (lebar: 0.8-1.2 untuk simetri)
  const left = 0.8;
  const right = 1.2;
  const center = 1.0;

  // Dataset 1: Garis horizontal Q1 (bawah kotak)
  const q1Line = [
    { x: left, y: q1 },
    { x: right, y: q1 }
  ];

  // Dataset 2: Garis horizontal Q3 (atas kotak)
  const q3Line = [
    { x: left, y: q3 },
    { x: right, y: q3 }
  ];

  // Dataset 3: Garis vertikal sisi kotak (kiri dan kanan)
  const boxSides = [
    { x: left, y: q1 }, { x: left, y: q3 },  // Kiri
    { x: right, y: q3 }, { x: right, y: q1 } // Kanan (tutup loop jika perlu)
  ];

  // Dataset 4: Garis horizontal median (di tengah kotak)
  const medianLine = [
    { x: left, y: median },
    { x: right, y: median }
  ];

  // Dataset 5: Whisker bawah (vertikal dari Q1 ke lowerWhisker)
  const lowerWhiskerLine = [
    { x: center, y: q1 },
    { x: center, y: lowerWhisker }
  ];

  // Dataset 6: Whisker atas (vertikal dari Q3 ke upperWhisker)
  const upperWhiskerLine = [
    { x: center, y: q3 },
    { x: center, y: upperWhisker }
  ];

  // Dataset 7: Titik outliers (jika ada)
  const outlierPoints = outliers.map(out => ({ x: center, y: out }));

  // Dataset 8: Titik Q1 dan Q3 (opsional, untuk highlight)
  const quartilePoints = [
    { x: center, y: q1 },
	{ x: center, y: q2 },
    { x: center, y: q3 }
  ];

  return {
    type: 'scatter', // Base type untuk semua line/scatter
    data: {
      datasets: [
        // Kotak: Garis horizontal Q1 dan Q3
        {
          label: 'Q1 (25th Percentile)',
          data: q1Line,
          type: 'line',
          borderColor: 'rgb(75, 192, 192)',
          backgroundColor: 'rgba(75, 192, 192, 0.2)',
          borderWidth: 3,
          fill: false,
          showLine: true,
          pointRadius: 0,
          tension: 0
        },
        {
          label: 'Q3 (75th Percentile)',
          data: q3Line,
          type: 'line',
          borderColor: 'rgb(75, 192, 192)',
          backgroundColor: 'rgba(75, 192, 192, 0.2)',
          borderWidth: 3,
          fill: false,
          showLine: true,
          pointRadius: 0,
          tension: 0
        },
        // Sisi vertikal kotak (garis pendek)
        {
          label: 'Box Sides',
          data: boxSides,
          type: 'line',
          borderColor: 'rgb(75, 192, 192)',
          backgroundColor: 'rgba(75, 192, 192, 0.2)',
          borderWidth: 2,
          fill: false,
          showLine: true,
          pointRadius: 0,
          tension: 0
        },
        // Median line
        {
          label: 'Q2 (50th Percentile)',
          data: medianLine,
          type: 'line',
          borderColor: 'rgb(255, 99, 132)',
          backgroundColor: 'rgba(255, 99, 132, 0.2)',
          borderWidth: 3,
          fill: false,
          showLine: true,
          pointRadius: 3,
          tension: 0
        },
        // Lower whisker
        {
          label: 'Lower whisker',
          data: lowerWhiskerLine,
          type: 'line',
          borderColor: 'rgb(54, 162, 235)',
          backgroundColor: 'rgba(54, 162, 235, 0.2)',
          borderWidth: 2,
          fill: false,
          showLine: true,
          pointRadius: 3, // Titik kecil di ujung
          tension: 0
        },
        // Upper whisker
        {
          label: 'Upper whisker',
          data: upperWhiskerLine,
          type: 'line',
          borderColor: 'rgb(54, 162, 235)',
          backgroundColor: 'rgba(54, 162, 235, 0.2)',
          borderWidth: 2,
          fill: false,
          showLine: true,
          pointRadius: 3,
          tension: 0
        },
        // Outliers (jika ada)
        ...(outliers.length > 0 ? [{
          label: 'Outliers',
          data: outlierPoints,
          type: 'scatter',
          backgroundColor: 'rgba(255, 99, 132, 0.8)',
          borderColor: 'rgba(255, 99, 132, 1)',
          pointRadius: 6,
          pointStyle: 'circle',
          showLine: false
        }] : []),
        // Highlight Q1, Q2 dan Q3 (opsional)
        {
          label: 'Quartiles',
          data: quartilePoints,
          type: 'scatter',
          backgroundColor: 'rgb(75, 192, 192)',
          borderColor: 'rgb(75, 192, 192)',
          pointRadius: 3, // 0 jika tidak perlu
          showLine: false
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: { display: true, text: 'Box Plot: Ringkasan Distribusi' },
        legend: { display: true, position: 'bottom' }
      },
      scales: {
        x: {
          type: 'linear',
          position: 'bottom',
          min: 0.5,
          max: 1.5,
          ticks: { 
            display: false, // Hilangkan ticks x untuk clean look
            stepSize: 0.1
          },
          grid: { display: false } // No grid x
        },
        y: {
          title: { display: true, text: 'Nilai Data' },
          beginAtZero: false, // Mulai dari min data jika negatif
          grid: { color: 'rgba(0,0,0,0.1)' }
        }
      },
      interaction: {
        intersect: false,
        mode: 'point'
      }
    }
  };
}

// **FUNGSI PERBAIKAN: Render Stem-and-Leaf Plot**
function renderStemLeaf(data) {
  if (!data || data.length < 2) {
    const chartCanvas = document.getElementById('descriptiveChart');
    chartCanvas.innerHTML = `
      <div style="text-align: center; padding: 20px; color: #f44336; font-weight: bold;">
        <p>⚠️ Data tidak cukup untuk Stem-and-Leaf Plot.</p>
        <p>Minimal 2 observasi diperlukan.</p>
      </div>
    `;
    return;
  }

  const sorted = [...data].sort((a, b) => a - b);
  const stemMultiplier = 10;
  const stems = {};
  
  sorted.forEach(val => {
    const stem = Math.floor(val / stemMultiplier);
    const leaf = Math.round((val % stemMultiplier) * 10) / 10;
    if (!stems[stem]) stems[stem] = [];
    stems[stem].push(leaf);
  });

  let stemLeafHtml = '<h5>Stem-and-Leaf Plot:</h5><pre style="background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; font-family: monospace; font-size: 14px;">';
  stemLeafHtml += 'Stem | Leaf\n';
  stemLeafHtml += '-----|--------\n';
  
  Object.keys(stems).sort((a, b) => a - b).forEach(stem => {
    const leaves = stems[stem].sort((a, b) => a - b).map(l => l.toFixed(1).padStart(4, ' ')).join(' ');
    stemLeafHtml += `${stem.padStart(3)}  | ${leaves}\n`;
  });
  
  stemLeafHtml += '</pre>';
  stemLeafHtml += `<p><small>Key: Stem = puluhan/satuan utama, Leaf = satuan/desimal. Contoh: Stem 2 | Leaf 3.5 berarti 23.5.</small></p>`;
  
  const chartCanvas = document.getElementById('descriptiveChart');
  chartCanvas.innerHTML = stemLeafHtml;
  console.log('Stem-and-Leaf plot berhasil dirender.');
}

  /**
   * Updates the t-Test form based on the selected test type (one-sample, two-sample, paired).
   */
  function updateTTestForm() {
    const tTestType = document.getElementById('tTestType')?.value;
    const sample2Group = document.getElementById('sample2Group_tTest');
    const muGroup = document.getElementById('muGroup_tTest');
    
    if (tTestType === 'two-sample' || tTestType === 'paired') {
      if(sample2Group) sample2Group.style.display = 'block';
      if(muGroup) muGroup.style.display = 'none';
    } else { // one-sample
      if(sample2Group) sample2Group.style.display = 'none';
      if(muGroup) muGroup.style.display = 'block';
    }
  }

  /**
   * Runs the selected t-Test analysis.
   */
  function runTTest() {
    const tTestType = document.getElementById('tTestType')?.value;
    const alpha = parseFloat(document.getElementById('alpha')?.value);
    const sample1 = parseData('sample1_tTest');
    let sample2 = [];
    let mu0 = 0;

    if (!sample1 || sample1.length < 2) {
      alert('Data Sampel 1 tidak valid atau terlalu sedikit (minimal 2 observasi).');
      return;
    }

    let resultHtml = `<h4>Hasil Uji t (${tTestType})</h4>`;
    resultHtml += `<p>Tingkat Signifikansi (α): ${alpha}</p>`;

    let tStat, pValue, df;

    if (tTestType === 'one-sample') {
      mu0 = parseFloat(document.getElementById('mu0_tTest')?.value || '0');
      const mean1 = calculateMean(sample1);
      const stdDev1 = calculateStdDev(sample1, mean1);
      const n1 = sample1.length;
      
      tStat = (mean1 - mu0) / (stdDev1 / Math.sqrt(n1));
      df = n1 - 1;
      // Placeholder for p-value calculation (requires t-distribution function)
      pValue = Math.random().toFixed(3); // Simulate p-value
      
      resultHtml += `<p>Hipotesis Nol (H₀): μ = ${mu0}</p>`;
      resultHtml += `<p>Hipotesis Alternatif (H₁): μ ≠ ${mu0}</p>`;
      resultHtml += `<p>Data Sampel: [${sample1.join(', ')}]</p>`;
      resultHtml += `<p>Statistik Uji t: ${tStat.toFixed(3)}</p>`;
      resultHtml += `<p>Derajat Kebebasan (df): ${df}</p>`;
      resultHtml += `<p>p-value (Simulasi): ${pValue}</p>`;

      if (parseFloat(pValue) < alpha) {
        resultHtml += `<p style="color: green;">Kesimpulan: p-value (${pValue}) < α (${alpha}). Tolak H₀. Rata-rata sampel berbeda signifikan dari ${mu0}.</p>`;
      } else {
        resultHtml += `<p style="color: red;">Kesimpulan: p-value (${pValue}) ≥ α (${alpha}). Gagal menolak H₀. Tidak ada bukti signifikan bahwa rata-rata sampel berbeda dari ${mu0}.</p>`;
      }
      resultHtml += `<p style="color: #4caf50;">✓ Uji t one-sample berhasil dijalankan! (Simulasi Frontend)</p>`;

    } else if (tTestType === 'two-sample') {
      sample2 = parseData('sample2_tTest');
      if (!sample2 || sample2.length < 2) {
        alert('Data Sampel 2 tidak valid atau terlalu sedikit (minimal 2 observasi).');
        return;
      }
      const mean1 = calculateMean(sample1);
      const stdDev1 = calculateStdDev(sample1, mean1);
      const n1 = sample1.length;
      const mean2 = calculateMean(sample2);
      const stdDev2 = calculateStdDev(sample2, mean2);
      const n2 = sample2.length;

      // Assuming unequal variances (Welch's t-test for simplicity in simulation)
      const se1 = Math.pow(stdDev1, 2) / n1;
      const se2 = Math.pow(stdDev2, 2) / n2;
      tStat = (mean1 - mean2) / Math.sqrt(se1 + se2);
      df = Math.pow(se1 + se2, 2) / (Math.pow(se1, 2) / (n1 - 1) + Math.pow(se2, 2) / (n2 - 1));
      pValue = Math.random().toFixed(3); // Simulate p-value

      resultHtml += `<p>Hipotesis Nol (H₀): μ₁ = μ₂</p>`;
      resultHtml += `<p>Hipotesis Alternatif (H₁): μ₁ ≠ μ₂</p>`;
      resultHtml += `<p>Data Sampel 1: [${sample1.join(', ')}]</p>`;
      resultHtml += `<p>Data Sampel 2: [${sample2.join(', ')}]</p>`;
      resultHtml += `<p>Statistik Uji t: ${tStat.toFixed(3)}</p>`;
      resultHtml += `<p>Derajat Kebebasan (df): ${df.toFixed(2)}</p>`;
      resultHtml += `<p>p-value (Simulasi): ${pValue}</p>`;

      if (parseFloat(pValue) < alpha) {
        resultHtml += `<p style="color: green;">Kesimpulan: p-value (${pValue}) < α (${alpha}). Tolak H₀. Ada perbedaan signifikan antara rata-rata kedua sampel.</p>`;
      } else {
        resultHtml += `<p style="color: red;">Kesimpulan: p-value (${pValue}) ≥ α (${alpha}). Gagal menolak H₀. Tidak ada perbedaan signifikan antara rata-rata kedua sampel.</p>`;
      }
      resultHtml += `<p style="color: #4caf50;">✓ Uji t two-sample berhasil dijalankan! (Simulasi Frontend)</p>`;

    } else if (tTestType === 'paired') {
      sample2 = parseData('sample2_tTest');
      if (!sample2 || sample2.length !== sample1.length || sample1.length < 2) {
        alert('Data Sampel 2 tidak valid atau jumlah observasi tidak sama dengan Sampel 1 (minimal 2 pasangan).');
        return;
      }
      const differences = sample1.map((val, i) => val - sample2[i]);
      const meanDiff = calculateMean(differences);
      const stdDevDiff = calculateStdDev(differences, meanDiff);
      const nDiff = differences.length;

      tStat = meanDiff / (stdDevDiff / Math.sqrt(nDiff));
      df = nDiff - 1;
      pValue = Math.random().toFixed(3); // Simulate p-value

      resultHtml += `<p>Hipotesis Nol (H₀): μ_d = 0 (Tidak ada perbedaan rata-rata)</p>`;
      resultHtml += `<p>Hipotesis Alternatif (H₁): μ_d ≠ 0 (Ada perbedaan rata-rata)</p>`;
      resultHtml += `<p>Data Sampel 1: [${sample1.join(', ')}]</p>`;
      resultHtml += `<p>Data Sampel 2: [${sample2.join(', ')}]</p>`;
      resultHtml += `<p>Statistik Uji t: ${tStat.toFixed(3)}</p>`;
      resultHtml += `<p>Derajat Kebebasan (df): ${df}</p>`;
      resultHtml += `<p>p-value (Simulasi): ${pValue}</p>`;

      if (parseFloat(pValue) < alpha) {
        resultHtml += `<p style="color: green;">Kesimpulan: p-value (${pValue}) < α (${alpha}). Tolak H₀. Ada perbedaan signifikan antara pasangan data.</p>`;
      } else {
        resultHtml += `<p style="color: red;">Kesimpulan: p-value (${pValue}) ≥ α (${alpha}). Gagal menolak H₀. Tidak ada perbedaan signifikan antara pasangan data.</p>`;
      }
      resultHtml += `<p style="color: #4caf50;">✓ Uji t paired berhasil dijalankan! (Simulasi Frontend)</p>`;
    }

    // Add chart container for Box Plot
    resultHtml += `
      <h3>Visualisasi Data: Box Plot</h3>
      <div class="chart-container" id="tTestBoxPlotChart"></div>
      <p>Box plot menampilkan distribusi data (median, kuartil, outlier) untuk setiap kelompok, memudahkan perbandingan visual.</p>
    `;

    document.getElementById('tTestResults').innerHTML = resultHtml;

    // Generate Box Plot (simplified for Chart.js, which doesn't have native box plot)
    // We'll simulate a bar chart showing means for simplicity, or a scatter plot for individual points
    // For a true box plot, a more advanced library or custom Chart.js plugin would be needed.
    const labels = [];
    const means = [];
    const dataForChart = [];

    if (tTestType === 'one-sample') {
        labels.push('Sampel 1');
        means.push(calculateMean(sample1));
        dataForChart.push(sample1);
    } else if (tTestType === 'two-sample' || tTestType === 'paired') {
        labels.push('Sampel 1', 'Sampel 2');
        means.push(calculateMean(sample1), calculateMean(sample2));
        dataForChart.push(sample1, sample2);
    }

    // For demonstration, we'll create a bar chart of means.
    // A true box plot would require more complex data preparation for Chart.js or a different library.
    createChart(
      'tTestBoxPlotChart',
      'bar',
      {
        labels: labels,
        datasets: [{
          label: 'Rata-rata',
          data: means,
          backgroundColor: ['rgba(255, 99, 132, 0.6)', 'rgba(54, 162, 235, 0.6)'],
          borderColor: ['rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)'],
          borderWidth: 1
        }]
      },
      {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Perbandingan Rata-rata Sampel (Simulasi Box Plot)'
          }
        },
        scales: {
          x: {
            title: {
              display: true,
              text: 'Kelompok'
            }
          },
          y: {
            title: {
              display: true,
              text: 'Nilai Rata-rata'
            },
            beginAtZero: true
          }
        }
      }
    );
  }

  /**
   * Runs ANOVA analysis on the input data.
   */
  function runANOVA() {
    const anovaType = document.getElementById('anovaType')?.value;
    const alpha = parseFloat(document.getElementById('alpha_anova')?.value);
    const posthoc = document.getElementById('posthoc_anova')?.value;
    const groups = parseMultiGroupData('anovaData');

    if (!groups || groups.length < 2) {
      alert('Data kelompok tidak valid atau terlalu sedikit (minimal 2 kelompok).');
      return;
    }
    if (groups.some(g => g.values.length < 2)) {
      alert('Setiap kelompok harus memiliki minimal 2 observasi.');
      return;
    }

    let resultHtml = `<h4>Hasil Analisis ANOVA (${anovaType})</h4>`;
    resultHtml += `<p>Tingkat Signifikansi (α): ${alpha}</p>`;
    resultHtml += `<p>Hipotesis Nol (H₀): Semua rata-rata kelompok sama</p>`;
    resultHtml += `<p>Hipotesis Alternatif (H₁): Setidaknya ada satu rata-rata kelompok yang berbeda</p>`;
    resultHtml += `<p>Data Kelompok:</p><ul>`;
    groups.forEach(g => resultHtml += `<li>${g.name}: [${g.values.join(', ')}]</li>`);
    resultHtml += `</ul>`;

    // Simulate ANOVA results (requires more complex calculations for real F-stat and p-value)
    const fStat = (Math.random() * 5 + 1).toFixed(2); // F-statistic between 1 and 6
    const pValue = Math.random().toFixed(3);
    const df1 = groups.length - 1; // Degrees of freedom between groups
    const totalN = groups.reduce((sum, g) => sum + g.values.length, 0);
    const df2 = totalN - groups.length; // Degrees of freedom within groups

    resultHtml += `<p>Simulasi: F-statistik = ${fStat}, df1 = ${df1}, df2 = ${df2}, p-value = ${pValue}</p>`;

    if (parseFloat(pValue) < alpha) {
      resultHtml += `<p style="color: green;">Kesimpulan: p-value (${pValue}) < α (${alpha}). Tolak H₀. Ada perbedaan signifikan antar rata-rata kelompok.</p>`;
      if (posthoc !== 'none') {
        resultHtml += `<p>Melakukan Post-hoc Test (${posthoc})... (Simulasi)</p>`;
        // Simulate post-hoc results
        const groupNames = groups.map(g => g.name);
        if (groupNames.length > 1) {
            const rand1 = Math.floor(Math.random() * groupNames.length);
            let rand2 = Math.floor(Math.random() * groupNames.length);
            while (rand2 === rand1) rand2 = Math.floor(Math.random() * groupNames.length);
            resultHtml += `<p>Simulasi Hasil Post-hoc: Kelompok ${groupNames[rand1]} berbeda signifikan dengan Kelompok ${groupNames[rand2]}.</p>`;
        }
      }
    } else {
      resultHtml += `<p style="color: red;">Kesimpulan: p-value (${pValue}) ≥ α (${alpha}). Gagal menolak H₀. Tidak ada perbedaan signifikan antar rata-rata kelompok.</p>`;
    }
    resultHtml += `<p style="color: #4caf50; margin-top: 10px;">✓ Analisis ANOVA berhasil dijalankan! (Simulasi Frontend)</p>`;

    // Add chart container for Bar Chart of Means
    resultHtml += `
      <h3>Visualisasi Data: Bar Chart Rata-rata Kelompok</h3>
      <div class="chart-container" id="anovaBarChart"></div>
      <p>Bar chart ini memvisualisasikan rata-rata setiap kelompok, memudahkan perbandingan visual antar kelompok.</p>
    `;

    document.getElementById('anovaResults').innerHTML = resultHtml;

    // Generate Bar Chart of Means
    const labels = groups.map(g => g.name);
    const means = groups.map(g => calculateMean(g.values));
    const backgroundColors = labels.map((_, i) => `hsl(${i * 60}, 70%, 70%)`); // Different colors for each bar

    createChart(
      'anovaBarChart',
      'bar',
      {
        labels: labels,
        datasets: [{
          label: 'Rata-rata',
          data: means,
          backgroundColor: backgroundColors,
          borderColor: backgroundColors.map(color => color.replace('0.6', '1')),
          borderWidth: 1
        }]
      },
      {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Rata-rata Kelompok'
          }
        },
        scales: {
          x: {
            title: {
              display: true,
              text: 'Kelompok'
            }
          },
          y: {
            title: {
              display: true,
              text: 'Nilai Rata-rata'
            },
            beginAtZero: true
          }
        }
      }
    );
  }

  /**
   * Runs correlation analysis on the input data.
   */
  function runCorrelation() {
    const correlationType = document.getElementById('correlationType')?.value;
    const alpha = parseFloat(document.getElementById('corrAlpha')?.value);
    const varX = parseData('varX_korelasi');
    const varY = parseData('varY_korelasi');

    if (!varX || !varY || varX.length !== varY.length || varX.length < 2) {
      alert('Data variabel X dan Y tidak valid atau jumlah observasi tidak sama (minimal 2 observasi).');
      return;
    }

    let resultHtml = `<h4>Hasil Analisis Korelasi (${correlationType})</h4>`;
    resultHtml += `<p>Tingkat Signifikansi (α): ${alpha}</p>`;
    resultHtml += `<p>Data Variabel X: [${varX.join(', ')}]</p>`;
    resultHtml += `<p>Data Variabel Y: [${varY.join(', ')}]</p>`;

    let rValue;
    if (correlationType === 'pearson') {
        rValue = calculatePearsonCorrelation(varX, varY);
    } else { // Spearman (simplified simulation)
        // Real Spearman requires ranking data, then calculating Pearson on ranks.
        rValue = (Math.random() * 2 - 1); // Simulate a value between -1 and 1
    }
    
    // Simulate p-value for correlation
    const pValue = Math.random().toFixed(3);

    resultHtml += `<p>Koefisien Korelasi (${correlationType}): ${rValue.toFixed(3)}</p>`;
    resultHtml += `<p>p-value (Simulasi): ${pValue}</p>`;

    let interpretation = '';
    if (parseFloat(pValue) < alpha) {
      interpretation += `<p style="color: green;">Kesimpulan: p-value (${pValue}) < α (${alpha}). Ada hubungan signifikan antara Variabel X dan Variabel Y.</p>`;
      if (rValue > 0) {
        interpretation += `<p>Arah hubungan: Positif. Semakin tinggi X, semakin tinggi Y.</p>`;
      } else if (rValue < 0) {
        interpretation += `<p>Arah hubungan: Negatif. Semakin tinggi X, semakin rendah Y.</p>`;
      } else {
        interpretation += `<p>Arah hubungan: Tidak ada hubungan linear yang jelas.</p>`;
      }
      interpretation += `<p>Kekuatan hubungan: `;
      const absR = Math.abs(rValue);
      if (absR >= 0.8) interpretation += `Sangat Kuat.`;
      else if (absR >= 0.6) interpretation += `Kuat.`;
      else if (absR >= 0.4) interpretation += `Sedang.`;
      else if (absR >= 0.2) interpretation += `Lemah.`;
      else interpretation += `Sangat Lemah/Tidak ada.`;
      interpretation += `</p>`;
    } else {
      interpretation += `<p style="color: red;">Kesimpulan: p-value (${pValue}) ≥ α (${alpha}). Tidak ada hubungan signifikan antara Variabel X dan Variabel Y.</p>`;
    }
    resultHtml += interpretation;
    resultHtml += `<p style="color: #4caf50; margin-top: 10px;">✓ Analisis korelasi berhasil dijalankan! (Simulasi Frontend)</p>`;

    // Add chart container for Scatter Plot
    resultHtml += `
      <h3>Visualisasi Data: Scatter Plot</h3>
      <div class="chart-container" id="correlationScatterPlot"></div>
      <p>Scatter plot menunjukkan hubungan antara dua variabel. Pola titik-titik dapat mengindikasikan arah dan kekuatan korelasi.</p>
    `;

    document.getElementById('correlationResults').innerHTML = resultHtml;

    // Generate Scatter Plot
    const scatterData = varX.map((x, i) => ({ x: x, y: varY[i] }));

    createChart(
      'correlationScatterPlot',
      'scatter',
      {
        datasets: [{
          label: 'Data Poin',
          data: scatterData,
          backgroundColor: 'rgba(255, 99, 132, 0.8)',
          borderColor: 'rgba(255, 99, 132, 1)',
          pointRadius: 5
        }]
      },
      {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Scatter Plot Variabel X vs Y'
          }
        },
        scales: {
          x: {
            title: {
              display: true,
              text: 'Variabel X'
            }
          },
          y: {
            title: {
              display: true,
              text: 'Variabel Y'
            }
          }
        }
      }
    );
  }

  /**
   * Runs linear regression analysis on the input data.
   */
  function runRegression() {
    const regressionType = document.getElementById('regressionType')?.value;
    const confLevel = parseFloat(document.getElementById('confLevel')?.value);
    const alpha = 1 - (confLevel / 100);
    const includeResiduals = document.getElementById('includeResiduals')?.checked;
    const dependentVar = parseData('dependentVar_regresi');
    const independentVar = parseData('independentVar_regresi');

    if (!dependentVar || !independentVar || dependentVar.length !== independentVar.length || dependentVar.length < 2) {
      alert('Data variabel dependen dan independen tidak valid atau jumlah observasi tidak sama (minimal 2 observasi).');
      return;
    }

    let resultHtml = `<h4>Hasil Analisis Regresi Linear (${regressionType})</h4>`;
    resultHtml += `<p>Confidence Level: ${confLevel}% (α = ${alpha.toFixed(2)})</p>`;
    resultHtml += `<p>Data Variabel Dependen (Y): [${dependentVar.join(', ')}]</p>`;
    resultHtml += `<p>Data Variabel Independen (X): [${independentVar.join(', ')}]</p>`;

    // Simulate simple linear regression (real calculation requires more steps)
    const n = dependentVar.length;
    const sumX = independentVar.reduce((a, b) => a + b, 0);
    const sumY = dependentVar.reduce((a, b) => a + b, 0);
    const sumXY = independentVar.map((x, i) => x * dependentVar[i]).reduce((a, b) => a + b, 0);
    const sumX2 = independentVar.map(x => x * x).reduce((a, b) => a + b, 0);

    const denominator = n * sumX2 - sumX * sumX;
    let slope = 0;
    let intercept = 0;
    if (denominator !== 0) {
        slope = (n * sumXY - sumX * sumY) / denominator;
        intercept = (sumY - slope * sumX) / n;
    } else {
        alert('Tidak dapat menghitung regresi: Variabel independen memiliki variasi nol.');
        document.getElementById('regressionResults').innerHTML = `<p style="color: red;">Error: Variabel independen memiliki variasi nol.</p>`;
        return;
    }

    const predictedY = independentVar.map(x => intercept + slope * x);
    const residuals = dependentVar.map((y, i) => y - predictedY[i]);
    const ssTotal = dependentVar.map(y => Math.pow(y - calculateMean(dependentVar), 2)).reduce((a, b) => a + b, 0);
    const ssResidual = residuals.map(r => r * r).reduce((a, b) => a + b, 0);
    const rSquared = 1 - (ssResidual / ssTotal);

    // Simulate p-value for the model (requires F-test for overall model significance)
    const pValue = Math.random().toFixed(3);

    resultHtml += `
      <h3>Model Regresi:</h3>
      <p>Persamaan Regresi: Y = ${intercept.toFixed(3)} + ${slope.toFixed(3)} * X</p>
      <p>R-squared (Koefisien Determinasi): ${rSquared.toFixed(3)}</p>
      <p>p-value (Signifikansi Model, Simulasi): ${pValue}</p>
    `;

    if (parseFloat(pValue) < alpha) {
      resultHtml += `<p style="color: green;">Kesimpulan: Model regresi signifikan secara statistik pada tingkat kepercayaan ${confLevel}%. Variabel independen (X) memiliki pengaruh signifikan terhadap variabel dependen (Y).</p>`;
      resultHtml += `<p>Interpretasi: Setiap peningkatan 1 unit pada X akan meningkatkan Y sebesar ${slope.toFixed(3)} unit.</p>`;
    } else {
      resultHtml += `<p style="color: red;">Kesimpulan: Model regresi tidak signifikan secara statistik pada tingkat kepercayaan ${confLevel}%. Variabel independen (X) tidak memiliki pengaruh signifikan terhadap variabel dependen (Y).</p>`;
    }

    if (includeResiduals) {
      const meanResidual = calculateMean(residuals);
      const stdDevResidual = calculateStdDev(residuals, meanResidual);
      resultHtml += `
        <h3>Analisis Residual:</h3>
        <p>Residual Rata-rata: ${meanResidual.toFixed(3)}</p>
        <p>Standar Deviasi Residual: ${stdDevResidual.toFixed(3)}</p>
        <p>Visualisasi residual (plot) akan ditampilkan di backend untuk pemeriksaan asumsi.</p>
      `;
    }
    resultHtml += `<p style="color: #4caf50; margin-top: 10px;">✓ Analisis regresi berhasil dijalankan! (Simulasi Frontend)</p>`;

    // Add chart container for Regression Line Plot
    resultHtml += `
      <h3>Visualisasi Data: Scatter Plot dengan Garis Regresi</h3>
      <div class="chart-container" id="regressionLinePlot"></div>
      <p>Scatter plot ini menunjukkan hubungan antara variabel independen dan dependen, dilengkapi dengan garis regresi yang memodelkan hubungan tersebut.</p>
    `;

    document.getElementById('regressionResults').innerHTML = resultHtml;

    // Generate Regression Line Plot
    const scatterData = independentVar.map((x, i) => ({ x: x, y: dependentVar[i] }));
    const regressionLineData = independentVar.map(x => ({ x: x, y: intercept + slope * x }));

    createChart(
      'regressionLinePlot',
      'scatter',
      {
        datasets: [{
          label: 'Data Poin',
          data: scatterData,
          backgroundColor: 'rgba(75, 192, 192, 0.8)',
          borderColor: 'rgba(75, 192, 192, 1)',
          pointRadius: 5
        }, {
          label: 'Garis Regresi',
          data: regressionLineData,
          type: 'line',
          fill: false,
          borderColor: 'rgba(255, 99, 132, 1)',
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.1
        }]
      },
      {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Regresi Linear Sederhana'
          }
        },
        scales: {
          x: {
            title: {
              display: true,
              text: 'Variabel Independen (X)'
            }
          },
          y: {
            title: {
              display: true,
              text: 'Variabel Dependen (Y)'
            }
          }
        }
      }
    );
  }

  /**
   * Runs Mann-Whitney U test on the input data.
   */
  function runMannWhitney() {
    const group1 = parseData('group1_mannwhitney');
    const group2 = parseData('group2_mannwhitney');
    const alpha = parseFloat(document.getElementById('alpha_mannwhitney')?.value);

    if (!group1 || group1.length < 2 || !group2 || group2.length < 2) {
      alert('Data untuk kedua kelompok tidak valid atau terlalu sedikit (minimal 2 observasi per kelompok).');
      return;
    }

    let resultHtml = `<h4>Hasil Uji Mann-Whitney U</h4>`;
    resultHtml += `<p>Tingkat Signifikansi (α): ${alpha}</p>`;
    resultHtml += `<p>Data Kelompok 1: [${group1.join(', ')}]</p>`;
    resultHtml += `<p>Data Kelompok 2: [${group2.join(', ')}]</p>`;

    // Simulate Mann-Whitney U results (requires ranking and sum of ranks)
    const uStat = (Math.random() * 20 + 5).toFixed(2); // Simulate a U-statistik
    const pValue = Math.random().toFixed(3);

    resultHtml += `<p>Simulasi: U-statistik = ${uStat}, p-value = ${pValue}</p>`;

    if (parseFloat(pValue) < alpha) {
      resultHtml += `<p style="color: green;">Kesimpulan: p-value (${pValue}) < α (${alpha}). Tolak H₀. Ada perbedaan signifikan antara distribusi kedua kelompok.</p>`;
    } else {
      resultHtml += `<p style="color: red;">Kesimpulan: p-value (${pValue}) ≥ α (${alpha}). Gagal menolak H₀. Tidak ada perbedaan signifikan antara distribusi kedua kelompok.</p>`;
    }
    resultHtml += `<p style="color: #4caf50; margin-top: 10px;">✓ Uji Mann-Whitney U berhasil dijalankan! (Simulasi Frontend)</p>`;

    // Add chart container for Box Plot
    resultHtml += `
      <h3>Visualisasi Data: Box Plot Perbandingan Kelompok</h3>
      <div class="chart-container" id="mannWhitneyBoxPlot"></div>
      <p>Box plot ini memvisualisasikan distribusi data untuk kedua kelompok, membantu memahami perbedaan median dan penyebaran.</p>
    `;

    document.getElementById('mannWhitneyResults').innerHTML = resultHtml;

    // Generate Box Plot (simplified for Chart.js, showing means)
    createChart(
      'mannWhitneyBoxPlot',
      'bar',
      {
        labels: ['Kelompok 1', 'Kelompok 2'],
        datasets: [{
          label: 'Rata-rata',
          data: [calculateMean(group1), calculateMean(group2)],
          backgroundColor: ['rgba(153, 102, 255, 0.6)', 'rgba(255, 159, 64, 0.6)'],
          borderColor: ['rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)'],
          borderWidth: 1
        }]
      },
      {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Perbandingan Rata-rata Kelompok (Simulasi Box Plot)'
          }
        },
        scales: {
          x: {
            title: {
              display: true,
              text: 'Kelompok'
            }
          },
          y: {
            title: {
              display: true,
              text: 'Nilai Rata-rata'
            },
            beginAtZero: true
          }
        }
      }
    );
  }

  /**
   * Updates the Chi-Square form based on the selected test type (independence, goodness-of-fit).
   */
  function updateChiSquareForm() {
    const chiSquareType = document.getElementById('chiSquareType')?.value;
    const contingencyTableGroup = document.getElementById('contingencyTableGroup');
    const goodnessOfFitGroup = document.getElementById('goodnessOfFitGroup');

    if (contingencyTableGroup) contingencyTableGroup.style.display = (chiSquareType === 'independence' ? 'block' : 'none');
    if (goodnessOfFitGroup) goodnessOfFitGroup.style.display = (chiSquareType === 'goodness-of-fit' ? 'block' : 'none');
  }

  /**
   * Runs Chi-Square test on the input data.
   */
  function runChiSquare() {
    const chiSquareType = document.getElementById('chiSquareType')?.value;
    const alpha = parseFloat(document.getElementById('alpha_chiSquare')?.value);
    let resultHtml = `<h4>Hasil Uji Chi-Square (${chiSquareType})</h4>`;
    resultHtml += `<p>Tingkat Signifikansi (α): ${alpha}</p>`;

    let chi2Stat, pValue, df;
    let numRows, numCols; // Declare numRows and numCols here

    if (chiSquareType === 'independence') {
      const table = parseContingencyTable('contingencyTable');
      if (!table) {
        alert('Tabel kontingensi tidak valid. Pastikan semua baris memiliki jumlah kolom yang sama dan hanya berisi angka.');
        return;
      }
      
      numRows = table.length;
      numCols = table[0].length;
      if (numRows < 2 || numCols < 2) {
          alert('Tabel kontingensi harus memiliki minimal 2 baris dan 2 kolom untuk uji independensi.');
          return;
      }

      resultHtml += `<p>Tabel Kontingensi:</p>`;
      resultHtml += `<table border="1" style="width:auto; border-collapse: collapse; margin-top: 10px;">`;
      table.forEach(row => {
        resultHtml += `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`;
      });
      resultHtml += `</table>`;
      resultHtml += `<p>Hipotesis Nol (H₀): Variabel baris dan kolom independen.</p>`;
      resultHtml += `<p>Hipotesis Alternatif (H₁): Variabel baris dan kolom tidak independen.</p>`;

      // Simulate Chi-Square calculation
      df = (numRows - 1) * (numCols - 1);
      chi2Stat = (Math.random() * 10 + 1).toFixed(2);
      pValue = Math.random().toFixed(3);

    } else { // goodness-of-fit
      const observed = parseData('observedFrequencies');
      let expected = parseData('expectedFrequencies');
      if (!observed || observed.length < 2) {
        alert('Frekuensi observasi tidak valid atau terlalu sedikit (minimal 2 kategori).');
        return;
      }
      if (expected && expected.length !== observed.length) {
        alert('Jumlah frekuensi harapan harus sama dengan frekuensi observasi.');
        return;
      }
      if (!expected || expected.every(val => val === 0)) { // If expected is not provided or all zeros, assume equal distribution
        const totalObserved = observed.reduce((sum, val) => sum + val, 0);
        expected = Array(observed.length).fill(totalObserved / observed.length);
      }
      if (expected.some(val => val <= 0)) {
          alert('Frekuensi harapan harus lebih besar dari nol.');
          return;
      }

      resultHtml += `<p>Frekuensi Observasi: [${observed.join(', ')}]</p>`;
      resultHtml += `<p>Frekuensi Harapan: [${expected.map(e => e.toFixed(2)).join(', ')}]</p>`;
      resultHtml += `<p>Hipotesis Nol (H₀): Data sesuai dengan distribusi yang diharapkan.</p>`;
      resultHtml += `<p>Hipotesis Alternatif (H₁): Data tidak sesuai dengan distribusi yang diharapkan.</p>`;

      // Simulate Chi-Square calculation
      df = observed.length - 1;
      chi2Stat = (Math.random() * 10 + 1).toFixed(2);
      pValue = Math.random().toFixed(3);
    }

    resultHtml += `<p>Simulasi: Chi-Square Statistik = ${chi2Stat}, df = ${df}, p-value = ${pValue}</p>`;

    if (parseFloat(pValue) < alpha) {
      resultHtml += `<p style="color: green;">Kesimpulan: p-value (${pValue}) < α (${alpha}). Tolak H₀. Ada hubungan signifikan (uji independensi) atau data tidak sesuai distribusi harapan (goodness of fit).</p>`;
    } else {
      resultHtml += `<p style="color: red;">Kesimpulan: p-value (${pValue}) ≥ α (${alpha}). Gagal menolak H₀. Tidak ada hubungan signifikan atau data sesuai distribusi harapan.</p>`;
    }
    resultHtml += `<p style="color: #4caf50; margin-top: 10px;">✓ Uji Chi-Square berhasil dijalankan! (Simulasi Frontend)</p>`;

    // Add chart container for Bar Chart (for Goodness of Fit) or Stacked Bar Chart (for Independence)
    resultHtml += `
      <h3>Visualisasi Data: Bar Chart Frekuensi</h3>
      <div class="chart-container" id="chiSquareBarChart"></div>
      <p>Bar chart ini membandingkan frekuensi observasi dengan frekuensi harapan (untuk Goodness of Fit) atau menunjukkan distribusi kategori (untuk Independensi).</p>
    `;

    document.getElementById('chiSquareResults').innerHTML = resultHtml;

    // Generate Bar Chart
    if (chiSquareType === 'goodness-of-fit') {
        const observed = parseData('observedFrequencies');
        let expected = parseData('expectedFrequencies');
        if (!expected || expected.every(val => val === 0)) { // If expected is not provided or all zeros, assume equal distribution
            const totalObserved = observed.reduce((sum, val) => sum + val, 0);
            expected = Array(observed.length).fill(totalObserved / observed.length);
        }
        const labels = Array.from({length: observed.length}, (_, i) => `Kategori ${i + 1}`);
        createChart(
            'chiSquareBarChart',
            'bar',
            {
                labels: labels,
                datasets: [
                    {
                        label: 'Frekuensi Observasi',
                        data: observed,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Frekuensi Harapan',
                        data: expected,
                        backgroundColor: 'rgba(255, 159, 64, 0.6)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1
                    }
                ]
            },
            {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Perbandingan Frekuensi Observasi vs Harapan'
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Kategori'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Frekuensi'
                        },
                        beginAtZero: true
                    }
                }
            }
        );
    } else if (chiSquareType === 'independence') {
        const table = parseContingencyTable('contingencyTable');
        if (!table) return; // Should not happen due to earlier check
        numRows = table.length;
        numCols = table[0].length;
        // For independence, a stacked bar chart or grouped bar chart would be more appropriate.
        // For simplicity, we'll just show a grouped bar chart of row totals.
        const rowLabels = Array.from({length: numRows}, (_, i) => `Baris ${i + 1}`);
        const colLabels = Array.from({length: numCols}, (_, i) => `Kolom ${i + 1}`);
        const datasets = [];

        for (let j = 0; j < numCols; j++) {
            datasets.push({
                label: colLabels[j],
                data: table.map(row => row[j]),
                backgroundColor: `hsl(${j * (360 / numCols)}, 70%, 70%)`,
                borderColor: `hsl(${j * (360 / numCols)}, 70%, 50%)`,
                borderWidth: 1
            });
        }

        createChart(
            'chiSquareBarChart',
            'bar',
            {
                labels: rowLabels,
                datasets: datasets
            },
            {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Distribusi Frekuensi Antar Kategori'
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Baris'
                        },
                        stacked: false // Set to true for stacked bar chart
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Frekuensi'
                        },
                        beginAtZero: true,
                        stacked: false // Set to true for stacked bar chart
                    }
                }
            }
        );
    }
  }

  /**
   * Runs K-Means clustering on the input data.
   */
  function runClustering() {
    const dataString = document.getElementById('clusteringData')?.value.trim();
    const numClusters = parseInt(document.getElementById('numClusters')?.value || '0');

    if (!dataString) {
      alert('Data untuk clustering tidak boleh kosong!');
      return;
    }
    const data = dataString.split('\n').map(line => {
      return line.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n));
    }).filter(row => row.length > 0 && row.every(val => !isNaN(val)));

    if (data.length === 0) {
        alert('Tidak ada data yang valid untuk clustering.');
        return;
    }
    const numFeatures = data[0].length;
    if (data.some(row => row.length !== numFeatures)) {
        alert('Semua observasi harus memiliki jumlah fitur yang sama.');
        return;
    }
    if (numClusters < 1) {
        alert('Jumlah kluster (K) harus minimal 1.');
        return;
    }
    if (numClusters > data.length) {
        alert('Jumlah kluster (K) tidak boleh lebih besar dari jumlah observasi.');
        return;
    }

    let resultHtml = `<h4>Hasil K-Means Clustering</h4>`;
    resultHtml += `<p>Jumlah Kluster (K): ${numClusters}</p>`;
    resultHtml += `<p>Data Input:</p><ul>`;
    data.forEach(row => resultHtml += `<li>[${row.join(', ')}]</li>`);
    resultHtml += `</ul>`;

    // Simulate clustering results
    const assignments = data.map((_, i) => Math.floor(Math.random() * numClusters) + 1);
    const centroids = Array.from({ length: numClusters }, () => Array.from({ length: numFeatures }, () => (Math.random() * 10).toFixed(2)));

    resultHtml += `<h3>Hasil Kluster:</h3>`;
    resultHtml += `<p>Penugasan Kluster per Observasi: [${assignments.join(', ')}]</p>`;
    resultHtml += `<p>Centroid Kluster:</p><ul>`;
    centroids.forEach((c, i) => resultHtml += `<li>Kluster ${i + 1}: [${c.join(', ')}]</li>`);
    resultHtml += `</ul>`;
    resultHtml += `<p style="color: #4caf50; margin-top: 10px;">✓ Clustering berhasil dijalankan! (Simulasi Frontend)</p>`;

    // Add chart container for Scatter Plot with Clusters
    if (numFeatures >= 2) { // Only plot if at least 2 features
        resultHtml += `
            <h3>Visualisasi Data: Scatter Plot Kluster</h3>
            <div class="chart-container" id="clusteringScatterPlot"></div>
            <p>Scatter plot ini menampilkan data poin yang diwarnai berdasarkan penugasan kluster, serta centroid kluster.</p>
        `;
    } else {
        resultHtml += `<p>Visualisasi kluster (scatter plot) memerlukan minimal 2 fitur.</p>`;
    }

    document.getElementById('clusteringResults').innerHTML = resultHtml;

    // Generate Scatter Plot with Clusters
    if (numFeatures >= 2) {
        const datasets = [];
        const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40']; // Predefined colors

        for (let i = 0; i < numClusters; i++) {
            const clusterData = data.filter((_, idx) => assignments[idx] === i + 1)
                                    .map(point => ({ x: point[0], y: point[1] }));
            datasets.push({
                label: `Kluster ${i + 1}`,
                data: clusterData,
                backgroundColor: colors[i % colors.length],
                pointRadius: 5
            });
        }

        // Add centroids
        datasets.push({
            label: 'Centroid',
            data: centroids.map(c => ({ x: parseFloat(c[0]), y: parseFloat(c[1]) })),
            backgroundColor: '#000000',
            borderColor: '#000000',
            pointRadius: 8,
            pointStyle: 'crossRot',
            pointBorderWidth: 2
        });

        createChart(
            'clusteringScatterPlot',
            'scatter',
            {
                datasets: datasets
            },
            {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'K-Means Clustering Hasil'
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Fitur 1'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Fitur 2'
                        }
                    }
                }
            }
        );
    }
  }

  /**
   * Runs Factor Analysis on the input data.
   */
  function runFactorAnalysis() {
    const dataString = document.getElementById('factorAnalysisData')?.value.trim();
    const numFactors = parseInt(document.getElementById('numFactors')?.value || '0');

    if (!dataString) {
      alert('Data untuk analisis faktor tidak boleh kosong!');
      return;
    }
    const data = dataString.split('\n').map(line => {
      return line.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n));
    }).filter(row => row.length > 0 && row.every(val => !isNaN(val)));

    if (data.length === 0) {
        alert('Tidak ada data yang valid untuk analisis faktor.');
        return;
    }
    const numVariables = data[0].length;
    if (data.some(row => row.length !== numVariables)) {
        alert('Semua observasi harus memiliki jumlah variabel yang sama.');
        return;
    }
    if (data.length < 5 || numVariables < 2) {
      alert('Data tidak valid. Minimal 5 observasi dan 2 variabel diperlukan.');
      return;
    }
    if (numFactors < 1) {
        alert('Jumlah faktor yang diekstrak harus minimal 1.');
        return;
    }
    if (numFactors >= numVariables) {
        alert('Jumlah faktor yang diekstrak harus kurang dari jumlah variabel.');
        return;
    }

    let resultHtml = `<h4>Hasil Analisis Faktor</h4>`;
    resultHtml += `<p>Jumlah Faktor yang Diekstrak: ${numFactors}</p>`;
    resultHtml += `<p>Data Input:</p><ul>`;
    data.forEach(row => resultHtml += `<li>[${row.join(', ')}]</li>`);
    resultHtml += `</ul>`;

    // Simulate factor analysis results
    const eigenvalues = Array.from({ length: numVariables }, () => (Math.random() * 3 + 0.5)).sort((a, b) => b - a);
    const factorLoadings = Array.from({ length: numVariables }, (_, i) => 
      Array.from({ length: numFactors }, () => (Math.random() * 1.2 - 0.6).toFixed(3))
    );

    resultHtml += `<h3>Eigenvalues:</h3>`;
    resultHtml += `<p>[${eigenvalues.map(e => e.toFixed(2)).join(', ')}]</p>`;
    resultHtml += `<h3>Factor Loadings:</h3>`;
    resultHtml += `<table border="1" style="width:auto; border-collapse: collapse; margin-top: 10px;">`;
    resultHtml += `<tr><th>Variabel</th>${Array.from({ length: numFactors }, (_, i) => `<th>Faktor ${i + 1}</th>`).join('')}</tr>`;
    data[0].forEach((_, varIdx) => {
      resultHtml += `<tr><td>Var ${varIdx + 1}</td>${factorLoadings[varIdx].map(load => `<td>${load}</td>`).join('')}</tr>`;
    });
    resultHtml += `</table>`;
    resultHtml += `<p>Rotasi faktor (misal: Varimax) akan dilakukan di backend.</p>`;
    resultHtml += `<p style="color: #4caf50; margin-top: 10px;">✓ Analisis Faktor berhasil dijalankan! (Simulasi Frontend)</p>`;

    // Add chart container for Scree Plot
    resultHtml += `
      <h3>Visualisasi Data: Scree Plot</h3>
      <div class="chart-container" id="screePlotChart"></div>
      <p>Scree plot menunjukkan eigenvalue untuk setiap faktor. Ini membantu menentukan jumlah faktor optimal yang akan dipertahankan.</p>
    `;

    document.getElementById('factorAnalysisResults').innerHTML = resultHtml;

    // Generate Scree Plot
    const screeLabels = Array.from({length: numVariables}, (_, i) => `Faktor ${i + 1}`);
    createChart(
        'screePlotChart',
        'line',
        {
            labels: screeLabels,
            datasets: [{
                label: 'Eigenvalue',
                data: eigenvalues,
                fill: false,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1,
                pointBackgroundColor: 'rgb(75, 192, 192)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgb(75, 192, 192)'
            }]
        },
        {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Scree Plot'
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Nomor Faktor'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Eigenvalue'
                    },
                    beginAtZero: true
                }
            }
        }
    );
  }

  /**
   * Updates the Assumption Test form based on the selected test type.
   */
  function updateAssumptionTestForm() {
    const testType = document.getElementById('assumptionTestType')?.value;
    const normalitasDataGroup = document.getElementById('normalitasDataGroup');
    const homogenitasDataGroup = document.getElementById('homogenitasDataGroup');

    if (normalitasDataGroup) normalitasDataGroup.style.display = (testType === 'normalitas' ? 'block' : 'none');
    if (homogenitasDataGroup) homogenitasDataGroup.style.display = (testType === 'homogenitas' ? 'block' : 'none');
  }

  /**
   * Runs the selected Assumption Test.
   */
  function runAssumptionTest() {
    const testType = document.getElementById('assumptionTestType')?.value;
    const alpha = parseFloat(document.getElementById('alpha_assumption')?.value);
    let resultHtml = `<h4>Hasil Uji Asumsi Klasik (${testType})</h4>`;
    resultHtml += `<p>Tingkat Signifikansi (α): ${alpha}</p>`;

    const pValue = Math.random().toFixed(3);

    if (testType === 'normalitas') {
      const data = parseData('normalitasData');
      if (!data || data.length < 5) {
        alert('Data untuk uji normalitas tidak valid atau terlalu sedikit (minimal 5 observasi).');
        return;
      }
      resultHtml += `<p>Data Input: [${data.join(', ')}]</p>`;
      resultHtml += `<p>Hipotesis Nol (H₀): Data berdistribusi normal.</p>`;
      resultHtml += `<p>Hipotesis Alternatif (H₁): Data tidak berdistribusi normal.</p>`;
      resultHtml += `<p>Simulasi: Shapiro-Wilk Statistik = ${(Math.random() * 0.2 + 0.8).toFixed(3)}, p-value = ${pValue}</p>`;
      if (parseFloat(pValue) < alpha) {
        resultHtml += `<p style="color: red;">Kesimpulan: p-value (${pValue}) < α (${alpha}). Tolak H₀. Data tidak berdistribusi normal.</p>`;
      } else {
        resultHtml += `<p style="color: green;">Kesimpulan: p-value (${pValue}) ≥ α (${alpha}). Gagal menolak H₀. Data berdistribusi normal.</p>`;
      }

      // Add chart container for Q-Q Plot
      resultHtml += `
        <h3>Visualisasi Data: Q-Q Plot (Simulasi)</h3>
        <div class="chart-container" id="qqPlotChart"></div>
        <p>Q-Q plot membandingkan kuantil data dengan kuantil distribusi normal. Jika data berdistribusi normal, titik-titik akan mendekati garis lurus diagonal.</p>
      `;

      document.getElementById('assumptionTestResults').innerHTML = resultHtml;

      // Generate Q-Q Plot (simulated)
      const sortedData = [...data].sort((a, b) => a - b);
      const theoreticalQuantiles = Array.from({length: sortedData.length}, (_, i) => {
          // Simplified normal quantile approximation
          const p = (i + 0.5) / sortedData.length;
          return Math.sqrt(-2 * Math.log(1 - p)) * (p > 0.5 ? 1 : -1); // Very rough inverse CDF
      });

      const qqData = sortedData.map((val, i) => ({ x: theoreticalQuantiles[i], y: val }));
      const minVal = Math.min(...theoreticalQuantiles, ...sortedData);
      const maxVal = Math.max(...theoreticalQuantiles, ...sortedData);
      const lineData = [{x: minVal, y: minVal}, {x: maxVal, y: maxVal}];

      createChart(
          'qqPlotChart',
          'scatter',
          {
              datasets: [{
                  label: 'Data Kuartil',
                  data: qqData,
                  backgroundColor: 'rgba(54, 162, 235, 0.8)',
                  pointRadius: 5
              }, {
                  label: 'Garis Referensi Normal',
                  data: lineData,
                  type: 'line',
                  fill: false,
                  borderColor: 'rgba(255, 99, 132, 1)',
                  borderWidth: 2,
                  pointRadius: 0
              }]
          },
          {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  title: {
                      display: true,
                      text: 'Q-Q Plot Normalitas'
                  }
              },
              scales: {
                  x: {
                      title: {
                          display: true,
                          text: 'Kuantil Normal Teoritis'
                      }
                  },
                  y: {
                      title: {
                          display: true,
                          text: 'Kuantil Data'
                      }
                  }
              }
          }
      );

    } else if (testType === 'homogenitas') {
      const groups = parseMultiGroupData('homogenitasData');
      if (!groups || groups.length < 2 || groups.some(g => g.values.length < 2)) {
        alert('Data untuk uji homogenitas tidak valid atau terlalu sedikit (minimal 2 kelompok, masing-masing 2 observasi).');
        return;
      }
      resultHtml += `<p>Data Kelompok:</p><ul>`;
      groups.forEach(g => resultHtml += `<li>${g.name}: [${g.values.join(', ')}]</li>`);
      resultHtml += `</ul>`;
      resultHtml += `<p>Hipotesis Nol (H₀): Varians antar kelompok homogen.</p>`;
      resultHtml += `<p>Hipotesis Alternatif (H₁): Varians antar kelompok tidak homogen.</p>`;
      resultHtml += `<p>Simulasi: Levene's Statistik = ${(Math.random() * 5 + 0.5).toFixed(2)}, p-value = ${pValue}</p>`;
      if (parseFloat(pValue) < alpha) {
        resultHtml += `<p style="color: red;">Kesimpulan: p-value (${pValue}) < α (${alpha}). Tolak H₀. Varians antar kelompok tidak homogen.</p>`;
      } else {
        resultHtml += `<p style="color: green;">Kesimpulan: p-value (${pValue}) ≥ α (${alpha}). Gagal menolak H₀. Varians antar kelompok homogen.</p>`;
      }

      // Add chart container for Box Plot
      resultHtml += `
        <h3>Visualisasi Data: Box Plot Varians Kelompok</h3>
        <div class="chart-container" id="homogeneityBoxPlot"></div>
		<p>Box plot ini memvisualisasikan distribusi data dan penyebaran (varians) untuk setiap kelompok, membantu menilai homogenitas varians secara visual.</p>
    `;

      document.getElementById('assumptionTestResults').innerHTML = resultHtml;

      // Generate Box Plot (simplified for Chart.js, showing means)
      const labels = groups.map(g => g.name);
      const means = groups.map(g => calculateMean(g.values));
      const backgroundColors = labels.map((_, i) => `hsl(${i * 60}, 70%, 70%)`);

      createChart(
          'homogeneityBoxPlot',
          'bar',
          {
              labels: labels,
              datasets: [{
                  label: 'Rata-rata',
                  data: means,
                  backgroundColor: backgroundColors,
                  borderColor: backgroundColors.map(color => color.replace('0.6', '1')),
                  borderWidth: 1
              }]
          },
          {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  title: {
                      display: true,
                      text: 'Perbandingan Rata-rata Kelompok (Simulasi Box Plot)'
                  }
              },
              scales: {
                  x: {
                      title: {
                          display: true,
                          text: 'Kelompok'
                      }
                  },
                  y: {
                      title: {
                          display: true,
                          text: 'Nilai Rata-rata'
                      },
                      beginAtZero: true
                  }
              }
          }
      );
    }
    resultHtml += `<p style="color: #4caf50; margin-top: 10px;">✓ Uji asumsi berhasil dijalankan! (Simulasi Frontend)</p>`;
  }

  /**
   * Updates the Power Analysis form based on the selected test type.
   */
  function updatePowerAnalysisForm() {
    const testType = document.getElementById('powerTestType')?.value;
    const effectSizeLabel = document.getElementById('effectSizeLabel');
    const effectSizeHint = document.getElementById('effectSizeHint');

    if (testType === 't-test') {
      effectSizeLabel.textContent = 'Ukuran Efek (Cohen\'s d):';
      effectSizeHint.textContent = '0.2 (kecil), 0.5 (sedang), 0.8 (besar)';
    } else if (testType === 'anova') {
      effectSizeLabel.textContent = 'Ukuran Efek (η²):';
      effectSizeHint.textContent = '0.01 (kecil), 0.06 (sedang), 0.14 (besar)';
    } else if (testType === 'correlation') {
      effectSizeLabel.textContent = 'Ukuran Efek (r):';
      effectSizeHint.textContent = '0.1 (kecil), 0.3 (sedang), 0.5 (besar)';
    } else if (testType === 'regression') {
      effectSizeLabel.textContent = 'Ukuran Efek (f²):';
      effectSizeHint.textContent = '0.02 (kecil), 0.15 (sedang), 0.35 (besar)';
    }
  }

  /**
   * Runs Power Analysis to calculate sample size or power.
   */
  function runPowerAnalysis() {
    const testType = document.getElementById('powerTestType')?.value;
    const effectSize = parseFloat(document.getElementById('effectSize')?.value || '0');
    const alpha = parseFloat(document.getElementById('alpha_power')?.value);
    const desiredPower = parseFloat(document.getElementById('desiredPower')?.value || '0.8');

    if (effectSize <= 0 || desiredPower <= 0 || desiredPower >= 1) {
      alert('Ukuran efek dan power harus valid (efek > 0, power antara 0.5-0.99).');
      return;
    }

    let resultHtml = `<h4>Hasil Power Analysis (${testType})</h4>`;
    resultHtml += `<p>Ukuran Efek: ${effectSize.toFixed(2)}</p>`;
    resultHtml += `<p>Tingkat Signifikansi (α): ${alpha}</p>`;
    resultHtml += `<p>Power yang Diinginkan (1-β): ${desiredPower.toFixed(2)}</p>`;

    // Simulate sample size calculation (real calculation requires G*Power or similar)
    let requiredSampleSize = Math.floor(Math.random() * 100 + 20); // Simulate sample size between 20-120
    let calculatedPower = (Math.random() * 0.5 + 0.5).toFixed(2); // Simulate power between 0.5-1.0

    if (desiredPower > 0.5) {
      resultHtml += `<p>Ukuran Sampel yang Diperlukan: ${requiredSampleSize} observasi (total).</p>`;
      resultHtml += `<p>Power yang Dihitung: ${calculatedPower}</p>`;
      if (parseFloat(calculatedPower) >= desiredPower) {
        resultHtml += `<p style="color: green;">Kesimpulan: Dengan ukuran sampel ${requiredSampleSize}, power uji mencapai ${calculatedPower} ≥ ${desiredPower}. Uji memiliki kekuatan yang memadai untuk mendeteksi efek sebesar ${effectSize}.</p>`;
      } else {
        resultHtml += `<p style="color: red;">Kesimpulan: Dengan ukuran sampel ${requiredSampleSize}, power uji hanya ${calculatedPower} < ${desiredPower}. Tingkatkan ukuran sampel untuk mencapai power yang diinginkan.</p>`;
      }
    } else {
      resultHtml += `<p>Power yang Dihitung: ${calculatedPower}</p>`;
      resultHtml += `<p style="color: green;">Kesimpulan: Uji memiliki power ${calculatedPower} untuk mendeteksi efek sebesar ${effectSize} dengan ukuran sampel yang ada.</p>`;
    }
    resultHtml += `<p style="color: #4caf50; margin-top: 10px;">✓ Power Analysis berhasil dijalankan! (Simulasi Frontend)</p>`;

    // Add chart container for Power Curve
    resultHtml += `
      <h3>Visualisasi Data: Power Curve</h3>
      <div class="chart-container" id="powerCurveChart"></div>
      <p>Power curve menunjukkan hubungan antara ukuran sampel dan power uji untuk efek sebesar yang ditentukan.</p>
    `;

    document.getElementById('powerAnalysisResults').innerHTML = resultHtml;

    // Generate Power Curve (simulated)
    const sampleSizes = Array.from({length: 10}, (_, i) => 20 + i * 10); // Sample sizes from 20 to 110
    const powers = sampleSizes.map(size => {
      // Simulate power increasing with sample size
      return Math.min(0.99, 0.1 + (size / 100) * 0.8).toFixed(2);
    });

    createChart(
        'powerCurveChart',
        'line',
        {
            labels: sampleSizes,
            datasets: [{
                label: 'Power (1-β)',
                data: powers,
                fill: false,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1,
                pointBackgroundColor: 'rgb(75, 192, 192)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgb(75, 192, 192)'
            }]
        },
        {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Power Curve vs Ukuran Sampel'
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Ukuran Sampel (n)'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Power (1-β)'
                    },
                    beginAtZero: true,
                    max: 1
                }
            }
        }
    );
  }

 // Fungsi Sample Size (dari panduan sebelumnya, sekarang di dalam scope ini)
  function calculateSampleSizeAll() {
    const N = parseFloat(document.getElementById('populasi').value) || 0;
    const ePercent = parseFloat(document.getElementById('margin-error').value) || 5;
    const confidence = parseFloat(document.getElementById('confidence').value) || 95;
    const p = parseFloat(document.getElementById('proporsi').value) || 0.5;
    
    const e = ePercent / 100;
    const zScores = { 90: 1.645, 95: 1.96, 99: 2.576 };
    const Z = zScores[confidence] || 1.96;
    const q = 1 - p;
    
    if (N <= 0 || e <= 0 || e >= 1 || p < 0 || p > 1) {
      alert('Periksa input: N > 0, e 0-100%, p 0-1!');
      return;
    }
    
    const nSlovin = N / (1 + N * Math.pow(e, 2));
    let nCochran = (Math.pow(Z, 2) * p * q) / Math.pow(e, 2);
    if (N > 0) nCochran = nCochran / (1 + (nCochran - 1) / N);
        const nLemeshow = (Math.pow(Z, 2) * p * q * N) / (Math.pow(e, 2) * (N - 1) + Math.pow(Z, 2) * p * q);
    
    // Bulatkan ke atas
    const results = [
      { rumus: 'Slovin', n: Math.ceil(nSlovin), desc: `n = N / (1 + N × e²) = ${N} / (1 + ${N} × ${e.toFixed(3)}²) ≈ ${nSlovin.toFixed(2)}` },
      { rumus: 'Cochran', n: Math.ceil(nCochran), desc: `n = (Z² × p × q) / e² adjusted = (${Z.toFixed(2)}² × ${p} × ${q}) / ${e.toFixed(3)}² ≈ ${nCochran.toFixed(2)} (untuk N=${N})` },
      { rumus: 'Lemeshow', n: Math.ceil(nLemeshow), desc: `n = (Z² × p × q × N) / (e² × (N-1) + Z² × p × q) ≈ ${nLemeshow.toFixed(2)}` }
    ];
    
    // Tampilkan di tabel
    const tbody = document.querySelector('#sample-table tbody');
    if (tbody) {
      tbody.innerHTML = '';
      results.forEach(result => {
        const row = tbody.insertRow();
        row.innerHTML = `
          <td style="border: 1px solid #ddd; padding: 8px;">${result.rumus}</td>
          <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold; color: #007bff;">${result.n}</td>
          <td style="border: 1px solid #ddd; padding: 8px; font-size: 12px;">${result.desc}</td>
        `;
      });
    }
    
    console.log('Sample size calculated:', results);
  }
  
// Fungsi Random Number Generator (Tambah di dalam blok showAnalysisTool)
// Safety: Jika sudah ada, skip (dalam scope yang sama)
if (typeof generateRandomSample === 'undefined') {
  
  function generateRandomSample(regenerate = false) {
  const N = parseInt(document.getElementById('populasi-rng').value) || 1000;
  const n = parseInt(document.getElementById('sampel-rng').value) || 100;
  const withReplacement = document.getElementById('with-replacement').checked;
  const sorted = document.getElementById('sort-results').checked;
  
  // Validasi (tetap sama)
  if (N < 1 || n < 1) {
    alert('Populasi (N) dan Sampel (n) harus ≥ 1!');
    return;
  }
  if (n > N && !withReplacement) {
    alert('Ukuran sampel (n) tidak boleh > populasi (N) tanpa pengulangan!');
    return;
  }
  if (n > 10000) {
    if (!confirm('Sampel besar (>10000) mungkin lambat. Lanjutkan?')) return;
  }
  
  let randomNumbers = [];
  
  if (withReplacement) {
    // Dengan pengulangan: Random independen
    for (let i = 0; i < n; i++) {
      randomNumbers.push(Math.floor(Math.random() * N) + 1);  // 1 sampai N
    }
  } else {
    // Tanpa pengulangan: Fisher-Yates Shuffle
    let pool = Array.from({length: N}, (_, i) => i + 1);  // Array 1 sampai N
    for (let i = pool.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [pool[i], pool[j]] = [pool[j], pool[i]];  // Swap
    }
    randomNumbers = pool.slice(0, n);  // Ambil n pertama
  }
  
  // Urutkan jika dipilih
  if (sorted) {
    randomNumbers.sort((a, b) => a - b);
  }
  
  // Tampilkan daftar (PERBAIKAN: Tampilkan full untuk n ≤ 200, ringkas untuk lebih besar)
  const listDiv = document.getElementById('random-numbers-list');
  const statsDiv = document.getElementById('rng-stats');
  if (listDiv && statsDiv) {
    let listHTML = '';
    
    if (randomNumbers.length <= 200) {
      // Tampilkan SEMUA nomor: Comma-separated dengan <br> setiap 20 untuk readability
      const chunks = [];
      for (let i = 0; i < randomNumbers.length; i += 20) {
        chunks.push(randomNumbers.slice(i, i + 20).join(', '));
      }
      listHTML = '<p>' + chunks.join('</p><p>') + '</p>';
      listHTML += `<p style="font-style: italic; color: #666;">(Semua ${n} nomor ditampilkan. Copy untuk gunakan.)</p>`;
    } else {
      // Ringkas untuk n > 200: 50 pertama + tombol tampilkan semua
      const first50 = randomNumbers.slice(0, 50).join(', ');
      listHTML = `
        <p>Nomor acak (pertama 50 dari ${n}): ${first50}...</p>
        <button class="btn-secondary" onclick="showAllRandomNumbers()" style="margin-top: 5px;">Tampilkan Semua Nomor</button>
        <p>Total: ${n} nomor unik.</p>
      `;
    }
    
    listDiv.innerHTML = listHTML;
    
    // Stats (tetap sama)
    const uniqueCount = new Set(randomNumbers).size;
    statsDiv.innerHTML = `Sampel dihasilkan: ${n} nomor${withReplacement ? ' (dengan pengulangan, unik: ' + uniqueCount + ')' : ' unik'} dari populasi ${N}.`;
    
    // Scroll ke output
    listDiv.scrollTop = 0;
  }
  
  console.log('Random sample generated:', randomNumbers.slice(0, 10) + '... (total ' + n + ')');  // Log sample
  
  // Fungsi tambahan: Tampilkan semua nomor jika ringkas (untuk n > 200)
let lastRandomNumbers = [];  // Simpan array terakhir untuk akses

function showAllRandomNumbers() {
  if (lastRandomNumbers.length > 0) {
    const sorted = document.getElementById('sort-results').checked;
    let displayNumbers = [...lastRandomNumbers];  // Copy array
    if (sorted) displayNumbers.sort((a, b) => a - b);
    
    // Tampilkan full seperti di atas
    const listDiv = document.getElementById('random-numbers-list');
    if (listDiv) {
      const chunks = [];
      for (let i = 0; i < displayNumbers.length; i += 20) {
        chunks.push(displayNumbers.slice(i, i + 20).join(', '));
      }
      listDiv.innerHTML = '<p>' + chunks.join('</p><p>') + '</p><p style="font-style: italic; color: #666;">(Semua nomor ditampilkan. Copy untuk gunakan.)</p>';
    }
  }
}

// Update generateRandomSample untuk simpan array terakhir
// (Tambahkan di akhir fungsi generateRandomSample, sebelum console.log)
lastRandomNumbers = [...randomNumbers];
}
}

  /**
   * Runs Instrument Test (Validity & Reliability) on the input data.
   */
  function runInstrumentTest() {
    const dataString = document.getElementById('instrumentData')?.value.trim();
    const alpha = parseFloat(document.getElementById('alpha_validity')?.value);

    if (!dataString) {
      alert('Data respon kuesioner tidak boleh kosong!');
      return;
    }
    const data = dataString.split('\n').map(line => {
      return line.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n));
    }).filter(row => row.length > 0 && row.every(val => !isNaN(val)));

    if (data.length < 5) {
        alert('Data responden tidak valid (minimal 5 responden).');
        return;
    }
    const numItems = data[0].length;
    if (data.some(row => row.length !== numItems)) {
        alert('Semua responden harus memiliki jumlah item yang sama.');
        return;
    }
    if (numItems < 2) {
        alert('Instrumen harus memiliki minimal 2 item.');
        return;
    }

    let resultHtml = `<h4>Hasil Uji Validitas & Reliabilitas</h4>`;
    resultHtml += `<p>Tingkat Signifikansi (α): ${alpha}</p>`;
    resultHtml += `<p>Data Respon Kuesioner:</p><ul>`;
    data.forEach(row => resultHtml += `<li>[${row.join(', ')}]</li>`);
    resultHtml += `</ul>`;

    // Simulate validity and reliability results
    const validityResults = Array.from({ length: numItems }, () => {
      const rValue = (Math.random() * 0.8 + 0.2).toFixed(3); // Simulate correlation with total score
      const pValue = Math.random().toFixed(3);
      const isValid = parseFloat(pValue) < alpha && parseFloat(rValue) > 0.3;
      return { r: rValue, p: pValue, valid: isValid };
    });

    const reliabilityCronbachAlpha = (Math.random() * 0.9 + 0.1).toFixed(3); // Simulate Cronbach's alpha
    const isReliable = parseFloat(reliabilityCronbachAlpha) > 0.7;

    resultHtml += `<h3>Uji Validitas (Korelasi Item-Total):</h3>`;
    resultHtml += `<table border="1" style="width:auto; border-collapse: collapse; margin-top: 10px;">`;
    resultHtml += `<tr><th>Item</th><th>r (Korelasi)</th><th>p-value</th><th>Valid?</th></tr>`;
    validityResults.forEach((res, i) => {
      resultHtml += `<tr><td>Item ${i + 1}</td><td>${res.r}</td><td>${res.p}</td><td>${res.valid ? 'Ya' : 'Tidak'}</td></tr>`;
    });
    resultHtml += `</table>`;

    resultHtml += `<h3>Uji Reliabilitas (Cronbach's Alpha):</h3>`;
    resultHtml += `<p>Cronbach's Alpha: ${reliabilityCronbachAlpha}</p>`;
    if (isReliable) {
      resultHtml += `<p style="color: green;">Kesimpulan Reliabilitas: Instrumen reliabel (α > 0.7).</p>`;
    } else {
      resultHtml += `<p style="color: red;">Kesimpulan Reliabilitas: Instrumen kurang reliabel (α ≤ 0.7). Perbaiki item.</p>`;
    }

    const validItemsCount = validityResults.filter(res => res.valid).length;
    if (validItemsCount === numItems) {
      resultHtml += `<p style="color: green;">Kesimpulan Validitas: Semua item valid. Instrumen siap digunakan.</p>`;
    } else {
      resultHtml += `<p style="color: red;">Kesimpulan Validitas: ${validItemsCount}/${numItems} item valid. Revisi item yang tidak valid.</p>`;
    }
    resultHtml += `<p style="color: #4caf50; margin-top: 10px;">✓ Uji instrumen berhasil dijalankan! (Simulasi Frontend)</p>`;

    // Add chart container for Item-Total Correlation Plot
    resultHtml += `
      <h3>Visualisasi Data: Plot Korelasi Item-Total</h3>
      <div class="chart-container" id="itemTotalPlot"></div>
      <p>Plot ini menunjukkan korelasi setiap item dengan total skor, membantu mengidentifikasi item yang bermasalah.</p>
    `;

    document.getElementById('instrumentTestResults').innerHTML = resultHtml;

    // Generate Item-Total Correlation Plot
    const itemLabels = Array.from({length: numItems}, (_, i) => `Item ${i + 1}`);
    const rValues = validityResults.map(res => parseFloat(res.r));

    createChart(
        'itemTotalPlot',
        'bar',
        {
            labels: itemLabels,
            datasets: [{
                label: 'Korelasi Item-Total (r)',
                data: rValues,
                backgroundColor: rValues.map(r => r > 0.3 ? 'rgba(75, 192, 192, 0.6)' : 'rgba(255, 99, 132, 0.6)'),
                borderColor: rValues.map(r => r > 0.3 ? 'rgba(75, 192, 192, 1)' : 'rgba(255, 99, 132, 1)'),
                borderWidth: 1
            }]
        },
        {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Korelasi Item-Total'
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Item'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Korelasi (r)'
                    },
                    beginAtZero: true,
                    max: 1
                }
            }
        }
    );
  }

  // --- Sidebar and Layout Functionality ---

  /**
   * Toggles the mobile sidebar visibility.
   */
  function toggleSidebar() {
  const sidebar = document.getElementById('materials-sidebar');
  const isOpen = sidebar.classList.contains('open');
  if (isOpen) {
    // Close sidebar
    sidebar.classList.remove('open');
    if (window.innerWidth <= 768) {
      sidebar.style.display = 'none';
      sidebar.style.left = '-100%'; // Explicit reset untuk mobile
    } else {
      sidebar.style.display = 'block'; // Desktop: Selalu visible
      sidebar.style.left = '0';
    }
  } else {
    // Open sidebar
    sidebar.classList.add('open');
    sidebar.style.display = 'block';
    sidebar.style.left = '0';
  }
}

  /**
   * Handles sidebar resizing on desktop (drag to resize).
   */
  function initResizer() {
    const resizer = document.getElementById('resizer');
    let isResizing = false;

    resizer.addEventListener('mousedown', function(e) {
      isResizing = true;
      document.addEventListener('mousemove', resize);
      document.addEventListener('mouseup', stopResize);
    });

    function resize(e) {
      if (!isResizing) return;
      const newWidth = e.clientX;
      if (newWidth > 150 && newWidth < 400) {
        document.body.style.setProperty('--sidebar-width', newWidth + 'px');
      }
    }

    function stopResize() {
      isResizing = false;
      document.removeEventListener('mousemove', resize);
      document.removeEventListener('mouseup', stopResize);
    }
  }

  /**
   * Handles profile image upload and displays the image.
   * @param {Event} event - The file input change event.
   */
  function handleProfileImageUpload(event) {
    const fileInput = event.target;
    const file = fileInput.files[0];
    if (!file) {
      console.log('No file selected for upload.');
      return;
    }

    // Validate file type
    if (!file.type.startsWith('image/')) {
      alert('File harus berupa gambar (JPG, PNG, GIF, dll.).');
      fileInput.value = ''; // Clear the input
      return;
    }

    // Validate file size (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
      alert('Ukuran file terlalu besar. Maksimal 5MB.');
      fileInput.value = '';
      return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
      const authorPhotoContainer = document.getElementById('author-photo-container');
      if (!authorPhotoContainer) {
        console.error('Error: Container #author-photo-container not found.');
        alert('Error: Elemen container foto profil tidak ditemukan. Refresh halaman dan coba lagi.');
        return;
      }

      const placeholder = document.getElementById('author-photo-placeholder');
      const existingImg = authorPhotoContainer.querySelector('img');

      try {
        if (existingImg) {
          // If image already exists, update src
          existingImg.src = e.target.result;
          console.log('Updated existing profile image.');
        } else {
          // Create new img element
          const newImg = document.createElement('img');
          newImg.src = e.target.result;
          newImg.alt = 'Foto Profil';
          newImg.style.width = '100%';
          newImg.style.height = '100%';
          newImg.style.objectFit = 'cover';
          authorPhotoContainer.appendChild(newImg);
          console.log('Created new profile image element.');
        }

        // Hide placeholder if it exists (with null check)
        if (placeholder) {
          placeholder.style.display = 'none';
          console.log('Hid placeholder.');
        } else {
          console.warn('Placeholder #author-photo-placeholder not found, but upload continues.');
        }

        // Save to localStorage (base64 string)
        localStorage.setItem('webstat_profileImage', e.target.result);
        alert('Foto profil berhasil diunggah!');
        console.log('Profile image uploaded and saved successfully.');

      } catch (error) {
        console.error('Error during image processing:', error);
        alert('Error saat memproses gambar: ' + error.message + '. Refresh halaman dan coba lagi.');
      }
    };

    reader.onerror = function() {
      console.error('Error reading file.');
      alert('Error membaca file. Pastikan file tidak rusak.');
      fileInput.value = '';
    };

    reader.readAsDataURL(file);
  }

  /**
   * Loads the profile image from localStorage on page load.
   */
  function loadProfileImage() {
    const savedImage = localStorage.getItem('webstat_profileImage');
    if (!savedImage) {
      console.log('No saved profile image found.');
      return;
    }

    const authorPhotoContainer = document.getElementById('author-photo-container');
    if (!authorPhotoContainer) {
      console.error('Error: Container #author-photo-container not found during load.');
      return;
    }

    const placeholder = document.getElementById('author-photo-placeholder');
    const existingImg = authorPhotoContainer.querySelector('img');

    try {
      if (existingImg) {
        existingImg.src = savedImage;
        console.log('Loaded existing profile image from storage.');
      } else {
        const newImg = document.createElement('img');
        newImg.src = savedImage;
        newImg.alt = 'Foto Profil';
        newImg.style.width = '100%';
        newImg.style.height = '100%';
        newImg.style.objectFit = 'cover';
        authorPhotoContainer.appendChild(newImg);
        console.log('Created and loaded new profile image from storage.');
      }

      // Hide placeholder if it exists (with null check)
      if (placeholder) {
        placeholder.style.display = 'none';
        console.log('Hid placeholder on load.');
      } else {
        console.warn('Placeholder #author-photo-placeholder not found during load, but image loaded.');
      }

    } catch (error) {
      console.error('Error loading profile image:', error);
      // Fallback: Hapus data rusak dari localStorage
      localStorage.removeItem('webstat_profileImage');
    }
  }

  // --- Initialization and Event Listeners ---

   /**
    * Inisialisasi dukungan tombol Enter untuk login admin.
    * Fungsi ini menambahkan event listener pada input password.
    */
   function initAdminLoginEnter() {
     const passwordInput = document.getElementById('admin-password');
     if (!passwordInput) {
       console.warn('Input #admin-password tidak ditemukan. Dukungan Enter dilewati.');
       return;
     }

     passwordInput.addEventListener('keydown', function(event) {
       if (event.key === 'Enter' || event.keyCode === 13) {
         event.preventDefault(); // Cegah aksi default seperti newline
         loginAdmin(); // Panggil fungsi login admin yang sudah ada
       }
     });

     console.log('Dukungan tombol Enter untuk login admin diinisialisasi.');
   }
     
  /**
   * Initializes the application when DOM is loaded.
   */
  document.addEventListener('DOMContentLoaded', function() {
    // Load profile image AFTER DOM is ready
    loadProfileImage();
	initAdminLoginEnter();
	// Load profile image from localStorage if available
	const savedProfileImage = localStorage.getItem('webstat_profileImage');
    if (savedProfileImage) {
      const authorPhoto = document.getElementById('author-photo-container');
      const placeholder = document.getElementById('author-photo-placeholder');
      authorPhoto.innerHTML = `<img src="${savedProfileImage}" alt="Profile Photo">`;
      placeholder.style.display = 'none';
    }

    loadMaterialsFromStorage();
    // Load initial content (rebuild sidebar and page from localStorage)
    loadInitialContent();

    // Initialize resizer for desktop
    if (window.innerWidth >= 769) {
      initResizer();
    }

    // Add click outside to close mobile sidebar
    document.addEventListener('click', function(e) {
      const sidebar = document.getElementById('materials-sidebar');
      const toggleBtn = document.querySelector('.sidebar-toggle-btn');
      if (window.innerWidth <= 768 && sidebar.classList.contains('open') && 
          !sidebar.contains(e.target) && !toggleBtn.contains(e.target)) {
        toggleSidebar();
      }
    });

  // Handle window resize for responsive layout (perbaikan: lebih robust)
  window.addEventListener('resize', function() {
    const sidebar = document.getElementById('materials-sidebar');
    const isMobile = window.innerWidth <= 768;
    if (isMobile) {
      // Mobile: Hide if not open
      if (!sidebar.classList.contains('open')) {
        sidebar.style.display = 'none';
        sidebar.style.left = '-100%';
      } else {
        sidebar.style.display = 'block';
        sidebar.style.left = '0';
      }
      // Hide toggle button? No, show it on mobile
      const toggleBtn = document.querySelector('.sidebar-toggle-btn');
      if (toggleBtn) toggleBtn.style.display = 'flex';
    } else {
      // Desktop: Always show sidebar, no fixed positioning
      sidebar.style.display = 'block';
      sidebar.style.left = '0';
      sidebar.style.position = 'relative';
      sidebar.style.width = 'auto';
      sidebar.classList.remove('open'); // Remove open class on desktop
      const toggleBtn = document.querySelector('.sidebar-toggle-btn');
      if (toggleBtn) toggleBtn.style.display = 'none';
    }
  });

    // Close admin login section when clicking outside
    document.getElementById('admin-login-section').addEventListener('click', function(e) {
      if (e.target === this) {
        closeAdminLoginSection();
      }
    });

    // Initialize tool-specific forms on load (if Analysis is shown)
    const currentActiveMaterial = document.querySelector('.material-item.active');
    if (currentActiveMaterial && currentActiveMaterial.dataset.materialId === '8') {
      showMaterial(8); // Ensure Analysis is properly initialized
    }

    // Set initial welcome content after all loading
    initialWelcomeContent = document.getElementById('pageContent').innerHTML;

    // Enable admin editing if already in admin mode (from localStorage)
    const isAdminStored = localStorage.getItem('webstat_isAdminMode');
    if (isAdminStored === 'true') {
      isAdminMode = true;
      document.body.classList.add('admin-active');
      document.getElementById('admin-logout-form').style.display = 'block';
      document.getElementById('admin-login-form').style.display = 'none';
      document.getElementById('admin-mode-toggle-btn').textContent = 'Logout';
      document.getElementById('admin-mode-toggle-btn').classList.add('active');
      enableAdminEditing();
    }

    console.log('SARC Platform initialized successfully!');
  });

  // Additional utility functions for form updates (if not already defined)

  /**
   * Updates the Chi-Square form based on the selected test type.
   */
  function updateChiSquareForm() {
    const chiSquareType = document.getElementById('chiSquareType')?.value;
    const contingencyTableGroup = document.getElementById('contingencyTableGroup');
    const goodnessOfFitGroup = document.getElementById('goodnessOfFitGroup');

    if (contingencyTableGroup) contingencyTableGroup.style.display = (chiSquareType === 'independence' ? 'block' : 'none');
    if (goodnessOfFitGroup) goodnessOfFitGroup.style.display = (chiSquareType === 'goodness-of-fit' ? 'block' : 'none');
  }

  /**
   * Updates the Assumption Test form based on the selected test type.
   */
  function updateAssumptionTestForm() {
    const testType = document.getElementById('assumptionTestType')?.value;
    const normalitasDataGroup = document.getElementById('normalitasDataGroup');
    const homogenitasDataGroup = document.getElementById('homogenitasDataGroup');

    if (normalitasDataGroup) normalitasDataGroup.style.display = (testType === 'normalitas' ? 'block' : 'none');
    if (homogenitasDataGroup) homogenitasDataGroup.style.display = (testType === 'homogenitas' ? 'block' : 'none');
  }

  /**
   * Updates the Power Analysis form based on the selected test type.
   */
  function updatePowerAnalysisForm() {
    const testType = document.getElementById('powerTestType')?.value;
    const effectSizeLabel = document.getElementById('effectSizeLabel');
    const effectSizeHint = document.getElementById('effectSizeHint');

    if (!effectSizeLabel || !effectSizeHint) return; // Exit if elements don't exist

    switch (testType) {
      case 't-test':
        effectSizeLabel.textContent = 'Ukuran Efek (Cohen\'s d):';
        effectSizeHint.textContent = '0.2 (kecil), 0.5 (sedang), 0.8 (besar)';
        break;
      case 'anova':
        effectSizeLabel.textContent = 'Ukuran Efek (η²):';
        effectSizeHint.textContent = '0.01 (kecil), 0.06 (sedang), 0.14 (besar)';
        break;
      case 'correlation':
        effectSizeLabel.textContent = 'Ukuran Efek (r):';
        effectSizeHint.textContent = '0.1 (kecil), 0.3 (sedang), 0.5 (besar)';
        break;
      case 'regression':
        effectSizeLabel.textContent = 'Ukuran Efek (f²):';
        effectSizeHint.textContent = '0.02 (kecil), 0.15 (sedang), 0.35 (besar)';
        break;
      default:
        effectSizeLabel.textContent = 'Ukuran Efek:';
        effectSizeHint.textContent = 'Masukkan ukuran efek yang sesuai.';
    }
  }

  // Save admin mode to localStorage on login/logout
  function saveAdminModeToStorage() {
    localStorage.setItem('webstat_isAdminMode', isAdminMode.toString());
  }

  // Override loginAdmin and logoutAdmin to save state
  const originalLoginAdmin = loginAdmin;
  loginAdmin = function() {
    originalLoginAdmin();
    if (isAdminMode) saveAdminModeToStorage();
  };

  const originalLogoutAdmin = logoutAdmin;
  logoutAdmin = function() {
    originalLogoutAdmin();
    saveAdminModeToStorage();
  };

  // Ensure admin mode is saved on toggle
  const originalToggleAdminMode = toggleAdminMode;
  toggleAdminMode = function() {
    originalToggleAdminMode();
    if (isAdminMode) saveAdminModeToStorage();
  };

  // Handle profile image upload in admin mode only
  document.addEventListener('DOMContentLoaded', function() {
    const uploadBtn = document.querySelector('.profile-upload-btn');
    if (uploadBtn) {
      uploadBtn.addEventListener('click', function() {
        if (!isAdminMode) {
          alert('Fitur upload foto hanya tersedia di mode admin.');
          return false;
        }
      });
    }
  });

  // Prevent non-admin access to admin controls
  document.addEventListener('DOMContentLoaded', function() {
    const adminControls = document.querySelectorAll('.admin-controls button, .material-item .edit-btn, .material-item .delete-btn');
    adminControls.forEach(btn => {
      btn.addEventListener('click', function(e) {
        if (!isAdminMode) {
          e.preventDefault();
          e.stopPropagation();
          alert('Mode admin diperlukan untuk mengakses fitur ini. Login terlebih dahulu.');
          toggleAdminMode(); // Show login form
          return false;
        }
      });
    });
  });

  // Auto-save page content changes in admin mode (debounced)
  let saveTimeout;
  document.addEventListener('blur', function(e) {
    if (isAdminMode && e.target.classList.contains('editable-content') && saveTimeout === undefined) {
      saveTimeout = setTimeout(() => {
        // Trigger save on blur (already handled in handleEditBlur)
        saveTimeout = undefined;
      }, 1000); // Debounce 1 second
    }
  }, true); // Use capture phase to catch all blurs

  // Export functionality placeholder (for future backend integration)
  function exportResults(toolId, format = 'pdf') {
    const resultsDiv = document.getElementById(`${toolId}Results`);
    if (!resultsDiv) {
      alert('Tidak ada hasil untuk diekspor.');
      return;
    }
    // Simulate export (real export would use jsPDF or similar)
    const content = resultsDiv.innerHTML;
    alert(`Ekspor hasil ${toolId} ke ${format.toUpperCase()} berhasil! (Simulasi - Konten: ${content.substring(0, 100)}...)`);
    // In production: Use jsPDF for PDF, or XLSX library for Excel
  }

  // Add export buttons to results (dynamically)
  function addExportButton(toolId, resultsContainer) {
    const exportBtn = document.createElement('button');
    exportBtn.textContent = 'Ekspor Hasil (PDF)';
    exportBtn.classList.add('btn-primary');
    exportBtn.style.marginLeft = '10px';
    exportBtn.onclick = () => exportResults(toolId, 'pdf');
    resultsContainer.appendChild(exportBtn);

    const excelBtn = document.createElement('button');
    excelBtn.textContent = 'Ekspor (Excel)';
    excelBtn.classList.add('btn-primary');
    excelBtn.style.marginLeft = '5px';
    excelBtn.onclick = () => exportResults(toolId, 'excel');
    resultsContainer.appendChild(excelBtn);
  }

  // Modify run functions to add export buttons (example for descriptive)
  const originalRunDescriptive = runDescriptive;
  runDescriptive = function() {
    originalRunDescriptive();
    const resultsDiv = document.getElementById('descriptiveResults');
    if (resultsDiv) {
      setTimeout(() => addExportButton('deskriptif', resultsDiv), 100); // Delay to ensure content is rendered
    }
  };

  // Similarly for other run functions (add this pattern to each if needed)
  // For brevity, I'll add it only to key functions; extend as necessary.

  // Error handling for all analysis functions
  window.addEventListener('error', function(e) {
    console.error('Error in SARC Platform:', e.error);
    alert('Terjadi kesalahan: ' + e.message + '. Silakan refresh halaman dan coba lagi.');
  });

  // Performance optimization: Lazy load charts only when visible
  const observerOptions = {
    root: null,
    rootMargin: '0px',
    threshold: 0.1
  };

  const chartObserver = new IntersectionObserver(function(entries) {
    entries.forEach(entry => {
      if (entry.isIntersecting && entry.target.classList.contains('chart-container')) {
        // Trigger chart rendering if data is available (custom event or data attribute)
        const chartId = entry.target.id;
        // In production, dispatch custom event to re-render chart if needed
      }
    });
  }, observerOptions);

  // Observe all chart containers
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.chart-container').forEach(container => {
      chartObserver.observe(container);
    });
  });

  // Final cleanup and optimization
  // Remove unused console logs in production
  if (window.location.hostname !== 'localhost') {
    console.log = function() {}; // Disable console.log in production
  }

</script>
</body>
</html>